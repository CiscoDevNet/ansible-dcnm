##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_image_upload.log

- name: Delete all images from controller
  cisco.dcnm.dcnm_image_upload:
    state: deleted                                # choose from [merged, deleted, overridden, query]; default is merged
  register: result

- name: ASSERT - Initial delete all images
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
  loop: '{{ result.response }}'


- block:

##############################################
##                MERGE                     ##
##############################################

    - name: Upload images to controller
      cisco.dcnm.dcnm_image_upload: &img_upload
        state: merged                             # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - path: "{{ IMAGE_1_PATH }}"            # Full path to the image on the server
            source: scp
            remote_server: "{{ SERVER_IP }}"
            username: "{{ USERNAME }}"
            password: "{{ PASSWORD }}"
          - path: "{{ IMAGE_3_PATH }}"            # Full path to image on local host
            source: local
          - path: "{{ IMAGE_2_PATH }}"            # Full path to the image on the server
            source: sftp
            remote_server: "{{ SERVER_IP }}"
            username: "{{ USERNAME }}"
            password: "{{ PASSWORD }}"
      register: result

    - name: ASSERT - Upload result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 3'
          - '(result["diff"][0]["deleted"] | length) == 0'

    - name: ASSERT - Upload responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Successfully uploaded selected image file(s)." in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##            IDEMPOTENCE                   ##
##############################################

    - name: Image upload - Idempotence
      cisco.dcnm.dcnm_image_upload: *img_upload
      register: result

    - name: ASSERT - Idempotence result
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'

##############################################
##               DELETE                     ##
##############################################

    - name: Delete an image
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: "{{ IMAGE_3_NAME }}"
      register: result

    - name: ASSERT - Delete result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'

    - name: ASSERT - Delete responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Image(s) Deleted Successfully" in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##                MERGE                     ##
##############################################

    - name: Upload images to controller - without mentioning state
      cisco.dcnm.dcnm_image_upload:
        files:
          - path: "{{ IMAGE_3_PATH }}"
            source: local
      register: result

    - name: ASSERT - Upload (implicit state) structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["deleted"] | length) == 0'

    - name: ASSERT - Upload (implicit state) responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Successfully uploaded selected image file(s)." in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##                CLEANUP                   ##
##############################################

  always:

    - name: Delete all images from controller
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
      register: result
      when: it_context is not defined

    - name: ASSERT - Cleanup delete all images
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'
      when: it_context is not defined
