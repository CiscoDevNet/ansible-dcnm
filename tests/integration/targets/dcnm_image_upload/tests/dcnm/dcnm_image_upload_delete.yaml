##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_image_upload.log

- name: Delete all images from controller
  cisco.dcnm.dcnm_image_upload:
    state: deleted                                # choose from [merged, deleted, overridden, query]; default is merged
  register: result

- name: ASSERT - Initial delete all images
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
  loop: '{{ result.response }}'

- block:

##############################################
##                MERGE                     ##
##############################################

    - name: Upload images to controller
      cisco.dcnm.dcnm_image_upload:
        state: merged                             # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - path: "{{ IMAGE_3_PATH }}"
            source: local
      register: result

    - name: ASSERT - Upload result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["deleted"] | length) == 0'

    - name: ASSERT - Upload responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Successfully uploaded selected image file(s)." in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##               DELETE                     ##
##############################################

    - name: Delete an image
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: "{{ IMAGE_3_NAME }}"
      register: result

    - name: ASSERT - Delete result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'

    - name: ASSERT - Delete responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Image(s) Deleted Successfully" in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##            IDEMPOTENCE                   ##
##############################################

    - name: Delete Image - Idempotence
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
      register: result

    - name: ASSERT - Idempotence result
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'

##############################################
##                MERGE                     ##
##############################################

    - name: Upload images to controller (re-upload)
      cisco.dcnm.dcnm_image_upload:
        files:
          - path: "{{ IMAGE_3_PATH }}"
            source: local
      register: result

    - name: ASSERT - Re-upload result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["deleted"] | length) == 0'

    - name: ASSERT - Re-upload responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Successfully uploaded selected image file(s)." in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##               DELETE                     ##
##############################################

    - name: Delete an image - without explicitly including any config
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
      register: result

    - name: ASSERT - Delete (no config) structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'

    - name: ASSERT - Delete (no config) responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Image(s) Deleted Successfully" in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##               DELETE                     ##
##############################################

    - name: Delete an image that does not exist
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: no-such-image.bin
      register: result

    - name: ASSERT - Delete non-existing image
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 0'

##############################################
##                MERGE                     ##
##############################################

    - name: Upload images to controller (multiple)
      cisco.dcnm.dcnm_image_upload:
        files:
          - path: "{{ IMAGE_3_PATH }}"
            source: local
          - path: "{{ IMAGE_2_PATH }}"
            source: sftp
            remote_server: "{{ SERVER_IP }}"
            username: "{{ USERNAME }}"
            password: "{{ PASSWORD }}"
      register: result

    - name: ASSERT - Upload multiple result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 2'
          - '(result["diff"][0]["deleted"] | length) == 0'

    - name: ASSERT - Upload multiple responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Successfully uploaded selected image file(s)." in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##               DELETE                     ##
##############################################

    - name: Delete one image from existing list
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: "{{ IMAGE_3_NAME }}"
      register: result

    - name: ASSERT - Delete one image structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'

    - name: ASSERT - Delete one image responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Image(s) Deleted Successfully" in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##                QUERY                     ##
##############################################

    - name: Query and check if one image is still present
      cisco.dcnm.dcnm_image_upload:
        state: query                              # choose from [merged, deleted, overridden, query]; default is merged
      register: result

    - name: ASSERT - Query one image present
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 1'

##############################################
##               DELETE                     ##
##############################################

    - name: Delete one existing image and one non-existing image
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: "{{ IMAGE_2_NAME }}"
          - name: no-such-image.bin
      register: result

    - name: ASSERT - Delete existing + non-existing structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'

    - name: ASSERT - Delete existing + non-existing responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Image(s) Deleted Successfully" in item["DATA"]'
      loop: '{{ result.response }}'

##############################################
##                CLEANUP                   ##
##############################################

  always:

    - name: Delete all images from controller
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
      register: result
      when: it_context is not defined

    - name: ASSERT - Cleanup delete all images
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'
      when: it_context is not defined
