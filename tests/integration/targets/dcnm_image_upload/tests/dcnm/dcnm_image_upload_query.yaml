##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_image_upload.log

- name: Delete all images from controller
  cisco.dcnm.dcnm_image_upload:
    state: deleted                                # choose from [merged, deleted, overridden, query]; default is merged
  register: result

- name: ASSERT - Delete all images
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
  loop: '{{ result.response }}'


- block:

##############################################
##                MERGE                     ##
##############################################

    - name: Upload images to controller
      cisco.dcnm.dcnm_image_upload:
        state: merged
        files:
          - path: "{{ IMAGE_2_PATH }}"            # Full path to the image on the server
            source: sftp                           # choose from [local, scp, sftp]; default is local
            remote_server: "{{ SERVER_IP }}"      # mandatory when the source is scp or sftp
            username: "{{ USERNAME }}"            # mandatory when source is scp or sftp
            password: "{{ PASSWORD }}"            # mandatory when source is scp or sftp
          - path: "{{ IMAGE_3_PATH }}"            # Full path to the image on local server
            source: local                          # choose from [local, scp, sftp]; default is local
          - path: "{{ IMAGE_1_PATH }}"            # Full path to the image on the server
            source: scp                            # choose from [local, scp, sftp]; default is local
            remote_server: "{{ SERVER_IP }}"      # mandatory when the source is scp or sftp
            username: "{{ USERNAME }}"            # mandatory when source is scp or sftp
            password: "{{ PASSWORD }}"            # mandatory when source is scp or sftp
      register: result

    - name: ASSERT - Upload result structure
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 3'
          - '(result["diff"][0]["deleted"] | length) == 0'

    - name: ASSERT - Upload responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Successfully uploaded selected image file(s)." in item["DATA"]'
      loop: '{{ result.response }}'


##############################################
##              QUERY                       ##
##############################################

    - name: Query for existing image
      cisco.dcnm.dcnm_image_upload:
        state: query                              # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: "{{ IMAGE_3_NAME }}"            # Name of the image to be used to filter the output
      register: result

    - name: ASSERT - Query existing image
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 1'

##############################################
##              QUERY                       ##
##############################################

    - name: Query without any filters
      cisco.dcnm.dcnm_image_upload:
        state: query                              # choose from [merged, deleted, overridden, query]; default is merged
      register: result

    - name: ASSERT - Query all images
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 3'

##############################################
##              QUERY                       ##
##############################################

    - name: Query with specific names
      cisco.dcnm.dcnm_image_upload:
        state: query                              # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: "{{ IMAGE_2_NAME }}"            # Name of the image to be used to filter the output
          - name: "{{ IMAGE_3_NAME }}"            # Name of the image to be used to filter the output
          - name: "{{ IMAGE_1_NAME }}"            # Name of the image to be used to filter the output
      register: result

    - name: ASSERT - Query specific names
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 3'

##############################################
##              QUERY                       ##
##############################################

    - name: Query with non existing image name
      cisco.dcnm.dcnm_image_upload:
        state: query                              # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: no-such-image.bin               # Name of a non-existing image
      register: result

    - name: ASSERT - Query non-existing image
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 0'

##############################################
##              QUERY                       ##
##############################################

    - name: Query with existing and non existing image name
      cisco.dcnm.dcnm_image_upload:
        state: query                              # choose from [merged, deleted, overridden, query]; default is merged
        files:
          - name: no-such-image.bin               # Name of a non-existing image
          - name: "{{ IMAGE_1_NAME }}"            # Name of the image to be used to filter the output
      register: result

    - name: ASSERT - Query mixed existing/non-existing
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result.response | length) == 1'

##############################################
##                CLEANUP                   ##
##############################################

  always:

    - name: Delete all images from controller
      cisco.dcnm.dcnm_image_upload:
        state: deleted                            # choose from [merged, deleted, overridden, query]; default is merged
      register: result
      when: it_context is not defined

    - name: ASSERT - Cleanup delete all images
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'
      when: it_context is not defined
