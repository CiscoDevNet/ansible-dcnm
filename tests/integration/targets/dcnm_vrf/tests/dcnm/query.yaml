##############################################
## dcnm_vrf query.yaml (Refactored)         ##
## Focus: querying deployed/non-existent VRFs ##
##############################################

- name: FACT rest_path (11.x)
  ansible.builtin.set_fact:
    rest_path: "/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version == '11'

- name: FACT rest_path (12.x+)
  ansible.builtin.set_fact:
    rest_path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version >= '12'

- name: DEBUG vars
  ansible.builtin.debug:
    msg: "fabric={{ fabric_1 }} s1={{ switch_1 }} s2={{ switch_2 }} iface2a={{ interface_2a }}"

- name: QUERY fabric deployed
  cisco.dcnm.dcnm_rest:
    method: GET
    path: "{{ rest_path }}"
  register: fabric_query

- name: ASSERT fabric deployed
  ansible.builtin.assert:
    that:
      - 'fabric_query.response.DATA != None'

- name: PURGE initial VRFs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_1 }}"
    state: deleted
  register: purge_initial

- name: WAIT after purge
  ansible.builtin.wait_for:
    timeout: 60
  when: purge_initial.changed

- block:
    ##############################################
    ## CREATE & DEPLOY ansible-vrf-int1          ##
    ##############################################
    - name: MERGE create ansible-vrf-int1
      cisco.dcnm.dcnm_vrf: &int1_deploy
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            deploy: true
      register: int1_result
    - name: ASSERT int1 merge
      ansible.builtin.assert:
        that:
          - 'int1_result.changed'
    - name: WAIT int1 DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: int1_wait
      until:
        - "int1_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: QUERY ansible-vrf-int1 explicit config
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
      register: int1_query
    - name: ASSERT query int1
      ansible.builtin.assert:
        that:
          - int1_query.changed == false
          - int1_query.response[0].parent.vrfName == 'ansible-vrf-int1'
          - int1_query.response[0].parent.vrfStatus == 'DEPLOYED'

  ##############################################
  ## DELETE ansible-vrf-int1                   ##
  ##############################################
    - name: DELETE ansible-vrf-int1
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
      register: delete_int1
    - name: ASSERT delete int1
      ansible.builtin.assert:
        that:
          - 'delete_int1.changed == true'
    - name: WAIT sync after delete
      ansible.builtin.wait_for:
        timeout: 60

  ##############################################
  ## CREATE & DEPLOY ansible-vrf-int2          ##
  ##############################################
    - name: MERGE create ansible-vrf-int2
      cisco.dcnm.dcnm_vrf: &int2_deploy
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008012
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 1500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            deploy: true
      register: int2_result
    - name: ASSERT int2 merge
      ansible.builtin.assert:
        that:
          - 'int2_result.changed'
    - name: WAIT int2 DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: int2_wait
      until:
        - "int2_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2

  ##############################################
  ## ADD VRF LITE EXTENSION to int2           ##
  ##############################################
    - name: MERGE add VRF LITE extension int2
      cisco.dcnm.dcnm_vrf: &int2_lite
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008012
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 1500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int2
                interface: "{{ interface_2a }}"
                dot1q: 2
            deploy: true
      register: int2_lite_result
    - name: ASSERT int2 lite merge
      ansible.builtin.assert:
        that:
          - 'int2_lite_result.changed'
    - name: QUERY int2 lite (explicit config)
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008012
      register: int2_lite_query
    - name: ASSERT int2 lite query
      ansible.builtin.assert:
        that:
          - int2_lite_query.changed == false
          - int2_lite_query.response[0].parent.vrfName == 'ansible-vrf-int2'
          - int2_lite_query.response[0].parent.vrfStatus == 'DEPLOYED'

  ##############################################
  ## GLOBAL QUERY (no config)                 ##
  ##############################################
    - name: QUERY all VRFs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: global_query
    - name: ASSERT global query
      ansible.builtin.assert:
        that:
          - 'global_query.changed == false'

  ##############################################
  ## QUERY non-existent VRF                   ##
  ##############################################
    - name: QUERY absent ansible-vrf-int1
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
      register: absent_query
    - name: ASSERT absent query empty
      ansible.builtin.assert:
        that:
          - 'absent_query.changed == false'
          - 'absent_query.response|length == 0'

  ##############################################
  ## L3VNI WO VLAN scenario (PENDING)         ##
  ##############################################
    - name: MERGE int2 L3VNI w/o VLAN (deploy:false)
      cisco.dcnm.dcnm_vrf: &int2_l3vni
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008012
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            l3vni_wo_vlan: true
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            deploy: false
      register: int2_l3vni_result
    - name: ASSERT l3vni merge
      ansible.builtin.assert:
        that:
          - 'int2_l3vni_result.changed'
    - name: QUERY int2 l3vni
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008012
      register: int2_l3vni_query
    - name: ASSERT l3vni query PENDING
      ansible.builtin.assert:
        that:
          - int2_l3vni_query.changed == false
          - int2_l3vni_query.response[0].parent.vrfStatus == 'PENDING'

  always:
    - name: ALWAYS cleanup VRFs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
      register: final_cleanup
    - name: ASSERT cleanup
      ansible.builtin.assert:
        that:
          - 'final_cleanup.changed in [true,false]'
