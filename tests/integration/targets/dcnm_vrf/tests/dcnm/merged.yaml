##############################################
## dcnm_vrf merged.yaml (Refactored)        ##
## Focus: merge scenarios, idempotence, errs ##
##############################################

- name: FACT build rest_path (11.x)
  ansible.builtin.set_fact:
    rest_path: "/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version == '11'

- name: FACT build rest_path (12.x+)
  ansible.builtin.set_fact:
    rest_path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version >= '12'

- name: DEBUG vars
  ansible.builtin.debug:
    msg: "fabric={{ fabric_1 }} s1={{ switch_1 }} s2={{ switch_2 }} s3={{ switch_3 }} iface2a={{ interface_2a }} iface3a={{ interface_3a }}"

- name: QUERY fabric deployed
  cisco.dcnm.dcnm_rest:
    method: GET
    path: "{{ rest_path }}"
  register: fabric_query

- name: ASSERT fabric deployed
  ansible.builtin.assert:
    that: ['fabric_query.response.DATA != None']

- name: PURGE existing VRFs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_1 }}"
    state: deleted
  register: purge_vrfs

- name: WAIT purge sync
  ansible.builtin.wait_for:
    timeout: 60
  when: purge_vrfs.changed

- block:
  ##############################################
  ## MERGE basic VLAN+VRF (deploy)            ##
  ##############################################
    - name: MERGE base VLAN VRF
    cisco.dcnm.dcnm_vrf: &merge_base
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008011
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          vlan_id: 600
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          deploy: true
    register: merge_base_result
  - name: ASSERT merge_base_result
    ansible.builtin.assert:
      that:
        - merge_base_result.changed
        - merge_base_result.response[0].RETURN_CODE == 200
  - name: MERGE idempotence base
    cisco.dcnm.dcnm_vrf: *merge_base
    register: merge_base_idem
  - name: ASSERT base idempotence
    ansible.builtin.assert:
      that: ['merge_base_idem.changed == false']

  ##############################################
  ## MERGE L3VNI without VLAN                 ##
  ##############################################
  - name: PURGE before L3VNI test
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: deleted
  - name: MERGE L3VNI w/o VLAN
    cisco.dcnm.dcnm_vrf: &merge_l3vni
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008011
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          l3vni_wo_vlan: true
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          deploy: false
    register: merge_l3vni_result
  - name: ASSERT merge l3vni
    ansible.builtin.assert:
      that: ['merge_l3vni_result.changed == true']
  - name: MERGE L3VNI idempotence
    cisco.dcnm.dcnm_vrf: *merge_l3vni
    register: merge_l3vni_idem
  - name: ASSERT l3vni idempotence
    ansible.builtin.assert:
      that: ['merge_l3vni_idem.changed == false']

  ##############################################
  ## MERGE VRF LITE (user vlan)               ##
  ##############################################
  - name: PURGE before VRF LITE
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: deleted
  - name: MERGE VRF LITE user vlan
    cisco.dcnm.dcnm_vrf: &merge_lite
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008011
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          vlan_id: 500
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          vrf_lite:
            - peer_vrf: ansible-vrf-int1
              interface: "{{ interface_2a }}"
          deploy: true
    register: merge_lite_result
  - name: ASSERT merge_lite_result
    ansible.builtin.assert:
      that: ['merge_lite_result.changed == true']
  - name: MERGE VRF LITE idempotence
    cisco.dcnm.dcnm_vrf: *merge_lite
    register: merge_lite_idem
  - name: ASSERT lite idempotence
    ansible.builtin.assert:
      that: ['merge_lite_idem.changed == false']

  ##############################################
  ## MERGE VRF LITE L3VNI w/o VLAN            ##
  ##############################################
  - name: PURGE before VRF LITE L3VNI
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: deleted
  - name: MERGE VRF LITE L3VNI no VLAN
    cisco.dcnm.dcnm_vrf: &merge_lite_l3vni
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008011
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          l3vni_wo_vlan: true
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          vrf_lite:
            - interface: "{{ interface_2a }}"
          deploy: false
    register: merge_lite_l3vni_result
  - name: ASSERT merge_lite_l3vni_result
    ansible.builtin.assert:
      that: ['merge_lite_l3vni_result.changed == true']
  - name: MERGE VRF LITE L3VNI idempotence
    cisco.dcnm.dcnm_vrf: *merge_lite_l3vni
    register: merge_lite_l3vni_idem
  - name: ASSERT merge_lite_l3vni idempotence
    ansible.builtin.assert:
      that: ['merge_lite_l3vni_idem.changed == false']

  ##############################################
  ## ERROR scenarios                          ##
  ##############################################
  - name: ERROR update vrf_id mismatch
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008012
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          deploy: true
    register: err_vrfid
    ignore_errors: true
  - name: ASSERT error vrf_id
    ansible.builtin.assert:
      that: ['err_vrfid.changed == false', '"cannot be updated" in err_vrfid.msg']

  - name: ERROR out of range vrf_id
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008012000000000
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          deploy: true
    register: err_range
    ignore_errors: true
  - name: ASSERT error range
    ansible.builtin.assert:
      that: ['err_range.changed == false', '"exceeds" in err_range.msg']

  - name: ERROR missing interface in vrf_lite
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008011
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          vlan_id: 500
          attach:
            - ip_address: "{{ switch_1 }}"
            - ip_address: "{{ switch_2 }}"
          vrf_lite:
            - peer_vrf: ansible-vrf-int1
          deploy: true
    register: err_missing_iface
    ignore_errors: true
  - name: ASSERT error missing interface
    ansible.builtin.assert:
      that: ['err_missing_iface.changed == false', '"Required parameter" in err_missing_iface.msg']

  - name: ERROR VRF LITE on non-border
    cisco.dcnm.dcnm_vrf:
      fabric: "{{ fabric_1 }}"
      state: merged
      config:
        - vrf_name: ansible-vrf-int1
          vrf_id: 9008011
          vrf_template: Default_VRF_Universal
          vrf_extension_template: Default_VRF_Extension_Universal
          vlan_id: 500
          attach:
            - ip_address: "{{ switch_3 }}"
          vrf_lite:
            - peer_vrf: ansible-vrf-int1
              interface: "{{ interface_3a }}"
          deploy: true
    register: err_non_border
    ignore_errors: true
  - name: ASSERT error non-border
    ansible.builtin.assert:
      that: ['err_non_border.changed == false', '"Border roles" in err_non_border.msg']

  always:
    - name: ALWAYS cleanup
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
      register: final_cleanup
    - name: ASSERT cleanup
      ansible.builtin.assert:
        that: ['final_cleanup.changed in [true,false]']
