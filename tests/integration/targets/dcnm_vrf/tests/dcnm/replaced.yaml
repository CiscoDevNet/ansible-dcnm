##############################################
## dcnm_vrf replaced.yaml (Refactored)      ##
## Purpose: test replace semantics & VRF LITE ##
##############################################

- name: FACT rest_path (11.x)
  ansible.builtin.set_fact:
    rest_path: "/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version == '11'

- name: FACT rest_path (12.x+)
  ansible.builtin.set_fact:
    rest_path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version >= '12'

- name: DEBUG vars
  ansible.builtin.debug:
    msg: "fabric={{ fabric_1 }} s1={{ switch_1 }} s2={{ switch_2 }} iface2a={{ interface_2a }}"

- name: QUERY fabric deployed
  cisco.dcnm.dcnm_rest:
    method: GET
    path: "{{ rest_path }}"
  register: fabric_query

- name: ASSERT fabric deployed
  ansible.builtin.assert:
    that:
      - 'fabric_query.response.DATA != None'

- name: PURGE initial VRFs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_1 }}"
    state: deleted
  register: purge_initial

- name: WAIT after purge
  ansible.builtin.wait_for:
    timeout: 60
  when: purge_initial.changed

- block:
    ##############################################
    ## BASELINE CREATE DEPLOYED VRF             ##
    ##############################################
    - name: MERGE baseline ansible-vrf-int1
      cisco.dcnm.dcnm_vrf: &baseline_vrf
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            deploy: true
      register: baseline_result
    - name: WAIT baseline DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: baseline_wait
      until:
        - "baseline_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT baseline
      ansible.builtin.assert:
        that:
          - 'baseline_result.changed'

    ##############################################
    ## REPLACE remove attachments               ##
    ##############################################
    - name: REPLACE remove attachments
      cisco.dcnm.dcnm_vrf: &replace_remove
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
      register: replace_remove_result
    - name: ASSERT replace remove
      ansible.builtin.assert:
        that:
          - 'replace_remove_result.changed'
    - name: REPLACE remove idempotence
      cisco.dcnm.dcnm_vrf: *replace_remove
      register: replace_remove_idem
    - name: ASSERT remove idempotence
      ansible.builtin.assert:
        that:
          - 'replace_remove_idem.changed == false'

    ##############################################
    ## REPLACE add attachments (deploy)         ##
    ##############################################
    - name: REPLACE add attachments
      cisco.dcnm.dcnm_vrf: &replace_add
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            deploy: true
      register: replace_add_result
    - name: WAIT replace add DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: replace_add_wait
      until:
        - "replace_add_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT replace add
      ansible.builtin.assert:
        that:
          - 'replace_add_result.changed'
    - name: REPLACE add idempotence
      cisco.dcnm.dcnm_vrf: *replace_add
      register: replace_add_idem
    - name: ASSERT replace add idempotence
      ansible.builtin.assert:
        that:
          - 'replace_add_idem.changed == false'

    ##############################################
    ## VRF LITE create via merged               ##
    ##############################################
    - name: PURGE before vrf_lite cycle
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
    - name: MERGE create with VRF LITE (dot1q 2)
      cisco.dcnm.dcnm_vrf: &lite_merged
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                dot1q: 2
            deploy: true
      register: lite_merged_result
    - name: WAIT lite merged DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: lite_merged_wait
      until:
        - "lite_merged_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT lite merged
      ansible.builtin.assert:
        that:
          - 'lite_merged_result.changed'

    - name: REPLACE remove VRF LITE attachment
      cisco.dcnm.dcnm_vrf: &lite_remove
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_1 }}"
            deploy: true
      register: lite_remove_result
    - name: ASSERT lite remove
      ansible.builtin.assert:
        that:
          - 'lite_remove_result.changed'
    - name: REPLACE remove lite idempotence
      cisco.dcnm.dcnm_vrf: *lite_remove
      register: lite_remove_idem
    - name: ASSERT remove lite idempotence
      ansible.builtin.assert:
        that:
          - 'lite_remove_idem.changed == false'

    - name: REPLACE re-add VRF LITE attachment
      cisco.dcnm.dcnm_vrf: &lite_add
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                dot1q: 2
            deploy: true
      register: lite_add_result
    - name: ASSERT lite add
      ansible.builtin.assert:
        that:
          - 'lite_add_result.changed'
    - name: REPLACE lite add idempotence
      cisco.dcnm.dcnm_vrf: *lite_add
      register: lite_add_idem
    - name: ASSERT lite add idempotence
      ansible.builtin.assert:
        that:
          - 'lite_add_idem.changed == false'

    ##############################################
    ## L3VNI WO VLAN + VRF LITE (deploy false)  ##
    ##############################################
    - name: PURGE before l3vni cycle
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
    - name: MERGE L3VNI no VLAN + VRF LITE (deploy:false)
      cisco.dcnm.dcnm_vrf: &l3vni_lite
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            l3vni_wo_vlan: true
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                dot1q: 2
            deploy: false
      register: l3vni_lite_result
    - name: ASSERT l3vni lite merge
      ansible.builtin.assert:
        that:
          - 'l3vni_lite_result.changed'
    - name: QUERY l3vni lite
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: l3vni_lite_query
    - name: ASSERT l3vni lite query
      ansible.builtin.assert:
        that:
          - 'l3vni_lite_query.response[0].parent.vrfStatus == "PENDING"'

    - name: REPLACE remove VRF LITE from l3vni
      cisco.dcnm.dcnm_vrf: &l3vni_remove
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            l3vni_wo_vlan: true
            attach:
              - ip_address: "{{ switch_1 }}"
            deploy: false
      register: l3vni_remove_result
    - name: ASSERT l3vni remove
      ansible.builtin.assert:
        that:
          - 'l3vni_remove_result.changed'
    - name: REPLACE l3vni remove idempotence
      cisco.dcnm.dcnm_vrf: *l3vni_remove
      register: l3vni_remove_idem
    - name: ASSERT l3vni remove idempotence
      ansible.builtin.assert:
        that:
          - 'l3vni_remove_idem.changed == false'

    - name: REPLACE re-add VRF LITE to l3vni
      cisco.dcnm.dcnm_vrf: &l3vni_add
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            l3vni_wo_vlan: true
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                dot1q: 2
            deploy: false
      register: l3vni_add_result
    - name: ASSERT l3vni add
      ansible.builtin.assert:
        that:
          - 'l3vni_add_result.changed'
    - name: REPLACE l3vni add idempotence
      cisco.dcnm.dcnm_vrf: *l3vni_add
      register: l3vni_add_idem
    - name: ASSERT l3vni add idempotence
      ansible.builtin.assert:
        that:
          - 'l3vni_add_idem.changed == false'

  always:
    - name: ALWAYS cleanup VRFs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
      register: final_cleanup
    - name: ASSERT cleanup
      ansible.builtin.assert:
        that: ['final_cleanup.changed in [true,false]']
