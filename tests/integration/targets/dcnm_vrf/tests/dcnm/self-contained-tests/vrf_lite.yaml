##############################################
## vrf_lite.yaml (Refactored)               ##
## Multi-interface & multi-switch VRF Lite  ##
##############################################

- name: FACT rest_path (11.x)
  ansible.builtin.set_fact:
    rest_path: "/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version == '11'

- name: FACT rest_path (12.x+)
  ansible.builtin.set_fact:
    rest_path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric_1 }}"
  when: controller_version >= '12'

- name: QUERY fabric
  cisco.dcnm.dcnm_rest:
    method: GET
    path: "{{ rest_path }}"
  register: fabric_query

- name: ASSERT fabric
  ansible.builtin.assert:
    that:
      - 'fabric_query.response.DATA != None'

- name: PURGE any existing VRFs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_1 }}"
    state: deleted
  register: initial_purge

- name: WAIT after purge
  ansible.builtin.wait_for:
    timeout: 40
  when: initial_purge.changed

- block:
    ##############################################
    ## 1. MERGE single VRF Lite interface       ##
    ##############################################
    - name: MERGE vrf ansible-vrf-int1 + lite iface2a
      cisco.dcnm.dcnm_vrf: &merge_single
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_2 }}"
              - ip_address: "{{ switch_3 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                ipv4_addr: 10.33.0.2/24
                neighbor_ipv4: 10.33.0.1
                dot1q: 2
            deploy: true
      register: merge_single_result
    - name: WAIT merge_single DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: merge_single_wait
      until:
        - "merge_single_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT merge_single
      ansible.builtin.assert:
        that:
          - 'merge_single_result.changed'
    - name: MERGE single idempotence
      cisco.dcnm.dcnm_vrf: *merge_single
      register: merge_single_idem
    - name: ASSERT single idempotence
      ansible.builtin.assert:
        that:
          - 'merge_single_idem.changed == false'

    ##############################################
    ## 2. MERGE add second VRF Lite interface   ##
    ##############################################
    - name: MERGE add iface2b
      cisco.dcnm.dcnm_vrf: &merge_second
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                ipv4_addr: 10.33.0.2/24
                neighbor_ipv4: 10.33.0.1
                dot1q: 2
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2b }}"
                ipv4_addr: 20.33.0.2/24
                neighbor_ipv4: 20.33.0.1
                dot1q: 21
            deploy: true
      register: merge_second_result
    - name: WAIT merge_second DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: merge_second_wait
      until:
        - "merge_second_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT merge_second
      ansible.builtin.assert:
        that:
          - 'merge_second_result.changed'
    - name: MERGE second idempotence
      cisco.dcnm.dcnm_vrf: *merge_second
      register: merge_second_idem
    - name: ASSERT second idempotence
      ansible.builtin.assert:
        that:
          - 'merge_second_idem.changed == false'

    ##############################################
    ## 3. REPLACED remove second interface      ##
    ##############################################
    - name: REPLACE drop iface2b keep iface2a
      cisco.dcnm.dcnm_vrf: &replace_drop
        fabric: "{{ fabric_1 }}"
        state: replaced
        config:
          - vrf_name: ansible-vrf-int1
            vrf_id: 9008011
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 500
            attach:
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                ipv4_addr: 10.33.0.2/24
                neighbor_ipv4: 10.33.0.1
                dot1q: 2
            deploy: true
      register: replace_drop_result
    - name: WAIT replace_drop DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: replace_drop_wait
      until:
        - "replace_drop_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT replace_drop
      ansible.builtin.assert:
        that:
          - 'replace_drop_result.changed'
    - name: REPLACE drop idempotence
      cisco.dcnm.dcnm_vrf: *replace_drop
      register: replace_drop_idem
    - name: ASSERT drop idempotence
      ansible.builtin.assert:
        that:
          - 'replace_drop_idem.changed == false'

    ##############################################
    ## 4. OVERRIDDEN new VRF with two ifaces    ##
    ##############################################
    - name: OVERRIDE to ansible-vrf-int2 two ifaces
      cisco.dcnm.dcnm_vrf: &override_two
        fabric: "{{ fabric_1 }}"
        state: overridden
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008013
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 400
            attach:
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                ipv4_addr: 10.33.0.2/24
                neighbor_ipv4: 10.33.0.1
                dot1q: 2
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2b }}"
                ipv4_addr: 20.33.0.2/24
                neighbor_ipv4: 20.33.0.1
                dot1q: 21
            deploy: true
      register: override_two_result
    - name: WAIT override_two DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: override_two_wait
      until:
        - "override_two_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT override_two
      ansible.builtin.assert:
        that:
          - 'override_two_result.changed'
    - name: OVERRIDE two idempotence
      cisco.dcnm.dcnm_vrf: *override_two
      register: override_two_idem
    - name: ASSERT override two idempotence
      ansible.builtin.assert:
        that:
          - 'override_two_idem.changed == false'

    ##############################################
    ## 5. MERGE multi-switch & multi-ifaces     ##
    ##############################################
    - name: PURGE before multi-switch case
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
    - name: MERGE ansible-vrf-int2 across switch_1 & switch_2
      cisco.dcnm.dcnm_vrf: &merge_multi
        fabric: "{{ fabric_1 }}"
        state: merged
        config:
          - vrf_name: ansible-vrf-int2
            vrf_id: 9008015
            vrf_template: Default_VRF_Universal
            vrf_extension_template: Default_VRF_Extension_Universal
            vlan_id: 400
            attach:
              - ip_address: "{{ switch_1 }}"
              - ip_address: "{{ switch_2 }}"
            vrf_lite:
              - peer_vrf: ansible-vrf-int3
                interface: "{{ interface_1a }}"
                ipv4_addr: 40.33.0.2/24
                neighbor_ipv4: 40.33.0.1
                dot1q: 4
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2a }}"
                ipv4_addr: 10.33.0.2/24
                neighbor_ipv4: 10.33.0.1
                dot1q: 2
              - peer_vrf: ansible-vrf-int1
                interface: "{{ interface_2b }}"
                ipv4_addr: 20.33.0.2/24
                neighbor_ipv4: 20.33.0.1
                dot1q: 21
            deploy: true
      register: merge_multi_result
    - name: WAIT merge_multi DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: query
      register: merge_multi_wait
      until:
        - "merge_multi_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
      retries: 30
      delay: 2
    - name: ASSERT merge_multi
      ansible.builtin.assert:
        that:
          - 'merge_multi_result.changed'
    - name: MERGE multi idempotence
      cisco.dcnm.dcnm_vrf: *merge_multi
      register: merge_multi_idem
    - name: ASSERT multi idempotence
      ansible.builtin.assert:
        that:
          - 'merge_multi_idem.changed == false'

  always:
    - name: ALWAYS cleanup VRFs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_1 }}"
        state: deleted
      register: final_cleanup
    - name: ASSERT cleanup
      ansible.builtin.assert:
        that:
          - 'final_cleanup.changed in [true,false]'
