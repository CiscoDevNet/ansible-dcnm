---
################################################################################
# RUNTIME
################################################################################
# Recent run times (MM:SS.ms):
#  05:51.85
################################################################################
# DESCRIPTION - merged_normal_to_maintenance
#
# State: merged
# Test: Change normal mode switches to maintenance mode with config-deploy.
################################################################################
################################################################################
# STEPS
################################################################################
# SETUP
# 0. Run 00_setup_fabrics_rw.yaml to create read-write fabrics and add switches.
# 1. MERGED - SETUP - ensure switches are in normal mode
# TEST
# 3. Place leaf_1 and leaf_2 in maintenance mode using global config and verify.
# CLEANUP
# 4. Place leaf_1 and leaf_2 in normal mode using global config and verify.
################################################################################
# REQUIREMENTS
################################################################################
# Example vars for dcnm_maintenance_mode integration tests
# Add to cisco/dcnm/playbooks/dcnm_tests.yaml)
#
# vars:
#   # This testcase field can run any test in the tests directory for the role
#   testcase: merged_normal_to_maintenance
#   fabric_name_1: VXLAN_EVPN_Fabric
#   fabric_type_1: VXLAN_EVPN
#   fabric_name_3: LAN_CLASSIC_Fabric
#   fabric_type_3: LAN_CLASSIC
#   leaf_1: 172.22.150.103
#   leaf_2: 172.22.150.104
#   nxos_username: admin
#   nxos_password: mypassword
################################################################################
# 1. MERGED - SETUP - ensure switches are in normal mode
################################################################################
# Expected result
# ok: [172.22.150.244] => {
#     "result": {
#         "changed": false,
#         "diff": [
#             {
#                 "sequence_number": 1
#             },
#             {
#                 "sequence_number": 2
#             },
#             {
#                 "172.22.150.103": {
#                     "fabric_deployment_disabled": false,
#                     "fabric_freeze_mode": false,
#                     "fabric_name": "VXLAN_EVPN_Fabric",
#                     "fabric_read_only": false,
#                     "ip_address": "172.22.150.103",
#                     "mode": "normal",
#                     "role": "leaf",
#                     "serial_number": "FDO211218GC"
#                 },
#                 "172.22.150.104": {
#                     "fabric_deployment_disabled": false,
#                     "fabric_freeze_mode": false,
#                     "fabric_name": "LAN_CLASSIC_Fabric",
#                     "fabric_read_only": false,
#                     "ip_address": "172.22.150.104",
#                     "mode": "normal",
#                     "role": "leaf",
#                     "serial_number": "FDO211218HH"
#                 },
#                 "sequence_number": 3
#             }
#         ],
- name: MERGED - SETUP - Verify switches are in normal mode
  cisco.dcnm.dcnm_maintenance_mode:
        state: query
        config:
              switches:
                    - ip_address: "{{ leaf_1 }}"
                    - ip_address: "{{ leaf_2 }}"
  register: result
  retries: 40
  delay: 10
  until:
        - result.diff[2][leaf_1].mode == "normal"
        - result.diff[2][leaf_2].mode == "normal"

################################################################################
# MERGED - TEST - change switches to maintenance mode (global config)
################################################################################
- name: MERGED - TEST - change switches to maintenance mode (global config)
  cisco.dcnm.dcnm_maintenance_mode:
        state: merged
        config:
              deploy: true
              mode: maintenance
              switches:
                    - ip_address: "{{ leaf_1 }}"
                    - ip_address: "{{ leaf_2 }}"
  register: result_maintenance_mode
- debug:
        var: result_maintenance_mode

################################################################################
# 1. MERGED - TEST - verify switches changed to maintenance mode
################################################################################
# Expected result
# ok: [172.22.150.244] => {
#     "result": {
#         "changed": false,
#         "diff": [
#             {
#                 "sequence_number": 1
#             },
#             {
#                 "sequence_number": 2
#             },
#             {
#                 "172.22.150.103": {
#                     "fabric_deployment_disabled": false,
#                     "fabric_freeze_mode": false,
#                     "fabric_name": "VXLAN_EVPN_Fabric",
#                     "fabric_read_only": false,
#                     "ip_address": "172.22.150.103",
#                     "mode": "maintenance",
#                     "role": "leaf",
#                     "serial_number": "FDO211218GC"
#                 },
#                 "172.22.150.104": {
#                     "fabric_deployment_disabled": false,
#                     "fabric_freeze_mode": false,
#                     "fabric_name": "LAN_CLASSIC_Fabric",
#                     "fabric_read_only": false,
#                     "ip_address": "172.22.150.104",
#                     "mode": "maintenance",
#                     "role": "leaf",
#                     "serial_number": "FDO211218HH"
#                 },
#                 "sequence_number": 3
#             }
#         ],
- name: MERGED - TEST - Verify switches changed to maintenance mode
  cisco.dcnm.dcnm_maintenance_mode:
        state: query
        config:
              switches:
                    - ip_address: "{{ leaf_1 }}"
                    - ip_address: "{{ leaf_2 }}"
  register: result
  retries: 40
  delay: 10
  until:
        - result.diff[2][leaf_1].mode == "maintenance"
        - result.diff[2][leaf_2].mode == "maintenance"

# Pause is needed here or NDFC claims config-deploy succeeded, but it
# actually doesn't succeed, and one switch remains in maintenance mode.
- name: pause 1 minutes
  pause:
        minutes: 1

- name: MERGED - TEST - change switches to normal mode (global config)
  cisco.dcnm.dcnm_maintenance_mode:
        state: merged
        config:
              deploy: true
              mode: normal
              switches:
                    - ip_address: "{{ leaf_1 }}"
                    - ip_address: "{{ leaf_2 }}"
  register: result_normal_mode
- debug:
        var: result_normal_mode


- name: MERGED - TEST - Verify switches changed to normal mode
  cisco.dcnm.dcnm_maintenance_mode:
        state: query
        config:
              switches:
                    - ip_address: "{{ leaf_1 }}"
                    - ip_address: "{{ leaf_2 }}"
  register: result
  retries: 40
  delay: 10
  until:
        - result.diff[2][leaf_1].mode == "normal"
        - result.diff[2][leaf_2].mode == "normal"

- assert:
        that:
              - result_maintenance_mode.failed == false
              - result_maintenance_mode.metadata[2].action == "change_sytem_mode"
              - result_maintenance_mode.metadata[3].action == "change_sytem_mode"
              - result_maintenance_mode.metadata[2].check_mode == False
              - result_maintenance_mode.metadata[3].check_mode == False
              - result_maintenance_mode.metadata[2].state == "merged"
              - result_maintenance_mode.metadata[3].state == "merged"
              - result_maintenance_mode.response[2].DATA.status == "Success"
              - result_maintenance_mode.response[3].DATA.status == "Success"
              - result_maintenance_mode.response[2].METHOD == "POST"
              - result_maintenance_mode.response[3].METHOD == "POST"
              - result_maintenance_mode.response[2].RETURN_CODE == 200
              - result_maintenance_mode.response[3].RETURN_CODE == 200
              - result_maintenance_mode.response[4].DATA.status is match 'Configuration
                  deployment completed.'
              - result_maintenance_mode.response[5].DATA.status is match 'Configuration
                  deployment completed.'
              - result_normal_mode.failed == false
              - result_normal_mode.metadata[2].action == "change_sytem_mode"
              - result_normal_mode.metadata[3].action == "change_sytem_mode"
              - result_normal_mode.metadata[2].check_mode == False
              - result_normal_mode.metadata[3].check_mode == False
              - result_normal_mode.metadata[2].state == "merged"
              - result_normal_mode.metadata[3].state == "merged"
              - result_normal_mode.response[2].DATA.status == "Success"
              - result_normal_mode.response[3].DATA.status == "Success"
              - result_normal_mode.response[2].METHOD == "DELETE"
              - result_normal_mode.response[3].METHOD == "DELETE"
              - result_normal_mode.response[2].RETURN_CODE == 200
              - result_normal_mode.response[3].RETURN_CODE == 200
              - result_normal_mode.response[4].DATA.status is match 'Configuration
                  deployment completed.'
              - result_normal_mode.response[5].DATA.status is match 'Configuration
                  deployment completed.'
