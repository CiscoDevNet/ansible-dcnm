##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_sgrp_association.log

- name: Put the fabric to default state
  cisco.dcnm.dcnm_sgrp_association:
    fabric: "{{ ansible_it_fabric }}"
    state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
    deploy: switches                    # choose from ["none", "switches"]
  register: result

- assert:
    that:
      - 'item["RETURN_CODE"] == 200'
  loop: '{{ result.response }}'


- block:

##############################################
##                MERGE                     ##
##############################################

    - name: Create Security Group Associations
      cisco.dcnm.dcnm_sgrp_association: &sgrp_assoc_create
        fabric: "{{ ansible_it_fabric }}"
        deploy: switches                                    # choose from ["none", "switches"]
        state: merged                                       # choose from [merged, replaced, deleted, overridden, query]
        config:
          - src_group_name: "LSG_15001"
            dst_group_name: "LSG_15001"
            src_group_id: 15001                             # Group Id associated with src_group_name
            dst_group_id: 15001                             # Group Id associated with dst_group_name
            vrf_name: "MyVRF_50001"
            contract_name: CONTRACT1
            switch:
              - "{{ ansible_switch1 }}"
              - "{{ ansible_switch2 }}"

          - src_group_name: "LSG_15002"
            dst_group_name: "LSG_15002"
            vrf_name: "MyVRF_50002"
            contract_name: CONTRACT1
            switch:
              - "{{ ansible_switch1 }}"
              - "{{ ansible_switch2 }}"

          - src_group_name: "LSG_15003"
            dst_group_name: "LSG_15003"
            vrf_name: "MyVRF_50003"
            contract_name: CONTRACT1
            switch:
              - "{{ ansible_switch1 }}"
              - "{{ ansible_switch2 }}"

          - src_group_name: "LSG_15004"
            dst_group_name: "LSG_15004"
            vrf_name: "MyVRF_50004"
            contract_name: CONTRACT1
            switch:
              - "{{ ansible_switch1 }}"
              - "{{ ansible_switch2 }}"

          - src_group_name: "LSG_15005"
            dst_group_name: "LSG_15005"
            vrf_name: "MyVRF_50005"
            contract_name: CONTRACT1
            switch:
              - "{{ ansible_switch1 }}"
              - "{{ ansible_switch2 }}"
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 5'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 1'

##############################################
##              DELETE                      ##
##############################################

    - name: Delete Security Group Associations - without config
      cisco.dcnm.dcnm_sgrp_association: &sgrp_assoc_delete
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                    # choose from ["none", "switches"]
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 5'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

    - assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'

##############################################
##              IDEMPOTENCE                 ##
##############################################

    - name: Delete Security Group Associations - Idempotence
      cisco.dcnm.dcnm_sgrp_association: *sgrp_assoc_delete
      register: result

    - assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

##############################################
##               MERGE
##############################################

    - name: Create Security Group Associations again
      cisco.dcnm.dcnm_sgrp_association: *sgrp_assoc_create
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 5'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 1'


##############################################
##              DELETE                      ##
##############################################

    - name: Delete Security Group Associations - with source group name
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                    # choose from ["none", "switches"]
        config:
          - src_group_name: "LSG_15001"
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

    - name: Delete Security Group Associations - with destination group name
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                    # choose from ["none", "switches"]
        config:
          - dst_group_name: "LSG_15002"
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

    - name: Delete Security Group Associations - with vrf name
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                    # choose from ["none", "switches"]
        config:
          - vrf_name: "MyVRF_50003"
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

    - name: Delete Security Group Associations - with group id
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                    # choose from ["none", "switches"]
        config:
          - src_group_id: 15005
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

    - name: Delete Security Group Associations - with contract name
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                    # choose from ["none", "switches"]
        config:
          - contract_name: "CONTRACT1"
            switch:
              - "{{ ansible_switch1 }}"
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 1'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

    - name: Delete Security Group Associations - non-existent associations
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                      # choose from [merged, replaced, deleted, overridden, query]
        deploy: none                        # choose from ["none", "switches"]
        config:
          - src_group_name: "LSG_15001"
          - dst_group_name: "LSG_15002"
          - vrf_name: MyVRF_50003
          - contract_name: CONTRACT1
          - src_group_id: 15004
          - dst_group_id: 15005
      register: result

    - assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

##############################################
##                CLEANUP                   ##
##############################################

  always:

    - name: Delete all created security group associations
      cisco.dcnm.dcnm_sgrp_association:
        fabric: "{{ ansible_it_fabric }}"
        state: deleted                     # choose from [merged, replaced, deleted, overridden, query]
        deploy: switches                   # choose from ["none", "switches"]
      register: result
      when: IT_CONTEXT is not defined

    - assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - 'item["MESSAGE"] == "OK"'
      loop: '{{ result.response }}'
      when: IT_CONTEXT is not defined
