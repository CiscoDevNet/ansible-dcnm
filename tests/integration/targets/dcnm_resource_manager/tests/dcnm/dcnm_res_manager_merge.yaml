##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f res_mgr.log

- name: Delete Resources
  cisco.dcnm.dcnm_resource_manager: &rm_delete
    state: deleted                                 # choose form [merged, deleted, query]
    fabric: "{{ ansible_it_fabric }}"
    config:
      - entity_name: "l3_vni_fabric"               # A unique name to identify the resource
        pool_type: "ID"                            # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "L3_VNI"                        # Based on the 'poolType', select appropriate name
        scope_type: "fabric"                       # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']

      - entity_name: "l2_vni_fabric"               # A unique name to identify the resource
        pool_type: "ID"                            # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "L2_VNI"                        # Based on the 'poolType', select appropriate name
        scope_type: "fabric"                       # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']

      - entity_name: "loopback_dev"                # A unique name to identify the resource
        pool_type: "ID"                            # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "LOOPBACK_ID"                   # Based on the 'poolType', select appropriate name
        scope_type: "device"                       # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']
        switch: # provide the switch information to which the given resource is attached
          - "{{ ansible_switch1 }}"
          - "{{ ansible_switch2 }}"

      - entity_name: "{{ ansible_sno_1 }}~{{ ansible_sno_2 }}" # A unique name to identify the resource
        pool_type: "ID"                            # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "VPC_ID"                        # Based on the 'poolType', select appropriate name
        scope_type: "device_pair"                  # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']
        switch: # provide the switch information to which the given resource is attached
          - "{{ ansible_switch1 }}"
          - "{{ ansible_switch2 }}"

      - entity_name: "mmudigon-2"                  # A unique name to identify the resource
        pool_type: "IP"                            # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "LOOPBACK0_IP_POOL"             # Based on the 'poolType', select appropriate name
        scope_type: "fabric"                       # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']

      - entity_name: "{{ ansible_sno_1 }}~{{ intf_1_10 }}" # A unique name to identify the resource
        pool_type: "IP"                            # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "LOOPBACK1_IP_POOL"             # Based on the 'poolType', select appropriate name
        scope_type: "device_interface"             # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']
        switch: # provide the switch information to which the given resource is attached
          - "{{ ansible_switch1 }}"

      - entity_name: "{{ ansible_sno_1 }}~{{ intf_1_3 }}~{{ ansible_sno_2 }}~{{ intf_1_3 }}" # A unique name to identify the resource
        pool_type: "SUBNET"                        # choose from ['ID', 'IP', 'SUBNET']
        pool_name: "SUBNET"                        # Based on the 'poolType', select appropriate name
        scope_type: "link"                         # choose from ['fabric', 'device', device_interface', 'device_pair', 'link']
        switch: # provide the switch information to which the given resource is attached
          - "{{ ansible_switch1 }}"
  register: result

- name: Assert
  ansible.builtin.assert:
    that:
##############################################
##               CLEANUP                    ##
##############################################

- always:

    - name: Delete Resources
      cisco.dcnm.dcnm_resource_manager: *rm_delete
      register: result
      when: it_context is not defined
