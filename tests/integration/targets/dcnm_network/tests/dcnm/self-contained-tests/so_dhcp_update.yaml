##############################################
##                 SETUP                    ##
##############################################

- name: SO_DHCP_UPDATE - Test Entry Point - [ndfc_network]
  ansible.builtin.debug:
    msg:
      - "----------------------------------------------------------------"
      - "+              Executing Tests - [ndfc_network]                +"
      - "----------------------------------------------------------------"

##############################################
##      Create Dictionary of Test Data      ##
##############################################
- name: SO_DHCP_UPDATE - Setup Internal TestCase Variables
  ansible.builtin.set_fact:
    test_data:
      # ----------------------------------
      # config templates and auto generated file location for test cases
      # ----------------------------------
      double_net_dhcp_conf_template: "self-contained-tests/double_net_dhcp_conf.j2"
      double_net_dhcp_conf_file: "{{ role_path }}/files/self_contained_dhcp_conf.yaml"
      # ----------------------------------
      double_net_dhcp_changed_conf_template: "self-contained-tests/double_net_dhcp_changed_conf.j2"
      double_net_dhcp_changed_conf_file: "{{ role_path }}/files/self_contained_double_net_dhcp_changed_conf.yaml"

- name: SO_DHCP_UPDATE - Create Network Config File using J2 Template
  ansible.builtin.template:
    src: "{{ test_data.double_net_dhcp_conf_template }}"
    dest: "{{ test_data.double_net_dhcp_conf_file }}"
  delegate_to: localhost

- name: SO_DHCP_UPDATE - Create Network Config File using J2 Template
  ansible.builtin.template:
    src: "{{ test_data.double_net_dhcp_changed_conf_template }}"
    dest: "{{ test_data.double_net_dhcp_changed_conf_file }}"
  delegate_to: localhost

##############################################
##                MERGED                    ##
##############################################
- name: SO_DHCP_UPDATE - Delete any existing networks
  cisco.dcnm.dcnm_network:
    fabric: "{{ test_data_common.fabric }}"
    state: deleted
  register: result

- name: SO_DHCP_UPDATE - Load Network Config File
  ansible.builtin.set_fact:
    dcnm_network_merged_double_net_dhcp_conf: "{{ lookup('file', '{{ test_data.double_net_dhcp_conf_file }}') | from_yaml }}"
  delegate_to: localhost

- name: SO_DHCP_UPDATE - Create New Network with many params
  cisco.dcnm.dcnm_network: &conf
    fabric: "{{ test_data_common.fabric }}"
    state: merged
    config: "{{ dcnm_network_merged_double_net_dhcp_conf }}"
  register: result

- name: SO_DHCP_UPDATE - ASSERT - Check changed flag is true
  ansible.builtin.assert:
    that:
      - result.changed == true

      - name: SO_DHCP_UPDATE - Query fabric for creation of Network Object
  cisco.dcnm.dcnm_network:
    fabric: "{{ test_data_common.fabric }}"
    state: query
  register: verify_result

- name: SO_DHCP_UPDATE - VALIDITY CHECK - Verify network state in NDFC
  cisco.dcnm.tests.integration.ndfc_network_validate:
    config_path: "{{ test_data.double_net_dhcp_conf_file }}"
    ndfc_data: "{{ verify_result }}"
    test_data: "{{ test_data_common }}"
  delegate_to: localhost

- name: SO_DHCP_UPDATE - Load Network Changed Config File
  ansible.builtin.set_fact:
    dcnm_network_merged_double_net_dhcp_changed_conf: "{{ lookup('file', '{{ test_data.double_net_dhcp_changed_conf_file }}') | from_yaml }}"
  delegate_to: localhost

- name: SO_DHCP_UPDATE - Override network config
  cisco.dcnm.dcnm_network:
    fabric: "{{ test_data_common.fabric }}"
    state: overridden
    config: "{{ dcnm_network_merged_double_net_dhcp_changed_conf }}"
  register: result

- name: SO_DHCP_UPDATE - ASSERT - Check changed flag is true
  ansible.builtin.assert:
    that:
      - result.changed == true

      - name: SO_DHCP_UPDATE - Query fabric for creation of Network Object
  cisco.dcnm.dcnm_network:
    fabric: "{{ test_data_common.fabric }}"
    state: query
  register: verify_result

- name: SO_DHCP_UPDATE - VALIDITY CHECK - Verify network state in NDFC
  cisco.dcnm.tests.integration.ndfc_network_validate:
    config_path: "{{ test_data.double_net_dhcp_changed_conf_file }}"
    ndfc_data: "{{ verify_result }}"
    test_data: "{{ test_data_common }}"
  delegate_to: localhost

##############################################
##                 CLEAN-UP                 ##
##############################################

- name: SO_DHCP_UPDATE - END - Clean up any existing networks
  cisco.dcnm.dcnm_network:
    fabric: "{{ test_data_common.fabric }}"
    state: deleted
