---
- name: MAIN - Setup Internal TestCase Variables
  ansible.builtin.set_fact:
    test_data:
      test_fabric: "{{ ansible_test_fabric }}"
      sw1: "{{ ansible_switch1 }}"
      sw2: "{{ ansible_switch2 }}"
      vrf_1: "{{ ansible_vrf_1 }}"
      vrf_1_id: "{{ ansible_vrf_1_id }}"
      vrf_1_vlan_id: "{{ ansible_vrf_1_vlan_id }}"
      vrf_2: "{{ ansible_vrf_2 }}"
      vrf_2_id: "{{ ansible_vrf_2_id }}"
      vrf_2_vlan_id: "{{ ansible_vrf_2_vlan_id }}"
      vrf_3: "{{ ansible_vrf_3 }}"
      vrf_3_id: "{{ ansible_vrf_3_id }}"
      vrf_3_vlan_id: "{{ ansible_vrf_3_vlan_id }}"
      deploy: "{{ ansible_deploy | bool }}"
      #----------------------------------  
      # config template for vrf setup
      #----------------------------------
      setup_vrf_conf_template: "{{ ansible_setup_vrf_conf }}" 
      setup_vrf_conf_file: "{{ role_path }}/files/dcnm_network_setup_vrf_conf.yaml"
      #----------------------------------
  delegate_to: localhost
  tags: sanity

# maintaining backward compatibility until all test cases are updated
- set_fact:
    controller_version: "Unable to determine controller version"

- name: Determine version of DCNM or NDFC
  cisco.dcnm.dcnm_rest:
    method: GET
    path: /appcenter/cisco/ndfc/api/about/version
  register: result
  ignore_errors: yes

- set_fact:
    controller_version: "{{ result.response['DATA']['version'][0:2] | int }}"
  when: ( result.response['DATA']['version'] is search("\d\d.\d+") )
  ignore_errors: yes

- name: Determine version of DCNM or NDFC
  cisco.dcnm.dcnm_rest:
    method: GET
    path: /fm/fmrest/about/version
  register: result
  ignore_errors: yes

- set_fact:
    controller_version: "{{ result.response['DATA']['version'][0:2] | int }}"
  when: ( result.response['DATA']['version'] is search("\d\d.\d+") )
  ignore_errors: yes


- assert:
    that:
    - 'controller_version != "Unable to determine controller version"'

# new version below

- name: MAIN - QUERY - Verify Fabric Deployment
  cisco.dcnm.dcnm_fabric:
    state: query
    config:
      - FABRIC_NAME: "{{ test_data.test_fabric }}"
  register: verify_result
  tags: sanity

- name: MAIN - DELETED - Remove all existing networks to start with a clean state
  cisco.dcnm.dcnm_network:
    fabric: "{{ test_data.test_fabric }}"
    state: deleted


- name: MAIN - Create VRF Config File using J2 Template
  ansible.builtin.template:
    src: "{{ test_data.setup_vrf_conf_template }}"
    dest: "{{ test_data.setup_vrf_conf_file }}"
  delegate_to: localhost

- name: MAIN - Load VRF Configuration
  ansible.builtin.set_fact:
    dcnm_network_setup_vrf_conf: "{{ lookup('file', '{{ test_data.setup_vrf_conf_file }}') | from_yaml }}"
  delegate_to: localhost
  tags: sanity

- name: MAIN - OVERRIDDEN - Create vrfs required for this test and remove all other vrfs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ test_data.test_fabric }}"
    state: overridden
    config: "{{ dcnm_network_setup_vrf_conf }}"
  tags: sanity

- name: MAIN - Collect DCNM Network Test Cases
  find:
    paths: ["{{ role_path }}/tests/dcnm", "{{ role_path }}/tests/dcnm/self-contained-tests"]
    patterns: "{{ testcase }}.yaml"
  connection: local
  register: dcnm_cases
  delegate_to: localhost
  tags: sanity

- name: MAIN - Set Test Cases Fact
  set_fact:
    test_cases:
      files: "{{ dcnm_cases.files }}"
  delegate_to: localhost
  tags: sanity

- name: MAIN - Build List of Test Items
  set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
  delegate_to: localhost
  tags: sanity

- name: MAIN - Run Test Cases
  include_tasks: "{{ test_case_to_run }}"
  with_items: "{{ test_items }}"
  loop_control:
    loop_var: test_case_to_run

  tags: sanity

- name: MAIN - DELETED - Clean Up Any Existing VRFs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ ansible_test_fabric }}"
    state: deleted
  tags: sanity
