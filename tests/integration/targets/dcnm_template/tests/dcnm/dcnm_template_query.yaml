##############################################
##               SETUP                      ##
##############################################

- name: Initialize templates for query test
  cisco.dcnm.dcnm_template:
    state: deleted
    config:
      - name: template_101
      - name: template_102
      - name: template_103
      - name: template_104
  register: init_result

- name: Assert init responses
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ init_result.response }}'

- block:

##############################################
##                MERGE                     ##
##############################################

    - name: Create templates
      cisco.dcnm.dcnm_template:
        state: merged
        config:
          - name: template_101
            description: "Template_101"
            tags: "internal policy 101"
            content: |
              telemetry
              certificate /bootflash/telegraf.crt telegraf
              destination-profile
                use-vrf management
              destination-group 1
                ip address 10.195.225.176 port 57000 protocol gRPC encoding GPB
              sensor-group 1
                data-source DME
                path sys/ch depth unbounded
              subscription 1
                dst-grp 1
                snsr-grp 1 sample-interval 10000

          - name: template_102
            description: "Template_102"
            tags: "internal policy 102"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 2
                  ip address 10.195.224.176 port 52000 protocol gRPC encoding GPB
                sensor-group 2
                  data-source DME
                  path sys/ch depth unbounded
                subscription 2
                  dst-grp 2
                  snsr-grp 2 sample-interval 20000

          - name: template_103
            description: "Template_103"
            tags: "internal policy 103"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 3
                  ip address 10.195.225.176 port 53000 protocol gRPC encoding GPB
                sensor-group 3
                  data-source DME
                  path sys/ch depth unbounded
                subscription 3
                  dst-grp 3
                  snsr-grp 2 sample-interval 30000

          - name: template_104
            description: "Template_104"
            tags: "internal policy 104"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 4
                  ip address 10.195.224.176 port 54000 protocol gRPC encoding GPB
                sensor-group 4
                  data-source DME
                  path sys/ch depth unbounded
                subscription 4
                  dst-grp 4
                  snsr-grp 4 sample-interval 40000
      register: create_result

    - name: Assert create diff
      ansible.builtin.assert:
        that:
          - 'create_result.changed == true'
          - '(create_result.diff[0].merged | length) == 4'
          - '(create_result.diff[0].deleted | length) == 0'
          - '(create_result.diff[0].query | length) == 0'

    - name: Assert create responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Template Created" in item["DATA"]["status"]'
        loop: '{{ create_result.response }}'

##############################################
##                 QUERY                     ##
##############################################

    - name: Query templates (including inuse)
      cisco.dcnm.dcnm_template:
        state: query
        config:
          - name: template_101
          - name: template_102
          - name: template_103
          - name: template_104
          - name: template_inuse_1
      register: query_result

    - name: Assert query results
      ansible.builtin.assert:
        that:
          - 'query_result.changed == false'
          - '(query_result["diff"][0]["merged"] | length) == 0'
          - '(query_result["diff"][0]["deleted"] | length) == 0'
          - '(query_result.diff[0].query | length) == 5'
          - '"template_inuse_1" in query_result["template-policy-map"].keys()'

##############################################
##               CLEANUP                    ##
##############################################

  always:
    - name: Delete all templates created
      cisco.dcnm.dcnm_template:
        state: deleted
        config:
          - name: template_101
          - name: template_102
          - name: template_103
          - name: template_104
      register: delete_result

    - name: Assert deletion responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Template deletion successful" in item["DATA"]'
        loop: '{{ delete_result.response }}'

    - name: Assert deletion diff
      ansible.builtin.assert:
        that:
          - 'delete_result.changed == true'
          - '(delete_result.diff[0].deleted | length) == 4'
          - '(delete_result.diff[0].merged | length) == 0'
          - '(delete_result.diff[0].query | length) == 0'
