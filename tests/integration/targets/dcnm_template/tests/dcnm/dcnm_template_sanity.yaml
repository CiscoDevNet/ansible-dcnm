##############################################
##               SETUP (SANITY)             ##
##############################################

- name: SANITY - Initialize templates
  cisco.dcnm.dcnm_template:
    config:
      - name: template_101
      - name: template_102
      - name: template_103
      - name: template_104
  register: init_result
  tags: sanity

- name: SANITY - Assert initialization
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ init_result.response }}'
  tags: sanity

- block:
    - name: SANITY - Create templates
      cisco.dcnm.dcnm_template: &sanity_create_set
        state: merged
        config:
          - name: template_101
            description: "Template_101"
            tags: "internal policy 101"
            content: |
              certificate /bootflash/telegraf.crt telegraf
              destination-profile
                use-vrf management
              destination-group 1
                ip address 10.195.225.176 port 57000 protocol gRPC encoding GPB
              sensor-group 1
                data-source DME
                path sys/ch depth unbounded
              subscription 1
                dst-grp 1
                snsr-grp 1 sample-interval 10000
          - name: template_102
            description: "Template_102"
            tags: "internal policy 102"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 2
                  ip address 10.195.224.176 port 52000 protocol gRPC encoding GPB
                sensor-group 2
                  data-source DME
                  path sys/ch depth unbounded
                subscription 2
                  dst-grp 2
                  snsr-grp 2 sample-interval 20000
          - name: template_103
            description: "Template_103"
            tags: "internal policy 103"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 3
                  ip address 10.195.225.176 port 53000 protocol gRPC encoding GPB
                sensor-group 3
                  data-source DME
                  path sys/ch depth unbounded
                subscription 3
                  dst-grp 3
                  snsr-grp 2 sample-interval 30000
          - name: template_104
            description: "Template_104"
            tags: "internal policy 104"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 4
                  ip address 10.195.224.176 port 54000 protocol gRPC encoding GPB
                sensor-group 4
                  data-source DME
                  path sys/ch depth unbounded
                subscription 4
                  dst-grp 4
                  snsr-grp 4 sample-interval 40000
      register: sanity_create_result

    - name: SANITY - Assert create diff
      ansible.builtin.assert:
        that:
          - 'sanity_create_result.changed == true'
          - '(sanity_create_result.diff[0].merged | length) == 4'
          - '(sanity_create_result.diff[0].deleted | length) == 0'
          - '(sanity_create_result.diff[0].query | length) == 0'

    - name: SANITY - Assert create responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Template Created" in item["DATA"]["status"]'
        loop: '{{ sanity_create_result.response }}'

    - name: SANITY - Wait for controller state sync
      ansible.builtin.wait_for:
        timeout: 100

    - name: SANITY - Idempotence create
      cisco.dcnm.dcnm_template: *sanity_create_set
      register: sanity_create_idem

    - name: SANITY - Assert idempotence create
      ansible.builtin.assert:
        that:
          - 'sanity_create_idem.changed == false'
          - '(sanity_create_idem.diff[0].merged | length) == 0'
          - '(sanity_create_idem.diff[0].deleted | length) == 0'
          - '(sanity_create_idem.diff[0].query | length) == 0'

##############################################
##            MODIFY PROPERTIES             ##
##############################################

    - name: SANITY - Modify templates
      cisco.dcnm.dcnm_template: &sanity_modify_set
        state: merged
        config:
          - name: template_101
            description: "Template_101 - added this description"
            tags: "internal policy 101"
            content: |
              certificate /bootflash/telegraf.crt telegraf
              destination-profile
                use-vrf management
              destination-group 1
                ip address 10.195.225.176 port 57000 protocol gRPC encoding GPB
              sensor-group 1
                data-source DME
                path sys/ch depth unbounded
              subscription 1
                dst-grp 1
                snsr-grp 1 sample-interval 10000
          - name: template_102
            description: "Template_102 - added this"
            tags: "internal policy 102 - added this"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 2
                  ip address 10.195.224.176 port 52000 protocol gRPC encoding GPB
                sensor-group 2
                  data-source DME
                  path sys/ch depth unbounded
                subscription 2
                  dst-grp 2
                  snsr-grp 2 sample-interval 20000
          - name: template_103
            description: "Template_103 - added this"
            tags: "internal policy 103 - added this"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 10
                  ip address 10.195.225.179 port 53010 protocol gRPC encoding GPB
                sensor-group 10
                  data-source DME
                  path sys/ch depth unbounded
                subscription 10
                  dst-grp 10
                  snsr-grp 10 sample-interval 30010
          - name: template_104
            description: "Template_104"
            tags: "internal policy 104"
            content: |
              telemetry
                certificate /bootflash/telegraf.crt telegraf
                destination-profile
                  use-vrf management
                destination-group 4
                  ip address 10.195.224.176 port 54000 protocol gRPC encoding GPB
                sensor-group 4
                  data-source DME
                  path sys/ch depth unbounded
                subscription 4
                  dst-grp 4
                  snsr-grp 4 sample-interval 40000
      register: sanity_modify_result

    - name: SANITY - Assert modify diff
      ansible.builtin.assert:
        that:
          - 'sanity_modify_result.changed == true'
          - '(sanity_modify_result.diff[0].merged | length) == 3'
          - '(sanity_modify_result.diff[0].deleted | length) == 0'
          - '(sanity_modify_result.diff[0].query | length) == 0'

    - name: SANITY - Assert modify responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Template Created" in item["DATA"]["status"]'
        loop: '{{ sanity_modify_result.response }}'

    - name: SANITY - Idempotence modify
      cisco.dcnm.dcnm_template: *sanity_modify_set
      register: sanity_modify_idem

    - name: SANITY - Assert idempotence modify
      ansible.builtin.assert:
        that:
          - 'sanity_modify_idem.changed == false'
          - '(sanity_modify_idem.diff[0].merged | length) == 0'
          - '(sanity_modify_idem.diff[0].deleted | length) == 0'
          - '(sanity_modify_idem.diff[0].query | length) == 0'

##############################################
##                NO DELETE TEST            ##
##############################################

    - name: SANITY - Delete templates including in-use
      cisco.dcnm.dcnm_template:
        state: deleted
        config:
          - name: template_inuse_1
          - name: template_inuse_2
          - name: template_101
      register: delete_inuse_result

    - name: SANITY - Assert in-use deletion responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
          - '"Templates in use, not deleted" in item["DATA"]'
        loop: '{{ delete_inuse_result.response }}'

    - name: SANITY - Assert policy map
      ansible.builtin.assert:
        that:
          - '(delete_inuse_result["template-policy-map"] | length) == 2'
          - '"template_inuse_1" in delete_inuse_result["template-policy-map"].keys()'
          - '"template_inuse_2" in delete_inuse_result["template-policy-map"].keys()'

    - name: SANITY - Delete non-existent template
      cisco.dcnm.dcnm_template:
        state: deleted
        config:
          - name: template_1000
      register: delete_missing_result

    - name: SANITY - Assert delete missing response codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
        loop: '{{ delete_missing_result.response }}'

##############################################
##                QUERY INUSE               ##
##############################################

    - name: SANITY - Query in-use template only
      cisco.dcnm.dcnm_template:
        state: query
        config:
          - name: template_inuse_1
      register: query_inuse_result

    - name: SANITY - Assert query in-use
      ansible.builtin.assert:
        that:
          - 'query_inuse_result.changed == false'
          - '(query_inuse_result.diff[0].query | length) == 1'
          - '"template_inuse_1" in query_inuse_result["template-policy-map"].keys()'

##############################################
##          TEMPLATE VALIDATION FAIL        ##
##############################################

    - name: SANITY - Attempt invalid template creation
      cisco.dcnm.dcnm_template:
        state: merged
        config:
          - name: test_fail
            description: "test_fail"
            tags: "internal template test_fail"
            content: |
              #    All rights reserved.

              @(DisplayName="AAA Server Name/IP", Description="Name or IPv4/IPv6 Address of an AAA Server")
              ipAddressWithoutPrefix AAA_SERVER;

              @(DisplayName="AAA group", Description="Name of AAA Group")
              string AAA_GROUP {
              minLength = 1;
              maxLength = 127;
              };
              aaa group server radius $$AAA_GROUP$$
              server $$AAA_SERVER$$
      register: validation_fail_result

    - name: SANITY - Assert validation failure diff
      ansible.builtin.assert:
        that:
          - 'validation_fail_result.changed == false'
          - '(validation_fail_result.diff[0].failed | length) == 1'
          - '(validation_fail_result.diff[0].merged | length) == 0'
          - '(validation_fail_result.diff[0].deleted | length) == 0'
          - '(validation_fail_result.diff[0].query | length) == 0'

    - name: SANITY - Flag error_exists
      ansible.builtin.set_fact:
        error_exists: true
      when: '"ERROR" in (validation_fail_result.response[0].DATA | string)'

    - name: SANITY - Assert error flag
      ansible.builtin.assert:
        that:
          - 'error_exists == true'

##############################################
##             WRONG STATE TEST             ##
##############################################

    - name: SANITY - Wrong state invocation
      cisco.dcnm.dcnm_template:
        state: replaced  # invalid on purpose
        config:
          - name: template_101
            description: "Template_101"
            tags: "internal policy 101"
            content: |
              certificate /bootflash/telegraf.crt telegraf
              destination-profile
                use-vrf management
              destination-group 1
                ip address 10.195.225.176 port 57000 protocol gRPC encoding GPB
              sensor-group 1
                data-source DME
                path sys/ch depth unbounded
              subscription 1
                dst-grp 1
                snsr-grp 1 sample-interval 10000
      register: wrong_state_result
      ignore_errors: true

    - name: SANITY - Assert wrong state message
      ansible.builtin.assert:
        that:
          - 'wrong_state_result.changed == false'
          - 'wrong_state_result.msg == "value of state must be one of: merged, deleted, query, got: replaced"'

##############################################
##                DELETE ALL                ##
##############################################

    - name: SANITY - Delete all templates
      cisco.dcnm.dcnm_template:
        state: deleted
        config:
          - name: template_101
          - name: template_102
          - name: template_103
          - name: template_104
      register: delete_all_result

    - name: SANITY - Assert delete all outcome
      ansible.builtin.assert:
        that:
          - 'delete_all_result.changed == false'  # already deleted during previous steps
          - '(delete_all_result.diff[0].merged | length) == 0'
          - '(delete_all_result.diff[0].deleted | length) == 0'
          - '(delete_all_result.diff[0].query | length) == 0'
  tags: sanity
