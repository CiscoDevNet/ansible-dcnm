##############################################
##               SETUP                      ##
##############################################

- name: Initialize template test context
  cisco.dcnm.dcnm_template:
    config:
      - name: template_101
  register: init_result

- name: Assert initialization responses
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ init_result.response }}'

- name: Initialize error flag
  ansible.builtin.set_fact:
    error_exists: false

- block:

##############################################
##           VALIDATION FAILURE TEST        ##
##############################################

    - name: Attempt to create invalid template
      cisco.dcnm.dcnm_template:
        state: merged
        config:
          - name: test_fail
            description: "test_fail"
            tags: "internal template test_fail"
            content: |
              #    All rights reserved.

              @(DisplayName="AAA Server Name/IP", Description="Name or IPv4/IPv6 Address of an AAA Server")
              ipAddressWithoutPrefix AAA_SERVER;

              @(DisplayName="AAA group", Description="Name of AAA Group")
              string AAA_GROUP {
              minLength = 1;
              maxLength = 127;
              };
              aaa group server radius $$AAA_GROUP$$
              server $$AAA_SERVER$$
      register: fail_result

    - name: Assert template validation failure diff
      ansible.builtin.assert:
        that:
          - 'fail_result.changed == false'
          - '(fail_result.diff[0].failed | length) == 1'
          - '(fail_result.diff[0].merged | length) == 0'
          - '(fail_result.diff[0].deleted | length) == 0'
          - '(fail_result.diff[0].query | length) == 0'

    - name: Flag error_exists when ERROR present
      ansible.builtin.set_fact:
        error_exists: true
      when: '"ERROR" in (fail_result.response[0].DATA | string)'

    - name: Assert error flag
      ansible.builtin.assert:
        that:
          - 'error_exists == true'

##############################################
##             CLEANUP                      ##
##############################################
