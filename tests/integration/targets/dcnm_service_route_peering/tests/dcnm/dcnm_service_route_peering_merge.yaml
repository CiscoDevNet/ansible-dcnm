##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f srp.log

- name: Delete route peerings
  cisco.dcnm.dcnm_service_route_peering:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
  register: result

- name: Assert
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ result.response }}'


- block:

##############################################
##                MERGE                     ##
##############################################

    - name: Create different non-existing service route peerings including all objects
      cisco.dcnm.dcnm_service_route_peering: &dcnm_srp_all
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config:
          - name: IT-FW-RP1                                  # mandatory
            node_name: "{{ ansible_snode_1 }}"  # mandatory
            deploy_mode: intra_tenant_fw  # mandatory, choices=[intra_tenant_fw, inter_tenant_fw]
            inside_network:
              name: Rp1-sn1-inside-net  # mandatory
              vlan_id: 101  # mandatory
              profile:
                ipv4_gw: 192.161.1.1/24  # mandatory
                ipv6_gw: "2001:db01::1/64"  # optional, default is ''
              vlan_name: rp1-sn1-inside  # optional, default is ''
              int_descr: "RP1 SN1 inside interface"  # optional, default is ''
              tag: 11111  # optional, default is 12345
            next_hop: 192.161.1.100  # mandatory
            outside_network:
              vrf: "{{ ansible_vrf_11 }}"  # mandatory
              name: Rp1-sn1-outside-net  # mandatory
              vlan_id: 102  # mandatory
              profile:
                ipv4_gw: 192.161.2.1/24  # mandatory
                ipv6_gw: "2001:db02::1/64"  # optional, default is ''
              vlan_name: rp1-sn1-outside  # optional, default is ''
              int_descr: "RP1 SN1 outside interface"       # optionL, default is ''
              tag: 11112  # optional, default is 12345
            reverse_next_hop: 192.161.2.100  # optional, default is ''

          - name: IT-FW-RP2                                  # mandatory
            node_name: "{{ ansible_snode_1 }}"  # mandatory
            deploy_mode: inter_tenant_fw  # mandatory, choices=[intra_tenant_fw, inter_tenant_fw]
            peering_option: static  # optional, default is static, choices=[static, ebgp]
            inside_network:
              vrf: "{{ ansible_vrf_21 }}"  # mandatory
              name: Rp2-sn1-inside-net  # mandatory
              vlan_id: 201  # mandatory
              profile:
                ipv4_gw: 192.162.1.1/24  # mandatory
                ipv6_gw: "2002:db01::1/64"  # optional, default is ''
              vlan_name: rp2-sn1-inside  # optional, default is ''
              int_descr: "RP2 SN1 inside interface"  # optional, default is ''
              static_route: # optional, default is ''
                - subnet: 20.20.20.0/24
                  next_hop:
                    - 120.120.120.100
                    - 121.121.121.100
              tag: 21111  # optional, default is 12345
            outside_network:
              vrf: "{{ ansible_vrf_22 }}"  # mandatory
              name: Rp2-sn1-outside-net  # mandatory
              vlan_id: 202  # mandatory
              profile:
                ipv4_gw: 192.162.2.1/24  # mandatory
                ipv6_gw: "2002:db02::1/64"  # optional, default is ''
              vlan_name: rp2-sn1-outside  # optional, default is ''
              int_descr: "RP2 SN1 outside interface"  # optional, default is ''
              static_route: # optional, default is ''
                - subnet: 21.21.21.0/24
                  next_hop:
                    - 122.122.122.100
                    - 123.123.123.100
              tag: 22222  # optional, default is 12345

          - name: IT-FW-RP3                                  # mandatory
        node_name: "{{ ansible_snode_1 }}"  # mandatory
        deploy_mode: inter_tenant_fw  # mandatory, choices=[intra_tenant_fw, inter_tenant_fw]
        peering_option: ebgp  # optional, default is static, choices=[static, ebgp]
        inside_network:
          vrf: "{{ ansible_vrf_31 }}"  # mandatory
          name: Rp3-sn1-inside-net  # mandatory
          vlan_id: 301  # mandatory
          profile:
            ipv4_gw: 192.163.1.1/24  # mandatory

##############################################
##             CLEANUP                      ##
##############################################

    - name: Clean up - Delete all route peerings
      cisco.dcnm.dcnm_service_route_peering:
        state: deleted
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config: []
      register: cleanup_result
