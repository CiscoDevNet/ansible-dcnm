##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f srp.log

- name: Delete route peerings
  cisco.dcnm.dcnm_service_route_peering:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
  register: result

- name: Assert
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ result.response }}'

- block:

##############################################
##                MERGE                     ##
##############################################

- name: Create Loadbalancer One ARM Static and eBGP peerings
  cisco.dcnm.dcnm_service_route_peering:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    config:
      - name: IT-ADC-RP4
        node_name: "{{ ansible_snode_2 }}"
        deploy_mode: one_arm_adc
        peering_option: ebgp
        first_arm:
          name: Rp4-sn2-first-arm
          vlan_id: 401
          profile:
            ipv4_gw: 192.164.1.1/24
            ipv6_gw: "2004:db01::1/64"
          vlan_name: rp4-sn2-first-arm
          int_descr: "RP4 SN2 first arm intf"
          tag: 41111
          ipv4_neighbor: 41.41.41.1
          ipv4_lo: 41.1.1.2
          ipv4_vpc_peer_lo: 41.1.1.3
          ipv6_neighbor: "2004:4141::1"
          ipv6_lo: "2004:0102::1"
          ipv6_vpc_peer_lo: "2004:0103::1"
        route_map_tag: 41112
        neigh_int_descr: "RP4 SN2 first arm"
        local_asn: 65401
        adv_host: true
      - name: IT-ADC-RP6
        node_name: "{{ ansible_snode_2 }}"
        deploy_mode: one_arm_adc
        peering_option: static
        first_arm:
          vrf: "{{ ansible_vrf_61 }}"
          name: Rp6-sn2-first-arm
          vlan_id: 601
          profile:
            ipv4_gw: 192.166.1.1/24
            ipv6_gw: "2006:db01::1/64"
          vlan_name: rp6-sn2-first-arm
          int_descr: "RP6 SN2 first arm intf"
          tag: 61111
          static_route:
            - subnet: 61.61.61.1/24
              next_hop:
                - 161.161.161.1
                - 162.162.162.1
            - subnet: 22.0.0.0/24
              next_hop:
                - 163.163.163.1
                - 164.164.164.1
        reverse_next_hop:
          - 192.166.1.100
    attach: true
    deploy: true
    state: merged
  register: result

- name: ASSERT - Check condition
  ansible.builtin.assert:
    that:
      - result.changed == true
      - '(result["diff"][0]["merged"] | length) == 2'
      - '(result["diff"][0]["deleted"] | length) == 0'
      - '(result["diff"][0]["modified"] | length) == 0'
      - '(result["diff"][0]["query"] | length) == 0'
      - '(result["diff"][0]["deploy"] | length) == 2'

- ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ result.response }}'

##############################################
##                CLEANUP                   ##
##############################################

- name: Delete all created route peerings
  cisco.dcnm.dcnm_service_route_peering:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    config:
      - name: IT-FW-RP1
        node_name: "{{ ansible_snode_1 }}"
      - name: IT-FW-RP2
        node_name: "{{ ansible_snode_1 }}"
      - name: IT-FW-RP3
        node_name: "{{ ansible_snode_1 }}"
      - name: IT-ADC-RP4
        node_name: "{{ ansible_snode_2 }}"
      - name: IT-ADC-RP5
        node_name: "{{ ansible_snode_2 }}"
      - name: IT-ADC-RP6
        node_name: "{{ ansible_snode_2 }}"
      - name: IT-ADC-RP7
        node_name: "{{ ansible_snode_2 }}"
    state: deleted
  register: result
  when: it_context is not defined

- name: Validate deletion
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ result.response }}'
    when: it_context is not defined
