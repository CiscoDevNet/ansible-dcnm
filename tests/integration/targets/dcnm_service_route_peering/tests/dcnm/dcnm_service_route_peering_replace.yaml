##############################################
##               SETUP                      ##
##############################################
##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f srp.log

- name: Delete route peerings
  cisco.dcnm.dcnm_service_route_peering:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
  register: result

- name: ASSERT - Delete route peerings
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
  loop: '{{ result.response }}'

- block:

##############################################
##        INITIAL REPLACED CREATE           ##
##############################################

    - name: Create service route peerings (initial replaced)
      cisco.dcnm.dcnm_service_route_peering: &dcnm_srp_initial
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config:
          - name: IT-FW-RP1
            node_name: "{{ ansible_snode_1 }}"
            deploy_mode: intra_tenant_fw
            inside_network:
              name: Rp1-sn1-inside-net
              vlan_id: 101
              profile:
                ipv4_gw: 192.161.1.1/24
                ipv6_gw: "2001:db01::1/64"
              vlan_name: rp1-sn1-inside
              int_descr: "RP1 SN1 inside interface"
              tag: 11111
            next_hop: 192.161.1.100
            outside_network:
              vrf: "{{ ansible_vrf_11 }}"
              name: Rp1-sn1-outside-net
              vlan_id: 102
              profile:
                ipv4_gw: 192.161.2.1/24
                ipv6_gw: "2001:db02::1/64"
              vlan_name: rp1-sn1-outside
              int_descr: "RP1 SN1 outside interface"
              tag: 11112
            reverse_next_hop: 192.161.2.100

          - name: IT-FW-RP2
            node_name: "{{ ansible_snode_1 }}"
            deploy_mode: inter_tenant_fw
            peering_option: static
            inside_network:
              vrf: "{{ ansible_vrf_21 }}"
              name: Rp2-sn1-inside-net
              vlan_id: 201
              profile:
                ipv4_gw: 192.162.1.1/24
                ipv6_gw: "2002:db01::1/64"
              vlan_name: rp2-sn1-inside
              int_descr: "RP2 SN1 inside interface"
              static_route:
                - subnet: 20.20.20.0/24
                  next_hop:
                    - 120.120.120.100
                    - 121.121.121.100
              tag: 21111
            outside_network:
              vrf: "{{ ansible_vrf_22 }}"
              name: Rp2-sn1-outside-net
              vlan_id: 202
              profile:
                ipv4_gw: 192.162.2.1/24
                ipv6_gw: "2002:db02::1/64"
              vlan_name: rp2-sn1-outside
              int_descr: "RP2 SN1 outside interface"
              static_route:
                - subnet: 21.21.21.0/24
                  next_hop:
                    - 122.122.122.100
                    - 123.123.123.100
              tag: 22222

          - name: IT-FW-RP3
            node_name: "{{ ansible_snode_1 }}"
            deploy_mode: inter_tenant_fw
            peering_option: ebgp
            inside_network:
              vrf: "{{ ansible_vrf_31 }}"
              name: Rp3-sn1-inside-net
              vlan_id: 301
              profile:
                ipv4_gw: 192.163.1.1/24
                ipv6_gw: "2003:db01::1/64"
              vlan_name: rp3-sn1-inside
              int_descr: "RP3 SN1 inside interface"
              tag: 31111
              ipv4_neighbor: 31.31.31.1
              ipv4_lo: 31.11.1.2
              ipv4_vpc_peer_lo: 31.11.1.3
              ipv6_neighbor: "2003:3131::1"
              ipv6_lo: "2003:1102::1"
              ipv6_vpc_peer_lo: "2003:1103::1"
              route_map_tag: 33111
              neigh_int_descr: "RP3 SN1 inside interface"
              local_asn: 65301
              adv_host: true
            outside_network:
              vrf: "{{ ansible_vrf_32 }}"
              name: Rp3-sn1-outside-net
              vlan_id: 302
              profile:
                ipv4_gw: 192.163.2.1/24
                ipv6_gw: "2003:db02::1/64"
              vlan_name: rp3-sn1-outside
              int_descr: "RP3 SN1 outside interface"
              tag: 31112
              ipv4_neighbor: 131.131.131.1
              ipv4_lo: 131.11.1.2
              ipv4_vpc_peer_lo: 131.11.1.3
              ipv6_neighbor: "2003:8383::1"
              ipv6_lo: "2003:1104::1"
              ipv6_vpc_peer_lo: "2003:1105::1"
              route_map_tag: 31113
              neigh_int_descr: "RP3 SN1 outside interface"
              local_asn: 65302
              adv_host: true

          - name: IT-ADC-RP4
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: one_arm_adc
            peering_option: ebgp
            first_arm:
              vrf: "{{ ansible_vrf_41 }}"
              name: Rp4-sn2-first-arm
              vlan_id: 401
              profile:
                ipv4_gw: 192.164.1.1/24
                ipv6_gw: "2004:db01::1/64"
              vlan_name: rp4-sn2-first-arm
              int_descr: "RP4 SN2 first arm intf"
              tag: 41111
              ipv4_neighbor: 41.41.41.1
              ipv4_lo: 41.11.1.2
              ipv4_vpc_peer_lo: 41.11.1.3
              ipv6_neighbor: "2004:4141::1"
              ipv6_lo: "2004:1102::1"
              ipv6_vpc_peer_lo: "2004:1103::1"
              route_map_tag: 41112
              neigh_int_descr: "RP4 SN2 first arm"
              local_asn: 65401
              adv_host: true
            reverse_next_hop: 192.164.1.100

          - name: IT-ADC-RP5
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: two_arm_adc
            peering_option: ebgp
            first_arm:
              vrf: "{{ ansible_vrf_51 }}"
              name: Rp5-sn2-first-arm
              vlan_id: 501
              profile:
                ipv4_gw: 192.165.1.1/24
                ipv6_gw: "2005:db01::1/64"
              vlan_name: rp5-sn2-first-arm
              int_descr: "RP5 SN2 first arm intf"
              tag: 51111
              ipv4_neighbor: 51.51.51.1
              ipv4_lo: 51.11.1.2
              ipv4_vpc_peer_lo: 51.11.1.3
              ipv6_neighbor: "2005:5151::1"
              ipv6_lo: "2005:1102::1"
              ipv6_vpc_peer_lo: "2005:1103::1"
              route_map_tag: 51115
              neigh_int_descr: "RP5 SN2 first arm"
              local_asn: 65501
              adv_host: true
            second_arm:
              vrf: "{{ ansible_vrf_51 }}"
              name: Rp5-sn2-second-arm
              vlan_id: 502
              profile:
                ipv4_gw: 192.165.2.1/24
                ipv6_gw: "2005:db02::1/64"
              vlan_name: rp5-sn2-second-arm
              int_descr: "RP5 SN2 second arm intf"
              tag: 51112
            reverse_next_hop: 192.165.1.100

          - name: IT-ADC-RP6
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: one_arm_adc
            peering_option: static
            first_arm:
              vrf: "{{ ansible_vrf_61 }}"
              name: Rp6-sn2-first-arm
              vlan_id: 601
              profile:
                ipv4_gw: 192.166.1.1/24
                ipv6_gw: "2006:db01::1/64"
              vlan_name: rp6-sn2-first-arm
              int_descr: "RP6 SN2 first arm intf"
              tag: 61111
              static_route:
                - subnet: 61.61.61.1/24
                  next_hop:
                    - 161.161.161.1
                    - 162.162.162.1
                - subnet: 22.0.0.0/24
                  next_hop:
                    - 163.163.163.1
                    - 164.164.164.1
            reverse_next_hop: 192.166.1.100

          - name: IT-ADC-RP7
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: two_arm_adc
            peering_option: static
            first_arm:
              vrf: "{{ ansible_vrf_71 }}"
              name: Rp7-sn2-first-arm
              vlan_id: 701
              profile:
                ipv4_gw: 192.167.1.1/24
                ipv6_gw: "2007:db01::1/64"
              vlan_name: rp7-sn2-first-arm
              int_descr: "RP6 SN2 first arm  intf"
              tag: 71111
              static_route:
                - subnet: 71.71.71.1/24
                  next_hop:
                    - 171.171.171.1
                    - 172.172.172.1
            second_arm:
              vrf: "{{ ansible_vrf_71 }}"
              name: Rp7-sn2-second-arm
              vlan_id: 702
              profile:
                ipv4_gw: 192.167.2.1/24
                ipv6_gw: "2007:db02::1/64"
              vlan_name: rp7-sn2-second-arm
              int_descr: "RP7 SN2 second arm intf"
              tag: 71112
            reverse_next_hop: 192.167.1.100
        attach: true
        deploy: true
        state: replaced
      register: result

    - name: ASSERT - Initial replaced create
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 7'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 7'

    - name: ASSERT - Return codes initial replaced create
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'

##############################################
##      REPLACE SUBSET (RP1-RP3)            ##
##############################################

    - name: Replace peerings RP1-RP3
      cisco.dcnm.dcnm_service_route_peering: &dcnm_srp_rep_13
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config:
          - name: IT-FW-RP1
            node_name: "{{ ansible_snode_1 }}"
            deploy_mode: intra_tenant_fw
            inside_network:
              name: Rp1-sn1-inside-net
              vlan_id: 191
              profile:
                ipv4_gw: 192.161.1.1/24
                ipv6_gw: "2001:db01::1/64"
              vlan_name: rep-rp1-sn1-inside
              int_descr: "RP1 SN1 inside interface - REP"
              tag: 12111
            next_hop: 192.161.1.200
            outside_network:
              vrf: "{{ ansible_vrf_11 }}"
              name: Rp1-sn1-outside-net
              vlan_id: 192
              profile:
                ipv4_gw: 192.161.2.1/24
                ipv6_gw: "2001:db02::1/64"
              vlan_name: rep-rp1-sn1-outside
              int_descr: "RP1 SN1 outside interface- REP"
              tag: 12112
            reverse_next_hop: 192.161.2.200

          - name: IT-FW-RP2
            node_name: "{{ ansible_snode_1 }}"
            deploy_mode: inter_tenant_fw
            peering_option: static
            inside_network:
              vrf: "{{ ansible_vrf_21 }}"
              name: Rp2-sn1-inside-net
              vlan_id: 291
              profile:
                ipv4_gw: 192.162.1.1/24
                ipv6_gw: "2002:db01::1/64"
              vlan_name: rep-rp2-sn1-inside
              int_descr: "RP2 SN1 inside interface - REP"
              static_route:
                - subnet: 20.20.90.0/24
                  next_hop:
                    - 120.120.190.100
                    - 121.121.191.100
              tag: 22111
            outside_network:
              vrf: "{{ ansible_vrf_22 }}"
              name: Rp2-sn1-outside-net
              vlan_id: 292
              profile:
                ipv4_gw: 192.162.2.1/24
                ipv6_gw: "2002:db02::1/64"
              vlan_name: rep-rp2-sn1-outside
              int_descr: "RP2 SN1 outside interface - REP"
              static_route:
                - subnet: 21.21.29.0/24
                  next_hop:
                    - 122.122.129.100
                    - 123.123.129.100
              tag: 22112

          - name: IT-FW-RP3
            node_name: "{{ ansible_snode_1 }}"
            deploy_mode: inter_tenant_fw
            peering_option: ebgp
            inside_network:
              vrf: "{{ ansible_vrf_31 }}"
              name: Rp3-sn1-inside-net
              vlan_id: 391
              profile:
                ipv4_gw: 192.163.1.1/24
                ipv6_gw: "2003:db01::1/64"
              vlan_name: rep-rp3-sn1-inside
              int_descr: "RP3 SN1 inside interface - REP"
              tag: 32111
              ipv4_neighbor: 31.31.39.1
              ipv4_lo: 32.11.2.2
              ipv4_vpc_peer_lo: 32.11.2.3
              ipv6_neighbor: "2103:3131::1"
              ipv6_lo: "2103:1102::1"
              ipv6_vpc_peer_lo: "2103:1103::1"
              route_map_tag: 33211
              neigh_int_descr: "RP3 SN1 inside interface - REP"
              local_asn: 65391
              adv_host: true
            outside_network:
              vrf: "{{ ansible_vrf_32 }}"
              name: Rp3-sn1-outside-net
              vlan_id: 302
              profile:
                ipv4_gw: 192.163.2.1/24
                ipv6_gw: "2003:db02::1/64"
              vlan_name: rep-rp3-sn1-outside
              int_descr: "RP3 SN1 outside interface - REP"
              tag: 32112
              ipv4_neighbor: 131.131.139.1
              ipv4_lo: 132.11.2.2
              ipv4_vpc_peer_lo: 132.11.2.3
              ipv6_neighbor: "2103:8383::1"
              ipv6_lo: "2103:1104::1"
              ipv6_vpc_peer_lo: "2103:1105::1"
              route_map_tag: 33212
              neigh_int_descr: "RP3 SN1 outside interface - REP"
              local_asn: 65392
              adv_host: true
        attach: true
        deploy: true
        state: replaced
      register: result

    - name: ASSERT - Replace RP1-RP3 modified
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 3'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 3'

    - name: ASSERT - Return codes replace RP1-RP3
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'

    - name: Replace RP1-RP3 idempotence
      cisco.dcnm.dcnm_service_route_peering: *dcnm_srp_rep_13
      register: result

    - name: ASSERT - Replace RP1-RP3 idempotence
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

##############################################
##      REPLACE SUBSET (RP4-RP7)            ##
##############################################

    - name: Replace peerings RP4-RP7
      cisco.dcnm.dcnm_service_route_peering: &dcnm_srp_rep_47
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config:
          - name: IT-ADC-RP4
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: one_arm_adc
            peering_option: ebgp
            first_arm:
              vrf: "{{ ansible_vrf_41 }}"
              name: Rp4-sn2-first-arm
              vlan_id: 491
              profile:
                ipv4_gw: 192.164.1.1/24
                ipv6_gw: "2004:db01::1/64"
              vlan_name: rep-rp4-sn2-first-arm
              int_descr: "RP4 SN2 first arm intf - REP"
              tag: 42111
              ipv4_neighbor: 41.41.49.1
              ipv4_lo: 42.11.2.2
              ipv4_vpc_peer_lo: 42.11.2.3
              ipv6_neighbor: "2104:4141::1"
              ipv6_lo: "2104:1102::1"
              ipv6_vpc_peer_lo: "2104:1103::1"
              route_map_tag: 44211
              neigh_int_descr: "RP4 SN2 first arm - REP"
              local_asn: 65491
              adv_host: true
            reverse_next_hop: 192.164.1.200

          - name: IT-ADC-RP5
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: two_arm_adc
            peering_option: ebgp
            first_arm:
              vrf: "{{ ansible_vrf_51 }}"
              name: Rp5-sn2-first-arm
              vlan_id: 591
              profile:
                ipv4_gw: 192.165.1.1/24
                ipv6_gw: "2005:db01::1/64"
              vlan_name: rep-rp5-sn2-first-arm
              int_descr: "RP5 SN2 first arm intf - REP"
              tag: 52111
              ipv4_neighbor: 51.51.59.1
              ipv4_lo: 52.11.2.2
              ipv4_vpc_peer_lo: 52.11.2.3
              ipv6_neighbor: "2105:5151::1"
              ipv6_lo: "2105:1102::1"
              ipv6_vpc_peer_lo: "2105:1103::1"
              route_map_tag: 55211
              neigh_int_descr: "RP5 SN2 first arm - REP"
              local_asn: 65591
              adv_host: true
            second_arm:
              vrf: "{{ ansible_vrf_51 }}"
              name: Rp5-sn2-second-arm
              vlan_id: 592
              profile:
                ipv4_gw: 192.165.2.1/24
                ipv6_gw: "2005:db02::1/64"
              vlan_name: rep-rp5-sn2-second-arm
              int_descr: "RP5 SN2 second arm intf - REP"
              tag: 52112
            reverse_next_hop: 192.165.1.200

          - name: IT-ADC-RP6
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: one_arm_adc
            peering_option: static
            first_arm:
              vrf: "{{ ansible_vrf_61 }}"
              name: Rp6-sn2-first-arm
              vlan_id: 691
              profile:
                ipv4_gw: 192.166.1.1/24
                ipv6_gw: "2006:db01::1/64"
              vlan_name: rep-rp6-sn2-first-arm
              int_descr: "RP6 SN2 first arm intf - REP"
              tag: 62111
              static_route:
                - subnet: 61.61.69.1/24
                  next_hop:
                    - 161.161.169.1
                    - 162.162.169.1
                - subnet: 29.0.0.0/24
                  next_hop:
                    - 163.163.169.1
                    - 164.164.169.1
            reverse_next_hop: 192.166.1.200

          - name: IT-ADC-RP7
            node_name: "{{ ansible_snode_2 }}"
            deploy_mode: two_arm_adc
            peering_option: static
            first_arm:
              vrf: "{{ ansible_vrf_71 }}"
              name: Rp7-sn2-first-arm
              vlan_id: 791
              profile:
                ipv4_gw: 192.167.1.1/24
                ipv6_gw: "2007:db01::1/64"
              vlan_name: rep-rp7-sn2-first-arm
              int_descr: "RP6 SN2 first arm intf - REP"
              tag: 72111
              static_route:
                - subnet: 71.71.79.1/24
                  next_hop:
                    - 171.171.179.1
                    - 172.172.179.1
            second_arm:
              vrf: "{{ ansible_vrf_71 }}"
              name: Rp7-sn2-second-arm
              vlan_id: 792
              profile:
                ipv4_gw: 192.167.2.1/24
                ipv6_gw: "2007:db02::1/64"
              vlan_name: rep-rp7-sn2-second-arm
              int_descr: "RP7 SN2 second arm intf - REP"
              tag: 72112
            reverse_next_hop: 192.167.1.200
        attach: true
        deploy: true
        state: replaced
      register: result

    - name: ASSERT - Replace RP4-RP7 modified
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 4'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 4'

    - name: ASSERT - Return codes replace RP4-RP7
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'

    - name: Replace RP4-RP7 idempotence
      cisco.dcnm.dcnm_service_route_peering: *dcnm_srp_rep_47
      register: result

    - name: ASSERT - Replace RP4-RP7 idempotence
      ansible.builtin.assert:
        that:
          - 'result.changed == false'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deploy"] | length) == 0'

##############################################
##                CLEANUP                   ##
##############################################

  always:
    - name: Delete all created route peerings
      cisco.dcnm.dcnm_service_route_peering:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config:
          - name: IT-FW-RP1
            node_name: "{{ ansible_snode_1 }}"
          - name: IT-FW-RP2
            node_name: "{{ ansible_snode_1 }}"
          - name: IT-FW-RP3
            node_name: "{{ ansible_snode_1 }}"
          - name: IT-ADC-RP4
            node_name: "{{ ansible_snode_2 }}"
          - name: IT-ADC-RP5
            node_name: "{{ ansible_snode_2 }}"
          - name: IT-ADC-RP6
            node_name: "{{ ansible_snode_2 }}"
          - name: IT-ADC-RP7
            node_name: "{{ ansible_snode_2 }}"
        state: deleted
      register: result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'
      when: it_context is not defined
