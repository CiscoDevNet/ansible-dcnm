################################################################################
# RUNTIME
################################################################################

# Recent run times (MM:SS.ms):
# 13:32.03
#
################################################################################
# STEPS
################################################################################
#
# SETUP (these should be run prior to running this playbook)
# 1. Run 00_setup_create_fabric.yaml
# 2. Run 01_setup_add_switches_to_fabric 
# 3. Run 02_setup_replace_image_policies
# TEST (this playbook)
# 3. Upgrade switches using global config
# 4. Wait for all switches to complete ISSU
# 5. Detach policies from two switches and verify
# 6. Detach policy from remaining switch and verify
# CLEANUP
# Run 03_cleanup_remove_devices_from_fabric.yaml
# Run 04_cleanup_delete_image_policies.yaml
# Run 05_cleanup_delete_fabric.yaml
#
################################################################################
# REQUIREMENTS
################################################################################
#
# Example vars for dcnm_image_upgrade integration tests
# Add to cisco/dcnm/playbooks/dcnm_tests.yaml)
#
# vars:
#    testcase: deleted
#    fabric_name: LAN_Classic_Fabric
#    switch_username: admin
#    switch_password: "Cisco!2345"
#    leaf1: 172.22.150.103
#    leaf2: 172.22.150.104
#    spine1: 172.22.150.113
#    # for dcnm_image_policy and dcnm_image_upgrade roles
#    image_policy_1: "KR5M"
#    image_policy_2: "NR3F"
#    # for dcnm_image_policy role
#    epld_image_1: n9000-epld.10.2.5.M.img
#    epld_image_2: n9000-epld.10.3.1.F.img
#    nxos_image_1: n9000-dk9.10.2.5.M.bin
#    nxos_image_2: n9000-dk9.10.3.1.F.bin
#    nxos_release_1: 10.2.5_nxos64-cs_64bit
#    nxos_release_2: 10.3.1_nxos64-cs_64bit
#    # for dcnm_image_upgrade role
#    fabric_name_1: "{{ fabric_name }}"
#    ansible_switch_1: "{{ leaf1 }}"
#    ansible_switch_2: "{{ leaf2 }}"
#    ansible_switch_3: "{{ spine1 }}"
#
################################################################################
# DELETED - TEST - Upgrade all switches using global_config
#
# NOTES:
#   1. Depending on whether the switches are already at the desired version, the
#      upgrade may not be performed.  Hence, we do not check for the upgrade
#      status in this test.
################################################################################
# Expected result
# ok: [dcnm] => {
#     "result": {
#         "changed": true,
#         "diff": [
#             {
#                 "action": "attach",
#                 "ip_address": "172.22.150.106",
#                 "logical_name": "cvd-2311-leaf",
#                 "policy_name": "KR5M",
#                 "serial_number": "FDO211218HB"
#             },
#             {
#                 "action": "attach",
#                 "ip_address": "172.22.150.107",
#                 "logical_name": "cvd-2312-leaf",
#                 "policy_name": "KR5M",
#                 "serial_number": "FDO211218AX"
#             },
#             {
#                 "action": "attach",
#                 "ip_address": "172.22.150.114",
#                 "logical_name": "cvd-2211-spine",
#                 "policy_name": "KR5M",
#                 "serial_number": "FOX2109PHDD"
#             },
#             {
#                 "action": "stage",
#                 "ip_address": "172.22.150.106",
#                 "logical_name": "cvd-2311-leaf",
#                 "policy": "KR5M",
#                 "serial_number": "FDO211218HB"
#             },
#             {
#                 "action": "stage",
#                 "ip_address": "172.22.150.114",
#                 "logical_name": "cvd-2211-spine",
#                 "policy": "KR5M",
#                 "serial_number": "FOX2109PHDD"
#             },
#             {
#                 "action": "stage",
#                 "ip_address": "172.22.150.107",
#                 "logical_name": "cvd-2312-leaf",
#                 "policy": "KR5M",
#                 "serial_number": "FDO211218AX"
#             },
#             {
#                 "action": "validate",
#                 "ip_address": "172.22.150.106",
#                 "logical_name": "cvd-2311-leaf",
#                 "policy": "KR5M",
#                 "serial_number": "FDO211218HB"
#             },
#             {
#                 "action": "validate",
#                 "ip_address": "172.22.150.114",
#                 "logical_name": "cvd-2211-spine",
#                 "policy": "KR5M",
#                 "serial_number": "FOX2109PHDD"
#             },
#             {
#                 "action": "validate",
#                 "ip_address": "172.22.150.107",
#                 "logical_name": "cvd-2312-leaf",
#                 "policy": "KR5M",
#                 "serial_number": "FDO211218AX"
#             },
#             {
#                 "devices": [
#                     {
#                         "policyName": "KR5M",
#                         "serialNumber": "FDO211218HB"
#                     }
#                 ],
#                 "epldOptions": {
#                     "golden": false,
#                     "moduleNumber": "ALL"
#                 },
#                 "epldUpgrade": false,
#                 "issuUpgrade": true,
#                 "issuUpgradeOptions1": {
#                     "disruptive": true,
#                     "forceNonDisruptive": false,
#                     "nonDisruptive": false
#                 },
#                 "issuUpgradeOptions2": {
#                     "biosForce": false
#                 },
#                 "pacakgeInstall": false,
#                 "pacakgeUnInstall": false,
#                 "reboot": false,
#                 "rebootOptions": {
#                     "configReload": false,
#                     "writeErase": false
#                 }
#             },
#             {
#                 "devices": [
#                     {
#                         "policyName": "KR5M",
#                         "serialNumber": "FDO211218AX"
#                     }
#                 ],
#                 "epldOptions": {
#                     "golden": false,
#                     "moduleNumber": "ALL"
#                 },
#                 "epldUpgrade": false,
#                 "issuUpgrade": true,
#                 "issuUpgradeOptions1": {
#                     "disruptive": true,
#                     "forceNonDisruptive": false,
#                     "nonDisruptive": false
#                 },
#                 "issuUpgradeOptions2": {
#                     "biosForce": false
#                 },
#                 "pacakgeInstall": false,
#                 "pacakgeUnInstall": false,
#                 "reboot": false,
#                 "rebootOptions": {
#                     "configReload": false,
#                     "writeErase": false
#                 }
#             },
#             {
#                 "devices": [
#                     {
#                         "policyName": "KR5M",
#                         "serialNumber": "FOX2109PHDD"
#                     }
#                 ],
#                 "epldOptions": {
#                     "golden": false,
#                     "moduleNumber": "ALL"
#                 },
#                 "epldUpgrade": false,
#                 "issuUpgrade": true,
#                 "issuUpgradeOptions1": {
#                     "disruptive": true,
#                     "forceNonDisruptive": false,
#                     "nonDisruptive": false
#                 },
#                 "issuUpgradeOptions2": {
#                     "biosForce": false
#                 },
#                 "pacakgeInstall": false,
#                 "pacakgeUnInstall": false,
#                 "reboot": false,
#                 "rebootOptions": {
#                     "configReload": false,
#                     "writeErase": false
#                 }
#             }
#         ],
#         "failed": false,
#         "response": [
#             {
#                 "DATA": "[cvd-2311-leaf:Success] [cvd-2312-leaf:Success] [cvd-2211-spine:Success] ",
#                 "MESSAGE": "OK",
#                 "METHOD": "POST",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/policymgnt/attach-policy",
#                 "RETURN_CODE": 200
#             },
#             {
#                 "DATA": [
#                     {
#                         "key": "FDO211218AX",
#                         "value": "No files to stage"
#                     },
#                     {
#                         "key": "FDO211218HB",
#                         "value": "No files to stage"
#                     },
#                     {
#                         "key": "FOX2109PHDD",
#                         "value": "No files to stage"
#                     }
#                 ],
#                 "MESSAGE": "OK",
#                 "METHOD": "POST",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/stagingmanagement/stage-image",
#                 "RETURN_CODE": 200
#             },
#             {
#                 "DATA": "[StageResponse [key=success, value=]]",
#                 "MESSAGE": "OK",
#                 "METHOD": "POST",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/stagingmanagement/validate-image",
#                 "RETURN_CODE": 200
#             },
#             {
#                 "DATA": 63,
#                 "MESSAGE": "OK",
#                 "METHOD": "POST",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/imageupgrade/upgrade-image",
#                 "RETURN_CODE": 200
#             },
#             {
#                 "DATA": 64,
#                 "MESSAGE": "OK",
#                 "METHOD": "POST",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/imageupgrade/upgrade-image",
#                 "RETURN_CODE": 200
#             },
#             {
#                 "DATA": 65,
#                 "MESSAGE": "OK",
#                 "METHOD": "POST",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/imageupgrade/upgrade-image",
#                 "RETURN_CODE": 200
#             }
#         ]
#     }
# }
################################################################################
- name: DELETED - TEST - Upgrade all switches using global config
  cisco.dcnm.dcnm_image_upgrade: &global_config
    state: merged
    config:
        policy: "{{ image_policy_1 }}"
        reboot: false
        stage: true
        validate: true
        upgrade:
            nxos: true
            epld: false
        options:
            nxos:
                mode: disruptive
                bios_force: false
            epld:
                module: ALL
                golden: false
            reboot:
                config_reload: false
                write_erase: false
            package:
                install: false
                uninstall: false
        switches:
          - ip_address: "{{ ansible_switch_1 }}"
          - ip_address: "{{ ansible_switch_2 }}"
          - ip_address: "{{ ansible_switch_3 }}"
  register: result

- debug:
    var: result

- name: DELETED - SETUP - Wait for controller response for all three switches
  cisco.dcnm.dcnm_image_upgrade:
    state: query
    config:
        switches:
        - ip_address: "{{ ansible_switch_1 }}"
        - ip_address: "{{ ansible_switch_2 }}"
        - ip_address: "{{ ansible_switch_3 }}"
  register: result
  until:
    - result.diff[0].ipAddress == ansible_switch_1
    - result.diff[1].ipAddress == ansible_switch_2
    - result.diff[2].ipAddress == ansible_switch_3
  retries: 60
  delay: 5
  ignore_errors: yes

################################################################################
# DELETED - TEST - Detach policies from two switches and verify
################################################################################
# Expected result
# ok: [dcnm] => {
#     "result": {
#         "changed": true,
#         "diff": [
#             {
#                 "action": "detach",
#                 "ip_address": "172.22.150.106",
#                 "logical_name": "cvd-2311-leaf",
#                 "policy_name": "KR5M",
#                 "serial_number": "FDO211218HB"
#             },
#             {
#                 "action": "detach",
#                 "ip_address": "172.22.150.107",
#                 "logical_name": "cvd-2312-leaf",
#                 "policy_name": "KR5M",
#                 "serial_number": "FDO211218AX"
#             }
#         ],
#         "failed": false,
#         "response": [
#             {
#                 "DATA": "Successfully detach the policy from device.",
#                 "MESSAGE": "OK",
#                 "METHOD": "DELETE",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/policymgnt/detach-policy?serialNumber=FDO211218HB,FDO211218AX",
#                 "RETURN_CODE": 200
#             }
#         ]
#     }
# }
################################################################################
- name: DELETED - TEST - Detach policies from two switches
  cisco.dcnm.dcnm_image_upgrade:
        state: deleted
        config:
            policy: "{{ image_policy_1 }}"
            switches:
            - ip_address: "{{ ansible_switch_1 }}"
            - ip_address: "{{ ansible_switch_2 }}"
  register: result

- debug:
    var: result

- assert:
    that:
    - result.changed == true
    - result.failed == false
    - (result.diff | length) == 2
    - (result.response | length) == 1
    - result.diff[0]["action"] == "detach"
    - result.diff[1]["action"] == "detach"
    - result.response[0].RETURN_CODE == 200
    - result.response[0].DATA == "Successfully detach the policy from device."
    - result.response[0].METHOD == "DELETE"

################################################################################
# DELETED - TEST - Detach policies from remaining switch and verify
################################################################################
# Expected result
# ok: [dcnm] => {
#     "result": {
#         "changed": true,
#         "diff": [
#             {
#                 "action": "detach",
#                 "ip_address": "172.22.150.114",
#                 "logical_name": "cvd-2211-spine",
#                 "policy_name": "KR5M",
#                 "serial_number": "FOX2109PHDD"
#             }
#         ],
#         "failed": false,
#         "response": [
#             {
#                 "DATA": "Successfully detach the policy from device.",
#                 "MESSAGE": "OK",
#                 "METHOD": "DELETE",
#                 "REQUEST_PATH": "https://172.22.150.244:443/appcenter/cisco/ndfc/api/v1/imagemanagement/rest/policymgnt/detach-policy?serialNumber=FOX2109PHDD",
#                 "RETURN_CODE": 200
#             }
#         ]
#     }
# }
################################################################################
- name: DELETED - TEST - Detach policy from remaining switch
  cisco.dcnm.dcnm_image_upgrade:
        state: deleted
        config:
            policy: "{{ image_policy_1 }}"
            switches:
            - ip_address: "{{ ansible_switch_3 }}"
  register: result

- debug:
    var: result

- assert:
    that:
    - result.changed == true
    - result.failed == false
    - (result.diff | length) == 1
    - (result.response | length) == 1
    - result.diff[0]["action"] == "detach"
    - result.diff[0]["policy_name"] == image_policy_1
    - result.response[0].RETURN_CODE == 200
    - result.response[0].DATA == "Successfully detach the policy from device."
    - result.response[0].METHOD == "DELETE"

################################################################################
# CLEANUP
################################################################################
# Run 03_cleanup_remove_devices_from_fabric.yaml
# Run 04_cleanup_delete_image_policies.yaml
# Run 05_cleanup_delete_fabric.yaml
################################################################################