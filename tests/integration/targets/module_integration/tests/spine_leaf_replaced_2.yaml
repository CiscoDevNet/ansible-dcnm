---
- name: DEBUG start spine_leaf_replaced_2
  ansible.builtin.debug:
    msg: "Starting dcnm_fabric spine_leaf_replaced_2 test (role_path={{ role_path }})"

- name: INCLUDE vrf list items
  include_vars: ./exec_vars/vrfs.yaml

- name: CLEANUP networks
  cisco.dcnm.dcnm_network:
    fabric: "{{ fabric_name }}"
    state: deleted

- name: CLEANUP vrfs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_name }}"
    state: deleted

- block:
    - name: REPLACE base VRFs
      cisco.dcnm.dcnm_vrf: &base_replace
        fabric: "{{ fabric_name }}"
        state: replaced
        config: "{{ vrfs }}"
      register: base_result
    - name: ASSERT base replace
      ansible.builtin.assert:
        that:
          - base_result.changed
    - name: BASE idempotence
      cisco.dcnm.dcnm_vrf: *base_replace
      register: base_idem
    - name: ASSERT base idempotence
      ansible.builtin.assert:
        that:
          - base_idem.changed == false
    - name: QUERY base
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: base_query
    - name: ASSERT NA
      ansible.builtin.assert:
        that:
          - 'base_query.response|length == 3'
          - 'base_query.response[0].parent.vrfStatus == "NA"'
          - 'base_query.response[1].parent.vrfStatus == "NA"'
          - 'base_query.response[2].parent.vrfStatus == "NA"'

    - name: REPLACE deploy true
      cisco.dcnm.dcnm_vrf: &deploy_true
        fabric: "{{ fabric_name }}"
        state: replaced
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: sales
            vrf_id: 550000
            vlan_id: 501
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
      register: deploy_true_result
    - name: WAIT deployed
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: deploy_true_wait
      until:
        - "deploy_true_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "deploy_true_wait.response[1].parent.vrfStatus is search('DEPLOYED')"
        - "deploy_true_wait.response[2].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5
    - name: ASSERT deployed
      ansible.builtin.assert:
        that:
          - 'deploy_true_wait.response[0].parent.vrfStatus is search("DEPLOYED")'
          - 'deploy_true_wait.response[1].parent.vrfStatus is search("DEPLOYED")'
          - 'deploy_true_wait.response[2].parent.vrfStatus is search("DEPLOYED")'

    - name: REPLACE remove engineering attachments
      cisco.dcnm.dcnm_vrf: &remove_eng
        fabric: "{{ fabric_name }}"
        state: replaced
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            deploy: true
          - vrf_name: sales
            vrf_id: 550000
            vlan_id: 501
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
      register: remove_eng_result
    - name: WAIT after remove engineering attach
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: remove_eng_wait
      until:
        - "remove_eng_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "remove_eng_wait.response[1].parent.vrfStatus is search('DEPLOYED')"
        - "remove_eng_wait.response[2].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5
    - name: ASSERT engineering detach
      ansible.builtin.assert:
        that:
          - 'remove_eng_wait.response[1].attach|length == 0'
          - 'remove_eng_wait.response[0].attach|length == 4'
          - 'remove_eng_wait.response[2].attach|length == 4'

    - name: DELETE green_red
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted
        config:
          - vrf_name: green_red
      register: del_green
    - name: QUERY after delete green_red
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: after_del_green
    - name: ASSERT two left
      ansible.builtin.assert:
        that:
          - 'after_del_green.response|length == 2'
    - name: DELETE sales
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted
        config:
          - vrf_name: sales
      register: del_sales
    - name: QUERY after delete sales
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: after_del_sales
    - name: ASSERT one left
      ansible.builtin.assert:
        that:
          - 'after_del_sales.response|length == 1'

    - name: FINAL cleanup all vrfs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted
  always:
    - name: DEBUG end spine_leaf_replaced_2
      ansible.builtin.debug:
        msg: "End dcnm_fabric spine_leaf_replaced_2 test"
