- name: Start dcnm_fabric spine_leaf_replaced test
  ansible.builtin.debug:
    msg: "Starting dcnm_fabric spine_leaf_replaced test"

- name: Display role path
  ansible.builtin.debug:
    msg: "Role Path {{ role_path }}"

- name: Include VRF list items
  ansible.builtin.include_vars:
    file: ./exec_vars/vrfs.yaml

- name: Cleanup - Delete Networks
  cisco.dcnm.dcnm_network:
    fabric: "{{ fabric_name }}"
    state: deleted

- name: Cleanup - Delete Tenant VRFs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_name }}"
    state: deleted

- name: Execute spine_leaf_replaced workflow
  block:
    - name: Add Tenant VRF objects
      cisco.dcnm.dcnm_vrf: &add_vrfs
        fabric: "{{ fabric_name }}"
        state: replaced
        config: "{{ vrfs }}"
      register: result

    - name: ASSERT - VRF objects created
      ansible.builtin.assert:
        that:
          - 'result.changed == true'
          - 'result.response | length == 3'

    - name: Add Tenant VRF objects - Idempotence
      cisco.dcnm.dcnm_vrf: *add_vrfs
      register: result

    - name: ASSERT - VRF objects idempotence
      ansible.builtin.assert:
        that:
          - 'result.changed == false'

    - name: Query VRF state
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result

    - name: ASSERT - VRF state with no attachments deployed
      ansible.builtin.assert: &vrf_created_no_attach_deploy
        that:
          - 'result.response[0].parent.vrfName == "green_red"'
          - 'result.response[0].parent.vrfId == 470000'
          - 'result.response[0].parent.vrfStatus == "NA"'
          - 'result.response[0].attach | length == 4'
          - 'result.response[0].attach[0].switchDetailsList[0].islanAttached == false'
          - 'result.response[0].attach[1].switchDetailsList[0].islanAttached == false'
          - 'result.response[0].attach[2].switchDetailsList[0].islanAttached == false'
          - 'result.response[0].attach[3].switchDetailsList[0].islanAttached == false'
          - 'result.response[1].parent.vrfName == "engineering"'
          - 'result.response[1].parent.vrfId == 480000'
          - 'result.response[1].parent.vrfStatus == "NA"'
          - 'result.response[1].attach | length == 4'
          - 'result.response[1].attach[0].switchDetailsList[0].islanAttached == false'
          - 'result.response[1].attach[1].switchDetailsList[0].islanAttached == false'
          - 'result.response[1].attach[2].switchDetailsList[0].islanAttached == false'
          - 'result.response[1].attach[3].switchDetailsList[0].islanAttached == false'
          - 'result.response[2].parent.vrfName == "sales"'
          - 'result.response[2].parent.vrfId == 550000'
          - 'result.response[2].parent.vrfStatus == "NA"'
          - 'result.response[2].attach | length == 4'
          - 'result.response[2].attach[0].switchDetailsList[0].islanAttached == false'
          - 'result.response[2].attach[1].switchDetailsList[0].islanAttached == false'
          - 'result.response[2].attach[2].switchDetailsList[0].islanAttached == false'
          - 'result.response[2].attach[3].switchDetailsList[0].islanAttached == false'

    - name: Specify attachments with global deploy disabled
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: replaced
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
          - vrf_name: sales
            vrf_id: 550000
            vlan_id: 501
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
      register: result

    - name: Query VRF state after deploy false
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result

    - name: ASSERT - VRF state remains not deployed
      ansible.builtin.assert: *vrf_created_no_attach_deploy

    - name: Specify attachments with global deploy enabled
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: replaced
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: sales
            vrf_id: 550000
            vlan_id: 501
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
      register: result

    - name: ASSERT - Deploy true results changed
      ansible.builtin.assert:
        that:
          - 'result.changed == true'

    - name: Query VRF state until deployed (all VRFs)
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result
      until:
        - "result.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "result.response[1].parent.vrfStatus is search('DEPLOYED')"
        - "result.response[2].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5

    - name: Query VRF state after deploy true
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result

    - name: ASSERT - VRFs deployed with attachments
      ansible.builtin.assert:
        that:
          - 'result.response[0].parent.vrfName == "green_red"'
          - 'result.response[0].parent.vrfId == 470000'
          - "result.response[0].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[0].attach | length == 4'
          - 'result.response[0].attach[0].switchDetailsList[0].islanAttached == true'
          - 'result.response[0].attach[1].switchDetailsList[0].islanAttached == true'
          - 'result.response[0].attach[2].switchDetailsList[0].islanAttached == true'
          - 'result.response[0].attach[3].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].parent.vrfName == "engineering"'
          - 'result.response[1].parent.vrfId == 480000'
          - "result.response[1].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[1].attach | length == 4'
          - 'result.response[1].attach[0].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].attach[1].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].attach[2].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].attach[3].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].parent.vrfName == "sales"'
          - 'result.response[2].parent.vrfId == 550000'
          - "result.response[2].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[2].attach | length == 4'
          - 'result.response[2].attach[0].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].attach[1].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].attach[2].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].attach[3].switchDetailsList[0].islanAttached == true'

    - name: Cleanup - Delete Tenant VRFs after deploy true
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted

    - name: Add VRFs with per-attachment deploy overrides
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: replaced
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
                deploy: true
              - ip_address: "{{ leaf2 }}"
                deploy: true
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
                deploy: false
              - ip_address: "{{ leaf2 }}"
                deploy: false
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true

    - name: Query VRF state until targeted deploy complete
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result
      until:
        - "result.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "result.response[1].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5

    - name: Query VRF state after targeted deploy
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result

    - name: ASSERT - Targeted deploy results
      ansible.builtin.assert:
        that:
          - 'result.response[0].parent.vrfName == "green_red"'
          - 'result.response[0].parent.vrfId == 470000'
          - "result.response[0].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[1].parent.vrfName == "engineering"'
          - 'result.response[1].parent.vrfId == 480000'
          - "result.response[1].parent.vrfStatus is search('DEPLOYED')"

    - name: Cleanup - Delete Tenant VRFs (post targeted deploy)
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted

    - name: Add VRFs allowing DCNM to auto-select IDs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: replaced
        config:
          - vrf_name: green_red
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: engineering
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: sales
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
      register: result

    - name: Query VRF state until auto-selected deploy completes
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result
      until:
        - "result.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "result.response[1].parent.vrfStatus is search('DEPLOYED')"
        - "result.response[2].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5

    - name: Query VRF state after auto-selected deploy
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: result

    - name: ASSERT - Auto-selected VRFs deployed
      ansible.builtin.assert:
        that:
          - 'result.response[0].parent.vrfName == "green_red"'
          - "result.response[0].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[0].attach | length == 4'
          - 'result.response[0].attach[0].switchDetailsList[0].islanAttached == true'
          - 'result.response[0].attach[1].switchDetailsList[0].islanAttached == true'
          - 'result.response[0].attach[2].switchDetailsList[0].islanAttached == true'
          - 'result.response[0].attach[3].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].parent.vrfName == "engineering"'
          - "result.response[1].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[1].attach | length == 4'
          - 'result.response[1].attach[0].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].attach[1].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].attach[2].switchDetailsList[0].islanAttached == true'
          - 'result.response[1].attach[3].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].parent.vrfName == "sales"'
          - "result.response[2].parent.vrfStatus is search('DEPLOYED')"
          - 'result.response[2].attach | length == 4'
          - 'result.response[2].attach[0].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].attach[1].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].attach[2].switchDetailsList[0].islanAttached == true'
          - 'result.response[2].attach[3].switchDetailsList[0].islanAttached == true'
  always:
    - name: End dcnm_fabric spine_leaf_replaced test
      ansible.builtin.debug:
        msg: "End dcnm_fabric spine_leaf_replaced test"
