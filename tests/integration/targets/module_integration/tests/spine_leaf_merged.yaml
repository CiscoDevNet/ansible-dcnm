---
- name: DEBUG start spine_leaf_merged
  ansible.builtin.debug:
    msg: "Starting dcnm_fabric spine_leaf_merged test (role_path={{ role_path }})"

- name: INCLUDE vrf list items
  include_vars: ./exec_vars/vrfs.yaml

- name: CLEANUP networks
  cisco.dcnm.dcnm_network:
    fabric: "{{ fabric_name }}"
    state: deleted

- name: CLEANUP vrfs
  cisco.dcnm.dcnm_vrf:
    fabric: "{{ fabric_name }}"
    state: deleted

- block:
    ##############################################
    ## 1. Add base VRF objects (no deploy)      ##
    ##############################################
    - name: MERGE base VRFs
      cisco.dcnm.dcnm_vrf: &base_vrfs
        fabric: "{{ fabric_name }}"
        state: merged
        config: "{{ vrfs }}"
      register: base_result
    - name: ASSERT base merge
      ansible.builtin.assert:
        that:
          - 'base_result.changed'
    - name: BASE idempotence
      cisco.dcnm.dcnm_vrf: *base_vrfs
      register: base_idem
    - name: ASSERT base idempotence
      ansible.builtin.assert:
        that:
          - 'base_idem.changed == false'
    - name: QUERY base VRFs
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: base_query
    - name: ASSERT base NA state
      ansible.builtin.assert:
        that:
          - 'base_query.response|length == 3'
          - 'base_query.response[0].parent.vrfStatus == "NA"'
          - 'base_query.response[1].parent.vrfStatus == "NA"'
          - 'base_query.response[2].parent.vrfStatus == "NA"'

    ##############################################
    ## 2. Attach all leaves deploy false        ##
    ##############################################
    - name: MERGE attach all leaves deploy false
      cisco.dcnm.dcnm_vrf: &attach_false
        fabric: "{{ fabric_name }}"
        state: merged
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
          - vrf_name: sales
            vrf_id: 550000
            vlan_id: 501
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: false
      register: attach_false_result
    - name: ASSERT attach false
      ansible.builtin.assert:
        that:
          - 'attach_false_result.changed'
    - name: QUERY attach false
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: attach_false_query
    - name: ASSERT still NA
      ansible.builtin.assert:
        that:
          - 'attach_false_query.response[0].parent.vrfStatus == "NA"'
          - 'attach_false_query.response[1].parent.vrfStatus == "NA"'
          - 'attach_false_query.response[2].parent.vrfStatus == "NA"'

    ##############################################
    ## 3. Attach & deploy true                  ##
    ##############################################
    - name: MERGE attach all leaves deploy true
      cisco.dcnm.dcnm_vrf: &attach_true
        fabric: "{{ fabric_name }}"
        state: merged
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: sales
            vrf_id: 550000
            vlan_id: 501
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
      register: attach_true_result
    - name: ASSERT attach true
      ansible.builtin.assert:
        that:
          - 'attach_true_result.changed'
    - name: WAIT until all DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: attach_true_wait
      until:
        - "attach_true_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "attach_true_wait.response[1].parent.vrfStatus is search('DEPLOYED')"
        - "attach_true_wait.response[2].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5
    - name: ASSERT deployed state
      ansible.builtin.assert:
        that:
          - 'attach_true_wait.response[0].parent.vrfStatus is search("DEPLOYED")'
          - 'attach_true_wait.response[1].parent.vrfStatus is search("DEPLOYED")'
          - 'attach_true_wait.response[2].parent.vrfStatus is search("DEPLOYED")'

    ##############################################
    ## 4. Mixed per-attach deploy overrides     ##
    ##############################################
    - name: CLEANUP vrfs mid-cycle
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted
    - name: MERGE mixed per-attach deploy
      cisco.dcnm.dcnm_vrf: &mixed_deploy
        fabric: "{{ fabric_name }}"
        state: merged
        config:
          - vrf_name: green_red
            vrf_id: 470000
            vlan_id: 201
            attach:
              - ip_address: "{{ leaf1 }}"
                deploy: true
              - ip_address: "{{ leaf2 }}"
                deploy: true
              - ip_address: "{{ leaf3 }}"
                deploy: false
              - ip_address: "{{ leaf4 }}"
                deploy: false
            deploy: false
          - vrf_name: engineering
            vrf_id: 480000
            vlan_id: 401
            attach:
              - ip_address: "{{ leaf1 }}"
                deploy: false
              - ip_address: "{{ leaf2 }}"
                deploy: false
              - ip_address: "{{ leaf3 }}"
                deploy: true
              - ip_address: "{{ leaf4 }}"
                deploy: true
            deploy: false
        register: mixed_result  # This line intentionally kept? actually should be outside config, keep original placement
      register: mixed_result
    - name: WAIT mixed deploy
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: mixed_wait
      until:
        - "mixed_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "mixed_wait.response[1].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5
    - name: ASSERT mixed deploy
      ansible.builtin.assert:
        that:
          - 'mixed_wait.response[0].parent.vrfStatus is search("DEPLOYED")'
          - 'mixed_wait.response[1].parent.vrfStatus is search("DEPLOYED")'

    ##############################################
    ## 5. Autoselection of vrf_id/vlan_id       ##
    ##############################################
    - name: CLEANUP vrfs before autoselect
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: deleted
    - name: MERGE vrfs autoselect ids
      cisco.dcnm.dcnm_vrf: &auto_vrfs
        fabric: "{{ fabric_name }}"
        state: merged
        config:
          - vrf_name: green_red
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: engineering
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
          - vrf_name: sales
            attach:
              - ip_address: "{{ leaf1 }}"
              - ip_address: "{{ leaf2 }}"
              - ip_address: "{{ leaf3 }}"
              - ip_address: "{{ leaf4 }}"
            deploy: true
      register: auto_result
    - name: WAIT auto DEPLOYED
      cisco.dcnm.dcnm_vrf:
        fabric: "{{ fabric_name }}"
        state: query
      register: auto_wait
      until:
        - "auto_wait.response[0].parent.vrfStatus is search('DEPLOYED')"
        - "auto_wait.response[1].parent.vrfStatus is search('DEPLOYED')"
        - "auto_wait.response[2].parent.vrfStatus is search('DEPLOYED')"
      retries: 20
      delay: 5
    - name: ASSERT auto deploy
      ansible.builtin.assert:
        that:
          - 'auto_wait.response[0].attach|length == 4'
          - 'auto_wait.response[1].attach|length == 4'
          - 'auto_wait.response[2].attach|length == 4'

  always:
    - name: DEBUG end spine_leaf_merged
      ansible.builtin.debug:
        msg: "End dcnm_fabric spine_leaf_merged test"
