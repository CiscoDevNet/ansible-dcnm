##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f sp.log

- name: Delete service policies (ensure clean slate)
  cisco.dcnm.dcnm_service_policy: &sp_delete_all
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
    config:
      - { name: service_policy_1, node_name: "{{ ansible_snode_1 }}" }
      - { name: service_policy_2, node_name: "{{ ansible_snode_2 }}" }
      - { name: service_policy_3, node_name: "{{ ansible_snode_2 }}" }
      - { name: service_policy_4, node_name: "{{ ansible_snode_2 }}" }
      - { name: service_policy_5, node_name: "{{ ansible_snode_2 }}" }
  register: init_delete_result

- name: Assert initial delete responses
  ansible.builtin.assert:
    that:
      - 'item["RETURN_CODE"] == 200'
    loop: '{{ init_delete_result.response }}'

- block:

##############################################
##        CREATE ALL (FULL OPTIONS)         ##
##############################################

    - name: Create 5 service policies with all options
      cisco.dcnm.dcnm_service_policy: &sp_full_create
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        attach: true
        deploy: true
        state: merged
        config:
          - name: service_policy_1
            node_name: "{{ ansible_snode_1 }}"
            rp_name: "{{ ansible_fw_rp1 }}"
            src_vrf: "{{ ansible_vrf_11 }}"
            dest_vrf: "{{ ansible_vrf_11 }}"
            src_network: "{{ ansible_net_11 }}"
            dest_network: "{{ ansible_net_12 }}"
            next_hop: 192.161.1.100
            reverse_next_hop: 192.161.2.100
            reverse: false
            policy:
              src_port: any
              dest_port: 22
              action: permit
              next_hop_option: none
              acl_name: fwd_acl_10
              reverse_acl_name: rev_acl_10
              route_map_num: 101
              reverse_route_map_num: 102
          - name: service_policy_2
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp4 }}"
            src_vrf: "{{ ansible_vrf_21 }}"
            dest_vrf: "{{ ansible_vrf_21 }}"
            src_network: "{{ ansible_net_21 }}"
            dest_network: "{{ ansible_net_22 }}"
            next_hop: ""
            reverse_next_hop: 192.164.1.100
            policy:
              proto: udp
              src_port: 2000
              dest_port: 2001
              action: permit
              next_hop_option: drop_on_fail
              acl_name: fwd_acl_20
              reverse_acl_name: rev_acl_20
              route_map_num: 201
              reverse_route_map_num: 202
          - name: service_policy_3
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp5 }}"
            src_vrf: "{{ ansible_vrf_31 }}"
            dest_vrf: "{{ ansible_vrf_31 }}"
            src_network: "{{ ansible_net_31 }}"
            dest_network: "{{ ansible_net_32 }}"
            next_hop: ""
            reverse_next_hop: 192.165.2.100
            reverse: true
            policy:
              proto: ip
              src_port: 3000
              dest_port: 3001
              action: permit
              next_hop_option: drop
              acl_name: fwd_acl_30
              reverse_acl_name: rev_acl_30
              route_map_num: 301
              reverse_route_map_num: 302
          - name: service_policy_4
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp6 }}"
            src_vrf: "{{ ansible_vrf_41 }}"
            dest_vrf: "{{ ansible_vrf_41 }}"
            src_network: "{{ ansible_net_41 }}"
            dest_network: "{{ ansible_net_42 }}"
            next_hop: ""
            reverse_next_hop: 192.166.2.100
            policy:
              proto: tcp
              src_port: 4000
              dest_port: 4001
              action: permit
              next_hop_option: drop
              acl_name: fwd_acl_40
              reverse_acl_name: rev_acl_40
              route_map_num: 401
              reverse_route_map_num: 402
          - name: service_policy_5
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp6 }}"
            src_vrf: "{{ ansible_vrf_41 }}"
            dest_vrf: "{{ ansible_vrf_41 }}"
            src_network: "{{ ansible_net_41 }}"
            dest_network: "{{ ansible_net_42 }}"
            next_hop: ""
            reverse_next_hop: 192.166.2.100
            policy:
              proto: icmp
              src_port: 5000
              dest_port: 5001
              action: permit
              next_hop_option: drop
              acl_name: fwd_acl_50
              reverse_acl_name: rev_acl_50
              route_map_num: 501
              reverse_route_map_num: 502
      register: create_all_result

    - name: Assert create all diff
      ansible.builtin.assert:
        that:
          - 'create_all_result.changed == true'
          - '(create_all_result.diff[0].merged | length) == 5'
          - '(create_all_result.diff[0].deleted | length) == 0'
          - '(create_all_result.diff[0].modified | length) == 0'
          - '(create_all_result.diff[0].query | length) == 0'
          - '(create_all_result.diff[0].deploy | length) == 5'

    - name: Assert create all responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
        loop: '{{ create_all_result.response }}'

    - name: Idempotence check create all
      cisco.dcnm.dcnm_service_policy: *sp_full_create
      register: create_all_idem

    - name: Assert create all idempotence
      ansible.builtin.assert:
        that:
          - 'create_all_idem.changed == false'
          - '(create_all_idem.diff[0].merged | length) == 0'
          - '(create_all_idem.diff[0].deploy | length) == 0'

##############################################
##        DELETE SUBSET THEN RECREATE       ##
##############################################

    - name: Delete subset of service policies (1-3)
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: deleted
        config:
          - { name: service_policy_1, node_name: "{{ ansible_snode_1 }}" }
          - { name: service_policy_2, node_name: "{{ ansible_snode_2 }}" }
          - { name: service_policy_3, node_name: "{{ ansible_snode_2 }}" }
      register: delete_subset_result

    - name: Assert delete subset diff
      ansible.builtin.assert:
        that:
          - 'delete_subset_result.changed == true'
          - '(delete_subset_result.diff[0].deleted | length) == 3'
          - '(delete_subset_result.diff[0].merged | length) == 0'
          - '(delete_subset_result.diff[0].deploy | length) == 0'

    - name: Assert delete subset responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
        loop: '{{ delete_subset_result.response }}'

    - name: Recreate two minimal policies (1,2)
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: merged
        attach: true
        deploy: true
        config:
          - name: service_policy_1
            node_name: "{{ ansible_snode_1 }}"
            rp_name: "{{ ansible_fw_rp1 }}"
            src_vrf: "{{ ansible_vrf_11 }}"
            dest_vrf: "{{ ansible_vrf_11 }}"
            src_network: "{{ ansible_net_11 }}"
            dest_network: "{{ ansible_net_12 }}"
            next_hop: 192.161.1.100
            reverse_next_hop: 192.161.2.100
            policy:
              src_port: any
              dest_port: 22
          - name: service_policy_2
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp4 }}"
            src_vrf: "{{ ansible_vrf_21 }}"
            dest_vrf: "{{ ansible_vrf_21 }}"
            src_network: "{{ ansible_net_21 }}"
            dest_network: "{{ ansible_net_22 }}"
            next_hop: ""
            reverse_next_hop: 192.164.1.100
            policy:
              proto: udp
              src_port: 2000
              dest_port: 2001
              action: permit
              next_hop_option: drop
      register: recreate_min_result

    - name: Assert recreate minimal diff
      ansible.builtin.assert:
        that:
          - 'recreate_min_result.changed == true'
          - '(recreate_min_result.diff[0].merged | length) == 2'
          - '(recreate_min_result.diff[0].deploy | length) == 2'

    - name: Assert recreate minimal responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
        loop: '{{ recreate_min_result.response }}'

##############################################
##        CREATE WITHOUT DEPLOY / WITH      ##
##############################################

    - name: Create policy 3 without deploy
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: merged
        attach: true
        deploy: false
        config:
          - name: service_policy_3
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp5 }}"
            src_vrf: "{{ ansible_vrf_31 }}"
            dest_vrf: "{{ ansible_vrf_31 }}"
            src_network: "{{ ansible_net_31 }}"
            dest_network: "{{ ansible_net_32 }}"
            next_hop: ""
            reverse_next_hop: 192.165.2.100
            policy:
              src_port: 3000
              dest_port: 3001
              action: permit
              next_hop_option: drop
              acl_name: fwd_acl_30
              reverse_acl_name: rev_acl_30
              route_map_num: 301
              reverse_route_map_num: 302
      register: create_no_deploy_result

    - name: Assert create no-deploy diff
      ansible.builtin.assert:
        that:
          - 'create_no_deploy_result.changed == true'
          - '(create_no_deploy_result.diff[0].merged | length) == 1'
          - '(create_no_deploy_result.diff[0].deploy | length) == 0'

    - name: Create policy 3 with deploy
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: merged
        attach: true
        deploy: true
        config:
          - name: service_policy_3
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp5 }}"
            src_vrf: "{{ ansible_vrf_31 }}"
            dest_vrf: "{{ ansible_vrf_31 }}"
            src_network: "{{ ansible_net_31 }}"
            dest_network: "{{ ansible_net_32 }}"
            next_hop: ""
            reverse_next_hop: 192.165.2.100
            policy:
              src_port: 3000
              dest_port: 3001
              action: permit
              next_hop_option: drop
              acl_name: fwd_acl_30
              reverse_acl_name: rev_acl_30
              route_map_num: 301
              reverse_route_map_num: 302
      register: create_with_deploy_result

    - name: Assert create with deploy diff
      ansible.builtin.assert:
        that:
          - 'create_with_deploy_result.changed == true'
          - '(create_with_deploy_result.diff[0].deploy | length) == 1'

##############################################
##              MODIFY EXISTING             ##
##############################################

    - name: Modify service_policy_4 ports only
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: merged
        attach: true
        deploy: true
        config:
          - name: service_policy_4
            node_name: "{{ ansible_snode_2 }}"
            rp_name: "{{ ansible_adc_rp6 }}"
            src_vrf: "{{ ansible_vrf_41 }}"
            dest_vrf: "{{ ansible_vrf_41 }}"
            src_network: "{{ ansible_net_41 }}"
            dest_network: "{{ ansible_net_42 }}"
            next_hop: ""
            reverse_next_hop: 192.166.2.100
            policy:
              src_port: 4400
              dest_port: 4401
      register: modify_result

    - name: Assert modify diff
      ansible.builtin.assert:
        that:
          - 'modify_result.changed == true'
          - '(modify_result.diff[0].modified | length) == 1'
          - '(modify_result.diff[0].deploy | length) == 1'

##############################################
##                CLEANUP                   ##
##############################################

  always:
    - name: Final delete of all service policies
      cisco.dcnm.dcnm_service_policy: *sp_delete_all
      register: final_delete_result

    - name: Assert final delete responses
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
        loop: '{{ final_delete_result.response }}'
