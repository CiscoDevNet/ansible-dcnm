##############################################
## dcnm_service_policy_overridden.yaml (Refactored)
## Focus: override semantics (delete-all, modify subset)
##############################################

- name: OVERRIDDEN SETUP - ensure no existing policies
  cisco.dcnm.dcnm_service_policy:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
    config:
      - name: service_policy_1
        node_name: "{{ ansible_snode_1 }}"
      - name: service_policy_2
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_3
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_4
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_5
        node_name: "{{ ansible_snode_2 }}"
  register: init_delete_result

- name: ASSERT setup responses
  ansible.builtin.assert:
    that: ['item["RETURN_CODE"] == 200']
  loop: "{{ init_delete_result.response }}"

- block:
  ##############################################
  ## MERGE - create 5 policies
  ##############################################
    - name: MERGE create five policies
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      attach: true
      deploy: true
      state: merged
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
          rp_name: "{{ ansible_fw_rp1 }}"
          src_vrf: "{{ ansible_vrf_11 }}"
          dest_vrf: "{{ ansible_vrf_11 }}"
          src_network: "{{ ansible_net_11 }}"
          dest_network: "{{ ansible_net_12 }}"
          next_hop: 192.161.1.100
          reverse_next_hop: 192.161.2.100
          policy: { src_port: any, dest_port: 22, action: permit, next_hop_option: none }
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp4 }}"
          src_vrf: "{{ ansible_vrf_21 }}"
          dest_vrf: "{{ ansible_vrf_21 }}"
          src_network: "{{ ansible_net_21 }}"
          dest_network: "{{ ansible_net_22 }}"
          next_hop: ""
          reverse_next_hop: 192.164.1.100
          policy: { proto: udp, src_port: 2000, dest_port: 2001, action: permit, next_hop_option: drop_on_fail }
        - name: service_policy_3
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp5 }}"
          src_vrf: "{{ ansible_vrf_31 }}"
          dest_vrf: "{{ ansible_vrf_31 }}"
          src_network: "{{ ansible_net_31 }}"
          dest_network: "{{ ansible_net_32 }}"
          next_hop: ""
          reverse_next_hop: 192.165.2.100
          policy: { proto: ip, src_port: 3000, dest_port: 3001, action: permit, next_hop_option: drop }
        - name: service_policy_4
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp6 }}"
          src_vrf: "{{ ansible_vrf_41 }}"
          dest_vrf: "{{ ansible_vrf_41 }}"
          src_network: "{{ ansible_net_41 }}"
          dest_network: "{{ ansible_net_42 }}"
          next_hop: ""
          reverse_next_hop: 192.166.2.100
          policy: { proto: tcp, src_port: 4000, dest_port: 4001, action: permit, next_hop_option: drop }
        - name: service_policy_5
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp6 }}"
          src_vrf: "{{ ansible_vrf_41 }}"
          dest_vrf: "{{ ansible_vrf_41 }}"
          src_network: "{{ ansible_net_41 }}"
          dest_network: "{{ ansible_net_42 }}"
          next_hop: ""
          reverse_next_hop: 192.166.2.100
          policy: { proto: icmp, src_port: 5000, dest_port: 5001, action: permit, next_hop_option: drop }
    register: merge_all_result

  - name: ASSERT merge all
    ansible.builtin.assert:
      that:
        - merge_all_result.changed
        - '(merge_all_result.diff[0].merged | length) == 5'
        - '(merge_all_result.diff[0].deploy | length) == 5'
  - name: ASSERT merge responses
    ansible.builtin.assert:
      that: ['item["RETURN_CODE"] == 200']
    loop: "{{ merge_all_result.response }}"

  ##############################################
  ## OVERRIDE delete all (empty config)
  ##############################################
  - name: OVERRIDE remove all with empty config
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: overridden
    register: override_delete_all

  - name: ASSERT override delete all
    ansible.builtin.assert:
      that:
        - override_delete_all.changed
        - '(override_delete_all.diff[0].deleted | length) == 5'
        - '(override_delete_all.diff[0].merged | length) == 0'

  ##############################################
  ## MERGE recreate all again
  ##############################################
  - name: MERGE recreate all policies
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: merged
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
          rp_name: "{{ ansible_fw_rp1 }}"
          src_vrf: "{{ ansible_vrf_11 }}"
          dest_vrf: "{{ ansible_vrf_11 }}"
          src_network: "{{ ansible_net_11 }}"
          dest_network: "{{ ansible_net_12 }}"
          next_hop: 192.161.1.100
          reverse_next_hop: 192.161.2.100
          policy: { src_port: any, dest_port: 22, action: permit }
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp4 }}"
          src_vrf: "{{ ansible_vrf_21 }}"
          dest_vrf: "{{ ansible_vrf_21 }}"
          src_network: "{{ ansible_net_21 }}"
          dest_network: "{{ ansible_net_22 }}"
          next_hop: ""
          reverse_next_hop: 192.164.1.100
          policy: { proto: udp, src_port: 2000, dest_port: 2001, action: permit }
        - name: service_policy_3
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp5 }}"
          src_vrf: "{{ ansible_vrf_31 }}"
          dest_vrf: "{{ ansible_vrf_31 }}"
          src_network: "{{ ansible_net_31 }}"
          dest_network: "{{ ansible_net_32 }}"
          next_hop: ""
          reverse_next_hop: 192.165.2.100
          policy: { proto: ip, src_port: 3000, dest_port: 3001, action: permit }
        - name: service_policy_4
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp6 }}"
          src_vrf: "{{ ansible_vrf_41 }}"
          dest_vrf: "{{ ansible_vrf_41 }}"
          src_network: "{{ ansible_net_41 }}"
          dest_network: "{{ ansible_net_42 }}"
          next_hop: ""
          reverse_next_hop: 192.166.2.100
          policy: { proto: tcp, src_port: 4000, dest_port: 4001, action: permit }
        - name: service_policy_5
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp6 }}"
          src_vrf: "{{ ansible_vrf_41 }}"
          dest_vrf: "{{ ansible_vrf_41 }}"
          src_network: "{{ ansible_net_41 }}"
          dest_network: "{{ ansible_net_42 }}"
          next_hop: ""
          reverse_next_hop: 192.166.2.100
          policy: { proto: icmp, src_port: 5000, dest_port: 5001, action: permit }
    register: recreate_all_result

  - name: ASSERT recreate all
    ansible.builtin.assert:
      that:
        - recreate_all_result.changed
        - '(recreate_all_result.diff[0].merged | length) == 5'

  ##############################################
  ## OVERRIDE modify one & delete rest
  ##############################################
  - name: OVERRIDE modify one delete rest
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: overridden
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
          rp_name: "{{ ansible_fw_rp1 }}"
          src_vrf: "{{ ansible_vrf_11 }}"
          dest_vrf: "{{ ansible_vrf_11 }}"
          src_network: "{{ ansible_net_11 }}"
          dest_network: "{{ ansible_net_12 }}"
          next_hop: 192.161.1.100
          reverse_next_hop: 192.161.2.100
          policy:
            src_port: 555
            dest_port: 22
            action: permit
            next_hop_option: none
    register: override_modify_result
  - name: ASSERT override modify
    ansible.builtin.assert:
      that:
        - override_modify_result.changed
        - '(override_modify_result.diff[0].deleted | length) == 4'
        - '(override_modify_result.diff[0].modified | length) == 1'
        - '(override_modify_result.diff[0].merged | length) == 0'

  always:
    - name: ALWAYS cleanup override file
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: deleted
      register: override_cleanup
    - name: ASSERT cleanup responses
      ansible.builtin.assert:
        that: ['item["RETURN_CODE"] == 200']
      loop: "{{ override_cleanup.response }}"
