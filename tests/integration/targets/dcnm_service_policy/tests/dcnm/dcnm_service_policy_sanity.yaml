##############################################
## dcnm_service_policy_sanity.yaml (Refactored)
## Combined sanity scenarios: create/idempotence/query/override/replace
##############################################

- name: SANITY SETUP delete any pre-existing policies
  cisco.dcnm.dcnm_service_policy:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
    config:
      - name: service_policy_1
        node_name: "{{ ansible_snode_1 }}"
      - name: service_policy_2
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_3
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_4
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_5
        node_name: "{{ ansible_snode_2 }}"
  register: sanity_delete_init

- name: ASSERT setup responses
  ansible.builtin.assert:
    that: ['item["RETURN_CODE"] == 200']
  loop: "{{ sanity_delete_init.response }}"

- block:
  ##############################################
  ## MERGE create all & idempotence
  ##############################################
    - name: SANITY MERGE create all
    cisco.dcnm.dcnm_service_policy: &sanity_merge_all
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: merged
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
          rp_name: "{{ ansible_fw_rp1 }}"
          src_vrf: "{{ ansible_vrf_11 }}"
          dest_vrf: "{{ ansible_vrf_11 }}"
          src_network: "{{ ansible_net_11 }}"
          dest_network: "{{ ansible_net_12 }}"
          next_hop: 192.161.1.100
          reverse_next_hop: 192.161.2.100
          policy: { src_port: any, dest_port: 22, action: permit }
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp4 }}"
          src_vrf: "{{ ansible_vrf_21 }}"
          dest_vrf: "{{ ansible_vrf_21 }}"
          src_network: "{{ ansible_net_21 }}"
          dest_network: "{{ ansible_net_22 }}"
          next_hop: ""
          reverse_next_hop: 192.164.1.100
          policy: { proto: udp, src_port: 2000, dest_port: 2001, action: permit }
        - name: service_policy_3
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp5 }}"
          src_vrf: "{{ ansible_vrf_31 }}"
          dest_vrf: "{{ ansible_vrf_31 }}"
          src_network: "{{ ansible_net_31 }}"
          dest_network: "{{ ansible_net_32 }}"
          next_hop: ""
          reverse_next_hop: 192.165.2.100
          policy: { proto: ip, src_port: 3000, dest_port: 3001, action: permit }
        - name: service_policy_4
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp6 }}"
          src_vrf: "{{ ansible_vrf_41 }}"
          dest_vrf: "{{ ansible_vrf_41 }}"
          src_network: "{{ ansible_net_41 }}"
          dest_network: "{{ ansible_net_42 }}"
          next_hop: ""
          reverse_next_hop: 192.166.2.100
          policy: { proto: tcp, src_port: 4000, dest_port: 4001, action: permit }
        - name: service_policy_5
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp6 }}"
          src_vrf: "{{ ansible_vrf_41 }}"
          dest_vrf: "{{ ansible_vrf_41 }}"
          src_network: "{{ ansible_net_41 }}"
          dest_network: "{{ ansible_net_42 }}"
          next_hop: ""
          reverse_next_hop: 192.166.2.100
          policy: { proto: icmp, src_port: 5000, dest_port: 5001, action: permit }
    register: sanity_merge_result
  - name: ASSERT sanity merge
    ansible.builtin.assert:
      that:
        - sanity_merge_result.changed
        - '(sanity_merge_result.diff[0].merged | length) == 5'

  - name: SANITY MERGE idempotence
    cisco.dcnm.dcnm_service_policy: *sanity_merge_all
    register: sanity_merge_idem
  - name: ASSERT sanity idempotence
    ansible.builtin.assert:
      that:
        - 'sanity_merge_idem.changed == false'
        - '(sanity_merge_idem.diff[0].merged | length) == 0'

  ##############################################
  ## QUERY existing
  ##############################################
  - name: SANITY QUERY all by name+node
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: query
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
        - name: service_policy_3
          node_name: "{{ ansible_snode_2 }}"
        - name: service_policy_4
          node_name: "{{ ansible_snode_2 }}"
        - name: service_policy_5
          node_name: "{{ ansible_snode_2 }}"
    register: sanity_query_all
  - name: ASSERT sanity query all
    ansible.builtin.assert:
      that:
        - 'sanity_query_all.changed == false'
        - '(sanity_query_all.diff[0].query | length) == 5'
        - '(sanity_query_all.response | length) == 5'

  ##############################################
  ## OVERRIDE delete all
  ##############################################
  - name: SANITY OVERRIDE delete all
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: overridden
    register: sanity_override_delete
  - name: ASSERT override delete
    ansible.builtin.assert:
      that:
        - sanity_override_delete.changed
        - '(sanity_override_delete.diff[0].deleted | length) == 5'

  ##############################################
  ## MERGE minimal recreate (two policies)
  ##############################################
  - name: SANITY MERGE minimal recreate
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: merged
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
          rp_name: "{{ ansible_fw_rp1 }}"
          src_vrf: "{{ ansible_vrf_11 }}"
          dest_vrf: "{{ ansible_vrf_11 }}"
          src_network: "{{ ansible_net_11 }}"
          dest_network: "{{ ansible_net_12 }}"
          next_hop: 192.161.1.100
          reverse_next_hop: 192.161.2.100
          policy: { src_port: any, dest_port: 22, action: permit }
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp4 }}"
          src_vrf: "{{ ansible_vrf_21 }}"
          dest_vrf: "{{ ansible_vrf_21 }}"
          src_network: "{{ ansible_net_21 }}"
          dest_network: "{{ ansible_net_22 }}"
          next_hop: ""
          reverse_next_hop: 192.164.1.100
          policy: { proto: udp, src_port: 2000, dest_port: 2001, action: permit }
    register: sanity_min_recreate
  - name: ASSERT min recreate
    ansible.builtin.assert:
      that:
        - sanity_min_recreate.changed
        - '(sanity_min_recreate.diff[0].merged | length) == 2'

  ##############################################
  ## REPLACE modify both minimal policies
  ##############################################
  - name: SANITY REPLACE modify minimal
    cisco.dcnm.dcnm_service_policy: &sanity_replace_min
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: replaced
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
          rp_name: "{{ ansible_fw_rp1 }}"
          src_vrf: "{{ ansible_vrf_11 }}"
          dest_vrf: "{{ ansible_vrf_11 }}"
          src_network: "{{ ansible_net_11 }}"
          dest_network: "{{ ansible_net_12 }}"
          next_hop: 192.161.1.100
          reverse_next_hop: 192.161.2.100
          policy: { src_port: 501, dest_port: 502, action: deny }
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
          rp_name: "{{ ansible_adc_rp4 }}"
          src_vrf: "{{ ansible_vrf_21 }}"
          dest_vrf: "{{ ansible_vrf_21 }}"
          src_network: "{{ ansible_net_21 }}"
          dest_network: "{{ ansible_net_22 }}"
          next_hop: ""
          reverse_next_hop: 192.164.1.100
          policy: { proto: tcp, src_port: 5000, dest_port: 5001, action: permit }
    register: sanity_replace_result
  - name: ASSERT replace minimal modified
    ansible.builtin.assert:
      that:
        - sanity_replace_result.changed
        - '(sanity_replace_result.diff[0].modified | length) == 2'

  - name: SANITY REPLACE idempotence
    cisco.dcnm.dcnm_service_policy: *sanity_replace_min
    register: sanity_replace_idem
  - name: ASSERT replace idempotence
    ansible.builtin.assert:
      that:
        - 'sanity_replace_idem.changed == false'
        - '(sanity_replace_idem.diff[0].modified | length) == 0'

  ##############################################
  ## CLEANUP
  ##############################################
  - name: SANITY FINAL delete all
    cisco.dcnm.dcnm_service_policy:
      fabric: "{{ ansible_it_fabric }}"
      service_fabric: "{{ ansible_it_service_fabric }}"
      state: deleted
      config:
        - name: service_policy_1
          node_name: "{{ ansible_snode_1 }}"
        - name: service_policy_2
          node_name: "{{ ansible_snode_2 }}"
    register: sanity_final_delete
  - name: ASSERT final delete
    ansible.builtin.assert:
      that:
        - sanity_final_delete.changed
        - '(sanity_final_delete.diff[0].deleted | length) == 2'

  always:
    - name: ALWAYS sanity cleanup residual
      cisco.dcnm.dcnm_service_policy:
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        state: deleted
      register: sanity_cleanup
    - name: ASSERT sanity cleanup responses
      ansible.builtin.assert:
        that: ['item["RETURN_CODE"] == 200']
      loop: "{{ sanity_cleanup.response }}"
