##############################################
## dcnm_service_policy_delete.yaml (Refactored v2)
## Focus: deletion selectors & idempotence (clean indentation)
##############################################

- name: DELETE SETUP - ensure clean slate
  cisco.dcnm.dcnm_service_policy:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_it_service_fabric }}"
    state: deleted
    config:
      - name: service_policy_1
        node_name: "{{ ansible_snode_1 }}"
      - name: service_policy_2
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_3
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_4
        node_name: "{{ ansible_snode_2 }}"
      - name: service_policy_5
        node_name: "{{ ansible_snode_2 }}"
  register: init_delete_result

- name: ASSERT setup delete responses successful
  ansible.builtin.assert:
    that: ['item["RETURN_CODE"] == 200']
  loop: "{{ init_delete_result.response }}"

- block:
    - name: Verify policy operations
      cisco.dcnm.dcnm_service_policy:
        state: query
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config: []
      register: verify_result

  always:
    - name: Cleanup - Delete all policies
      cisco.dcnm.dcnm_service_policy:
        state: deleted
        fabric: "{{ ansible_it_fabric }}"
        service_fabric: "{{ ansible_it_service_fabric }}"
        config: []
      register: cleanup_result
