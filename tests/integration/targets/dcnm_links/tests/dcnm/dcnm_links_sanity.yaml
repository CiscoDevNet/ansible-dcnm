##############################################
##               SETUP                      ##
##############################################

- name: SANITY - Remove local log file
  local_action: command rm -f dcnm_links.log

- tags: sanity
  block:

##############################################
##           BASELINE DELETE               ##
##############################################

    - name: SANITY - Baseline delete links
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
      register: delete_result

    - name: ASSERT - Baseline delete RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ delete_result.response | default([]) }}"
      failed_when: delete_result.diff is not defined and (delete_result.response | length) > 0

##############################################
##              CREATE (MERGE)             ##
##############################################

    - name: SANITY - Create two numbered links
      cisco.dcnm.dcnm_links: &links_create
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: true
              mtu: 9216
              peer1_description: "Src desc"
              peer2_description: "Dst desc"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_pre_provision_intra_fabric_link
            profile:
              admin_state: true
              peer1_description: "Pre-provision src"
              peer2_description: "Pre-provision dst"
      register: create_result
      ignore_errors: true

    - name: ASSERT - Create diff
      ansible.builtin.assert:
        that:
          - "(create_result.diff[0].merged | length) == 2"
          - "(create_result.diff[0].modified | length) == 0"
          - "(create_result.diff[0].deleted | length) == 0"
          - "(create_result.diff[0].query | length) == 0"
      failed_when: create_result.diff is not defined

##############################################
##                  MODIFY                 ##
##############################################

    - name: SANITY - Modify first link profile
      cisco.dcnm.dcnm_links: &links_modify
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: false
              mtu: 1500
              peer1_description: "MOD Src desc"
              peer2_description: "MOD Dst desc"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_pre_provision_intra_fabric_link
            profile:
              admin_state: true
              peer1_description: "Pre-provision src"
              peer2_description: "Pre-provision dst"
      register: modify_result
      ignore_errors: true

    - name: ASSERT - Modify diff
      ansible.builtin.assert:
        that:
          - "(modify_result.diff[0].merged | length) == 0"
          - "(modify_result.diff[0].modified | length) == 1"
          - "(modify_result.diff[0].deleted | length) == 0"
          - "(modify_result.diff[0].query | length) == 0"
      failed_when: modify_result.diff is not defined

##############################################
##                 REPLACE                ##
##############################################

    - name: SANITY - Replace links (change IPs first link)
      cisco.dcnm.dcnm_links: &links_replace
        state: replaced
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 192.168.10.1
              peer2_ipv4_addr: 192.168.10.2
              admin_state: false
              mtu: 1500
              peer1_description: "REP Src desc"
              peer2_description: "REP Dst desc"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_pre_provision_intra_fabric_link
            profile:
              admin_state: true
              peer1_description: "Pre-provision src"
              peer2_description: "Pre-provision dst"
      register: replace_result
      ignore_errors: true

    - name: ASSERT - Replace diff
      ansible.builtin.assert:
        that:
          - "(replace_result.diff[0].merged | length) == 0"
          - "(replace_result.diff[0].modified | length) == 1"
          - "(replace_result.diff[0].deleted | length) == 0"
          - "(replace_result.diff[0].query | length) == 0"
      failed_when: replace_result.diff is not defined

##############################################
##             IDEMPOTENCE                ##
##############################################

    - name: SANITY - Replace links idempotence
      cisco.dcnm.dcnm_links: *links_replace
      register: replace_idem

    - name: ASSERT - Replace idempotence diff
      ansible.builtin.assert:
        that:
          - "(replace_idem.diff[0].merged | length) == 0"
          - "(replace_idem.diff[0].modified | length) == 0"
          - "(replace_idem.diff[0].deleted | length) == 0"
          - "(replace_idem.diff[0].query | length) == 0"
      failed_when: replace_idem.diff is not defined

##############################################
##                 QUERY                  ##
##############################################

    - name: SANITY - Query first link
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_intra_fabric_num_link
      register: query_result

    - name: ASSERT - Query result
      ansible.builtin.assert:
        that: "(query_result.response | length) >= 1"

###############################################
###               CLEANUP                  ##
###############################################

  always:
    - name: SANITY - Cleanup delete links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
