##############################################
##               SETUP                      ##
##############################################

- name: LINKS INTER NUMBERED REPLACE - Test Entry Point
  ansible.builtin.debug:
    msg:
      - "--------------------------------------------------------------"
      - "+     Executing dcnm_links inter numbered replace tests       +"
      - "--------------------------------------------------------------"

- name: Remove local log file
  ansible.builtin.command: rm -f dcnm_links.log
  delegate_to: localhost

- block:
    ##############################################
    ##            INITIAL DELETE                ##
    ##############################################

    - name: Initial setup - Delete Links on numbered fabric
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
      register: delete_result

    - name: ASSERT - Initial delete return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ delete_result.response | default([]) }}"

    ##############################################
    ##          MERGE (CREATE BASE)            ##
    ##############################################

    - name: Create base links (with optional parameters)
      cisco.dcnm.dcnm_links: &links_merge_base
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            profile:
              ipv4_subnet: 193.168.1.1/24
              neighbor_ip: 193.168.1.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 9216
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_6 }}"
            dst_interface: "{{ intf_1_6 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch1 }}"
            profile:
              ipv4_subnet: 193.168.4.1/24
              neighbor_ip: 193.168.4.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_ipv6_asn }}"
              mtu: 9216
      register: merge_base_result

    - name: ASSERT - Merge base diff counters
      ansible.builtin.assert:
        that:
          - '(merge_base_result.diff[0].merged | length) == 2'
          - '(merge_base_result.diff[0].modified | length) == 0'
      failed_when: merge_base_result.diff is not defined

    - name: ASSERT - Merge base return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_base_result.response }}"

    ##############################################
    ##              REPLACE                     ##
    ##############################################

    - name: Replace existing links
      cisco.dcnm.dcnm_links: &links_replace
        state: replaced
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            profile:
              ipv4_subnet: 193.168.10.1/24
              neighbor_ip: 193.168.10.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 1216
              auto_deploy: true
              peer1_description: "Description of source - REP"
              peer2_description: "Description of dest - REP"
              peer1_cmds:
                - "cdp enable"
              peer2_cmds:
                - "cdp enable"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_6 }}"
            dst_interface: "{{ intf_1_6 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch1 }}"
            profile:
              ipv4_subnet: 193.168.40.1/24
              neighbor_ip: 193.168.40.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_ipv6_asn }}"
              mtu: 4216
              auto_deploy: true
              peer1_description: "Description of source - REP"
              peer2_description: "Description of dest - REP"
              peer1_cmds:
                - "no shutdown"
              peer2_cmds:
                - "no shutdown"
      register: replace_result

    - name: ASSERT - Replace diff counters
      ansible.builtin.assert:
        that:
          - '(replace_result.diff[0].merged | length) == 0'
          - '(replace_result.diff[0].modified | length) >= 2'
      failed_when: replace_result.diff is not defined

    - name: ASSERT - Replace return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ replace_result.response }}"

    - name: Replace Links - Idempotence
      cisco.dcnm.dcnm_links: *links_replace
      register: replace_idem_result

    - name: ASSERT - Replace idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(replace_idem_result.diff[0].merged | length) == 0'
          - '(replace_idem_result.diff[0].modified | length) == 0'
      failed_when: replace_idem_result.diff is not defined

    - name: ASSERT - Replace idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ replace_idem_result.response }}"

##############################################
##             CLEANUP                      ##
##############################################

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
