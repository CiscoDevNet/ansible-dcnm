##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_links.log

- block:

#############################################
#               DELETE                     ##
#############################################

    - name: Initial setup - Delete Links on numbered fabric
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted                                           # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "dummy-switch-1"                         # Device on the Source fabric
            dst_device: "{{ ansible_num_switch1 }}"              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw3"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_4 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_4 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw100"                        # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_5 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_5 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-svi1"                              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_6 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_6 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-test-sw3"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_7 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_7 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-svi1"                              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_ext_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_8 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_8 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw4"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_9 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_9 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-unnum-1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_ext_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_10 }}"                     # Interface on the Source fabric
            dst_interface: "{{ intf_1_10 }}"                     # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-ext-sw1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_11 }}"                     # Interface on the Source fabric
            dst_interface: "{{ intf_1_11 }}"                     # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-unnum-1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Source Fabric in Monitoring mode
      cisco.dcnm.dcnm_links: 
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_extmon_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "dummy-switch-1"                         # Device on the Source fabric
            dst_device: "{{ ansible_num_switch1 }}"              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.1.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.1.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_extmon_asn }}"                # BGP ASN in source fabric
              dst_asn: "{{ ansible_num_asn }}"                   # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - '("Monitoring mode" in result["msg"])'
          - '("No changes are allowed on the fabric" in result["msg"])'
          - '("{{ ansible_extmon_fabric }}" in result["msg"])'

    - name: Create Links - Destination Fabric - Monitoring, Source Switches Not Managable and Destination Switches Not Managable (in POAP)
      cisco.dcnm.dcnm_links: &links_create1
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw3"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.2.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.2.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

############################################
#             IDEMPOTENCE                  #
############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create1
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw3"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Destination Fabric - Monitoring, Source Switches Not Managable and Destination Switches Not Managable (not present)
      cisco.dcnm.dcnm_links: &links_create2
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_4 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_4 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw100"                        # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.3.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.3.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
              peer1_description: "Description of source"         # optional, default is ""
              peer2_description: "Description of dest"           # optional, default is ""
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

    - name: Merge Links - Destination Fabric - Monitoring, Source Switches Not Managable and Destination Switches Not Managable (not present)
      cisco.dcnm.dcnm_links:
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_4 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_4 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw100"                        # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.20.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.20.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
              peer1_description: "Description of source - REP"   # optional, default is ""
              peer2_description: "Description of dest - REP"     # optional, default is ""
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 1'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

    - name: Merge Links - Destination Fabric - Monitoring, Source Switches Not Managable and Destination Switches Not Managable (not present)
      cisco.dcnm.dcnm_links:
        state: replaced                                          # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_4 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_4 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw100"                        # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.20.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.20.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
              peer1_description: "Description of source - REP"   # optional, default is ""
              peer2_description: "Description of dest - REP"     # optional, default is ""
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 1'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create2
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 1'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_4 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_4 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw100"                        # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Destination Fabric - Monitoring, Source Switches Not Managable and Destination Switches Managable
      cisco.dcnm.dcnm_links: &links_create3
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_5 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_5 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-svi1"                              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.4.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.4.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create3
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_5 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_5 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-svi1"                              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Destination Fabric - Monitoring, Source Switches Managable and Destination Switches Not Managable
      cisco.dcnm.dcnm_links: &links_create4
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_6 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_6 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-test-sw3"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.5.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.5.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create4
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_6 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_6 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-test-sw3"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Destination Fabric - Monitoring, Source Switches Managable and Destination Switches Managable
      cisco.dcnm.dcnm_links: &links_create5
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_7 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_7 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-svi1"                              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.6.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.6.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_svi_asn }}"                   # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create5
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_svi_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_svi_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_7 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_7 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-svi1"                              # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Source Switches Not Managable and Destination Switches Not Managable
      cisco.dcnm.dcnm_links: &links_create6
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ext_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_8 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_8 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw4"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.7.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.7.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_ext_asn }}"                   # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_ext_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create6
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_ext_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ext_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_8 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_8 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-test-sw4"                          # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Source Switches Not Managable and Destination Switches Managable
      cisco.dcnm.dcnm_links: &links_create7
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_9 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_9 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-unnum-1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.8.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.8.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_unnum_asn }}"                 # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create7
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_9 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_9 }}"                      # Interface on the Destination fabric
            src_device: "n9kv-test-sw1"                          # Device on the Source fabric
            dst_device: "n9kv-unnum-1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Source Switches Managable and Destination Switches Not Managable (not present in Fabric)
      cisco.dcnm.dcnm_links: &links_create8
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ext_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_10 }}"                     # Interface on the Source fabric
            dst_interface: "{{ intf_1_10 }}"                     # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-ext-sw1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.9.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.9.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_ext_asn }}"                 # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_ext_fabric }}" ] | length) == 0'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create8
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_ext_fabric }}" ] | length) == 0'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ext_fabric }}"               # Destination fabric
            src_interface: "{{ intf_1_10 }}"                     # Interface on the Source fabric
            dst_interface: "{{ intf_1_10 }}"                     # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-ext-sw1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#                MERGE                     ##
#############################################

    - name: Create Links - Source Switches Managable and Destination Switches Managable
      cisco.dcnm.dcnm_links: &links_create9
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_11 }}"                     # Interface on the Source fabric
            dst_interface: "{{ intf_1_11 }}"                     # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-unnum-1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
            profile:
              ipv4_subnet: 193.168.10.1/24                       # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.10.2                          # IP address of the interface in dst fabric
              src_asn: "{{ ansible_num_asn }}"                   # BGP ASN in source fabric
              dst_asn: "{{ ansible_unnum_asn }}"                 # BGP ASN in destination fabric
      register: result
      ignore_errors: yes          

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 1'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 1'

#############################################
#             IDEMPOTENCE                  ##
#############################################

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_create9
      register: result

    - assert:
        that:
          - 'result.changed == true'
          - '(result["diff"][0]["merged"] | length) == 0'
          - '(result["diff"][0]["modified"] | length) == 0'
          - '(result["diff"][0]["deleted"] | length) == 0'
          - '(result["diff"][0]["query"] | length) == 0'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_num_fabric }}" ] | length) == 1'
          - '(result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 1'

###############################################
###             QUERY                        ##
###############################################

    - name: Query Links
      cisco.dcnm.dcnm_links: 
        state: query                                             # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_11 }}"                     # Interface on the Source fabric
            dst_interface: "{{ intf_1_11 }}"                     # Interface on the Destination fabric
            src_device: "n9kv-num-1"                             # Device on the Source fabric
            dst_device: "n9kv-unnum-1"                           # Device on the Destination fabric
            template: ext_fabric_setup                           # template to be applied, choose from 
                                                                 #   [ ext_fabric_setup, ext_multisite_underlay_setup,
                                                                 #     ext_evpn_multisite_overlay_setup ]
      register: result

    - assert:
        that:
          '(result["response"] | length) >= 1'

#############################################
#             CLEANUP                      ##
#############################################

  always:

    - name: Cleanup - Delete Links 
      cisco.dcnm.dcnm_links: *links_delete
      register: result
      when: IT_CONTEXT is not defined

    - assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ result.response }}'
      when: IT_CONTEXT is not defined
