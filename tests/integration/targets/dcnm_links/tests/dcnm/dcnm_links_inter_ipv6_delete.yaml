##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_links.log

- block:

##############################################
##                  DELETE                  ##
##############################################

    - name: Baseline - Delete any pre-existing IPv6 inter-fabric links
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted                                           # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "{{ ansible_ipv6_switch1 }}"             # Device on the Source fabric
            dst_device: "{{ ansible_unnum_switch1 }}"            # Device on the Destination fabric

          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_4 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_4 }}"                      # Interface on the Destination fabric
            src_device: "{{ ansible_ipv6_switch1 }}"             # Device on the Source fabric
            dst_device: "{{ ansible_unnum_switch1 }}"            # Device on the Destination fabric

          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_5 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_5 }}"                      # Interface on the Destination fabric
            src_device: "{{ ansible_ipv6_switch1 }}"             # Device on the Source fabric
            dst_device: "{{ ansible_unnum_switch1 }}"            # Device on the Destination fabric
      register: baseline_delete_result

    - name: ASSERT - Baseline delete return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ baseline_delete_result.response }}'

##############################################
##                MERGE                     ##
##############################################

    - name: Merge - Create single link with minimal params
      cisco.dcnm.dcnm_links: &links_merge_basic
        state: merged                                            # choose from [merged, replaced, deleted, query]
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"             # Destination fabric
            src_interface: "{{ intf_1_3 }}"                      # Interface on the Source fabric
            dst_interface: "{{ intf_1_3 }}"                      # Interface on the Destination fabric
            src_device: "{{ ansible_ipv6_switch1 }}"             # Device on the Source fabric
            dst_device: "{{ ansible_unnum_switch1 }}"            # Device on the Destination fabric
            # template to be applied; choose from
            # [ext_fabric_setup, ext_multisite_underlay_setup, ext_evpn_multisite_overlay_setup]
            template: ext_fabric_setup
            profile:
              ipv4_subnet: 193.168.1.1/24                        # IP address of interface in src fabric with mask
              neighbor_ip: 193.168.1.2                           # IP address of the interface in dst fabric
              src_asn: "{{ ansible_ipv6_asn }}"                  # BGP ASN in source fabric
              dst_asn: "{{ ansible_unnum_asn }}"                 # BGP ASN in destination fabric
              mtu: 9216                                          #
              auto_deploy: false                                 # optional, default is false
                                                                 # Flag that controls auto generation of neighbor VRF Lite configuration
              peer1_description: "Description of source"         # optional, default is ""
              peer2_description: "Description of dest"           # optional, default is ""
              peer1_cmds:                                        # Freeform config for source interface
                - no shutdown                                    # optional, default is ""
              peer2_cmds:                                        # Freeform config for destination interface
                - no shutdown                                    # optional, default is ""
      register: merge_basic_result

    - name: ASSERT - Basic merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_result.changed == true'
          - '(merge_basic_result.diff[0].merged | length) == 1'
          - '(merge_basic_result.diff[0].modified | length) == 0'
          - '(merge_basic_result.diff[0].deleted | length) == 0'
          - '(merge_basic_result.diff[0].query | length) == 0'
          - '(merge_basic_result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 1'
          - '(merge_basic_result["diff"][0]["deploy"][0][ "{{ ansible_ipv6_fabric }}" ] | length) == 1'

    - name: ASSERT - Basic merge return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_basic_result.response }}'

##############################################
##              BASIC DELETE                ##
##############################################

    - name: Delete - Remove the basic link
      cisco.dcnm.dcnm_links: *links_delete
      register: delete_basic_result

    - name: ASSERT - Basic delete diff counters
      ansible.builtin.assert:
        that:
          - '(delete_basic_result.changed == true'
          - '(delete_basic_result.diff[0].merged | length) == 0'
          - '(delete_basic_result.diff[0].modified | length) == 0'
          - '(delete_basic_result.diff[0].deleted | length) == 1'
          - '(delete_basic_result.diff[0].query | length) == 0'
          - '(delete_basic_result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 1'
          - '(delete_basic_result["diff"][0]["deploy"][0][ "{{ ansible_ipv6_fabric }}" ] | length) == 1'

    - name: ASSERT - Basic delete return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ delete_basic_result.response }}'

##############################################
##        BASIC DELETE - IDEMPOTENCE        ##
##############################################

    - name: Delete - Idempotence (basic link)
      cisco.dcnm.dcnm_links: *links_delete
      register: delete_basic_idem

    - name: ASSERT - Basic delete idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(delete_basic_idem.changed == false'
          - '(delete_basic_idem.diff[0].merged | length) == 0'
          - '(delete_basic_idem.diff[0].modified | length) == 0'
          - '(delete_basic_idem.diff[0].deleted | length) == 0'
          - '(delete_basic_idem.diff[0].query | length) == 0'

    - name: ASSERT - Basic delete idempotence return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ delete_basic_idem.response }}'

##############################################
##             MERGE                        ##
##############################################

    - name: Merge - Create multisite underlay + overlay links (minimal)
      cisco.dcnm.dcnm_links: &links_merge_ms
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_multisite_underlay_setup
            profile:
              ipv4_subnet: 193.168.2.1/24
              neighbor_ip: 193.168.2.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 9216                                          #
              deploy_dci_tracking: false                         # optional, default is false
              max_paths: 1                                       # optional, default is 1
              route_tag: 12345                                   # optional, optional is ""
              ebgp_password_enable: true                         # optional, default is true
              ebgp_password: 9BFE3270E19CA112                    # optional, required only if ebgp_password_enable flag is true and inherit_from_msd is false
              inherit_from_msd: true                             # optional, required only if ebgp_password_enable flag is true, default is false
              ebgp_auth_key_type: 3                              # optional, required only if ebpg_password_enable is true and inherit_from_msd
                                                                 # is false. Default is 3
                                                                 # choose from [3 - 3DES, 7 - Cisco ]
              peer1_description: "Description of source"         # optional, default is ""
              peer2_description: "Description of dest"           # optional, default is ""
              peer1_cmds:                                        # Freeform config for source interface
                - no shutdown                                    # optional, default is ""
              peer2_cmds:                                        # Freeform config for destination interface
                - no shutdown                                    # optional, default is ""

          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_evpn_multisite_overlay_setup
            profile:
              ipv4_addr: 193.168.3.1
              neighbor_ip: 193.168.3.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              trm_enabled: false                                 # optional, default is false
              bgp_multihop: 5                                    # optional, default is 5
              ebgp_password_enable: true                         # optional, default is true
              ebgp_password: 9BFE3270E19CA112                    # optional, required only if ebgp_password_enable flag is true and inherit_from_msd is false
              inherit_from_msd: false                            # optional, required only if ebgp_password_enable flag is true, default is false
              ebpg_auth_key_type: 3                              # optional, required only if ebpg_password_enable is true and inherit_from_msd
                                                                 # is false. Default is 3
                                                                 # choose from [3 - 3DES, 7 - Cisco ]
      register: merge_ms_result
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge diff counters (minimal)
      ansible.builtin.assert:
        that:
          - '(merge_ms_result.changed == true'
          - '(merge_ms_result.diff[0].merged | length) == 2'
          - '(merge_ms_result.diff[0].modified | length) == 0'
          - '(merge_ms_result.diff[0].deleted | length) == 0'
          - '(merge_ms_result.diff[0].query | length) == 0'
          - '(merge_ms_result["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 1'
          - '(merge_ms_result["diff"][0]["deploy"][0][ "{{ ansible_ipv6_fabric }}" ] | length) == 1'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge return codes (minimal)
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_ms_result.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

##############################################
##            DELETE                        ##
##############################################

    - name: Merge - Multisite idempotence (minimal)
      cisco.dcnm.dcnm_links: *links_merge_ms
      register: merge_ms_idem
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge idempotence diff counters (minimal)
      ansible.builtin.assert:
        that:
          - '(merge_ms_idem.changed == true'
          - '(merge_ms_idem.diff[0].merged | length) == 0'
          - '(merge_ms_idem.diff[0].modified | length) == 0'
          - '(merge_ms_idem.diff[0].deleted | length) == 0'
          - '(merge_ms_idem.diff[0].query | length) == 0'
          - '(merge_ms_idem["diff"][0]["deploy"][0][ "{{ ansible_unnum_fabric }}" ] | length) == 1'
          - '(merge_ms_idem["diff"][0]["deploy"][0][ "{{ ansible_ipv6_fabric }}" ] | length) == 1'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge idempotence return codes (minimal)
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_ms_idem.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

##############################################
##           IDEMPOTENCE                    ##
##############################################

    - name: Delete - Remove multisite links
      cisco.dcnm.dcnm_links: *links_delete
      register: delete_ms_result
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite delete diff counters
      ansible.builtin.assert:
        that:
          - '(delete_ms_result.changed == false'
          - '(delete_ms_result.diff[0].merged | length) == 0'
          - '(delete_ms_result.diff[0].modified | length) == 0'
          - '(delete_ms_result.diff[0].deleted | length) == 2'
          - '(delete_ms_result.diff[0].query | length) == 0'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite delete return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ delete_ms_result.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)
