##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_links.log

- block:

##############################################
##           BASELINE DELETE                ##
##############################################

    - name: Initial setup - Delete Links (intra numbered template change)
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
      register: delete_result

    - name: ASSERT - Baseline delete RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ delete_result.response | default([]) }}"
      failed_when: delete_result.diff is not defined and (delete_result.response | length) > 0

##############################################
##           MERGE (CREATE BASE TEMPLATE)   ##
##############################################

    - name: Create link with initial template (num_link)
      cisco.dcnm.dcnm_links: &links_merge_base
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: true
              mtu: 9216
      register: create_result

    - name: ASSERT - Create diff counts
      ansible.builtin.assert:
        that:
          - "(create_result.diff[0].merged | length) == 1"
          - "(create_result.diff[0].modified | length) == 0"
          - "(create_result.diff[0].deleted | length) == 0"
          - "(create_result.diff[0].query | length) == 0"
      failed_when: create_result.diff is not defined

    - name: ASSERT - Create RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ create_result.response }}"

    - name: Idempotence - Reapply base create
      cisco.dcnm.dcnm_links: *links_merge_base
      register: create_idem

    - name: ASSERT - Create idempotence diff
      ansible.builtin.assert:
        that:
          - "(create_idem.diff[0].merged | length) == 0"
          - "(create_idem.diff[0].modified | length) == 0"
          - "(create_idem.diff[0].deleted | length) == 0"
          - "(create_idem.diff[0].query | length) == 0"
      failed_when: create_idem.diff is not defined

    - name: ASSERT - Create idempotence RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ create_idem.response }}"

##############################################
##         TEMPLATE CHANGE STEP 1           ##
##############################################

    - name: Change template to pre-provision
      cisco.dcnm.dcnm_links: &links_modify_step1
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_pre_provision_intra_fabric_link
      register: modify_step1

    - name: ASSERT - Modify step1 diff counts
      ansible.builtin.assert:
        that:
          - "(modify_step1.diff[0].merged | length) == 0"
          - "(modify_step1.diff[0].modified | length) == 1"
          - "(modify_step1.diff[0].deleted | length) == 0"
          - "(modify_step1.diff[0].query | length) == 0"
      failed_when: modify_step1.diff is not defined

    - name: ASSERT - Modify step1 RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ modify_step1.response }}"

    - name: Idempotence - Template change step1
      cisco.dcnm.dcnm_links: *links_modify_step1
      register: modify_step1_idem

    - name: ASSERT - Modify step1 idempotence diff
      ansible.builtin.assert:
        that:
          - "(modify_step1_idem.diff[0].merged | length) == 0"
          - "(modify_step1_idem.diff[0].modified | length) == 0"
          - "(modify_step1_idem.diff[0].deleted | length) == 0"
          - "(modify_step1_idem.diff[0].query | length) == 0"
      failed_when: modify_step1_idem.diff is not defined

    - name: ASSERT - Modify step1 idempotence RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ modify_step1_idem.response }}"

##############################################
##         TEMPLATE CHANGE STEP 2           ##
##############################################

    - name: Change template back to num_link (overlay revert)
      cisco.dcnm.dcnm_links: &links_modify_step2
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 192.168.1.10
              peer2_ipv4_addr: 192.168.1.20
              admin_state: true
              mtu: 1500
      register: modify_step2

    - name: ASSERT - Modify step2 diff counts
      ansible.builtin.assert:
        that:
          - "(modify_step2.diff[0].merged | length) == 0"
          - "(modify_step2.diff[0].modified | length) == 1"
          - "(modify_step2.diff[0].deleted | length) == 0"
          - "(modify_step2.diff[0].query | length) == 0"
      failed_when: modify_step2.diff is not defined

    - name: ASSERT - Modify step2 RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ modify_step2.response }}"

    - name: Idempotence - Template change step2
      cisco.dcnm.dcnm_links: *links_modify_step2
      register: modify_step2_idem

    - name: ASSERT - Modify step2 idempotence diff
      ansible.builtin.assert:
        that:
          - "(modify_step2_idem.diff[0].merged | length) == 0"
          - "(modify_step2_idem.diff[0].modified | length) == 0"
          - "(modify_step2_idem.diff[0].deleted | length) == 0"
          - "(modify_step2_idem.diff[0].query | length) == 0"
      failed_when: modify_step2_idem.diff is not defined

    - name: ASSERT - Modify step2 idempotence RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ modify_step2_idem.response }}"

###############################################
###             CLEANUP                      ##
###############################################

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
