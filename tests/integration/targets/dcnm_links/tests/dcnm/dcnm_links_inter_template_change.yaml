##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_links.log

- block:
  ##############################################
  ##           BASELINE DELETE                ##
  ##############################################

    - name: Initial setup - Delete Links (all candidate interfaces)
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
      register: delete_result

    - name: ASSERT - Baseline delete return codes
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ delete_result.response | default([]) }}"
      failed_when: delete_result.diff is not defined and (delete_result.response | length) > 0

  ##############################################
  ##             CREATE (TEMPLATE 1)          ##
  ##############################################

    - name: Create Links with ext_fabric_setup template
      cisco.dcnm.dcnm_links: &links_merge_base
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_fabric_setup
            profile:
              ipv4_subnet: 193.168.1.1/24
              neighbor_ip: 193.168.1.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 9216
      register: create_result

    - name: ASSERT - Create template ext_fabric_setup diff
      ansible.builtin.assert:
        that:
          - "(create_result.diff[0].merged | length) == 1"
          - "(create_result.diff[0].modified | length) == 0"
          - "(create_result.diff[0].deleted | length) == 0"
          - "(create_result.diff[0].query | length) == 0"
      failed_when: create_result.diff is not defined

    - name: ASSERT - Create return codes
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ create_result.response }}"

  ##############################################
  ##        IDEMPOTENCE (TEMPLATE 1)          ##
  ##############################################

    - name: Idempotence - Reapply ext_fabric_setup template
      cisco.dcnm.dcnm_links: *links_merge_base
      register: create_idem

    - name: ASSERT - Idempotence ext_fabric_setup
      ansible.builtin.assert:
        that:
          - "(create_idem.diff[0].merged | length) == 0"
          - "(create_idem.diff[0].modified | length) == 0"
          - "(create_idem.diff[0].deleted | length) == 0"
          - "(create_idem.diff[0].query | length) == 0"
      failed_when: create_idem.diff is not defined

    - name: ASSERT - Idempotence return codes
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ create_idem.response }}"

  ##############################################
  ##     TEMPLATE CHANGE #1 (UNDERLAY)        ##
  ##############################################

    - name: Modify template to ext_multisite_underlay_setup
      cisco.dcnm.dcnm_links: &links_modify_underlay
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_multisite_underlay_setup
            profile:
              ipv4_subnet: 193.168.2.1/24
              neighbor_ip: 193.168.2.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 2216
      register: underlay_result
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: ASSERT - Underlay modification diff
      ansible.builtin.assert:
        that:
          - "(underlay_result.diff[0].merged | length) == 0"
          - "(underlay_result.diff[0].modified | length) == 1"
          - "(underlay_result.diff[0].deleted | length) == 0"
          - "(underlay_result.diff[0].query | length) == 0"
      failed_when: underlay_result.diff is not defined
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: ASSERT - Underlay return codes
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ underlay_result.response }}"
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: Idempotence - Underlay template reapply
      cisco.dcnm.dcnm_links: *links_modify_underlay
      register: underlay_idem
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: ASSERT - Underlay idempotence
      ansible.builtin.assert:
        that:
          - "(underlay_idem.diff[0].merged | length) == 0"
          - "(underlay_idem.diff[0].modified | length) == 0"
          - "(underlay_idem.diff[0].deleted | length) == 0"
          - "(underlay_idem.diff[0].query | length) == 0"
      failed_when: underlay_idem.diff is not defined
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

  ##############################################
  ##   TEMPLATE CHANGE #2 (OVERLAY EVPN)      ##
  ##############################################

    - name: Modify template to ext_evpn_multisite_overlay_setup
      cisco.dcnm.dcnm_links: &links_modify_overlay
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_evpn_multisite_overlay_setup
            profile:
              ipv4_addr: 193.168.3.1
              neighbor_ip: 193.168.3.2
              src_asn: "{{ ansible_num_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              trm_enabled: false
      register: overlay_result
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: ASSERT - Overlay modification diff
      ansible.builtin.assert:
        that:
          - "(overlay_result.diff[0].merged | length) == 0"
          - "(overlay_result.diff[0].modified | length) == 1"
          - "(overlay_result.diff[0].deleted | length) == 0"
          - "(overlay_result.diff[0].query | length) == 0"
      failed_when: overlay_result.diff is not defined
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: ASSERT - Overlay return codes
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ overlay_result.response }}"
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: Idempotence - Overlay template reapply
      cisco.dcnm.dcnm_links: *links_modify_overlay
      register: overlay_idem
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

    - name: ASSERT - Overlay idempotence
      ansible.builtin.assert:
        that:
          - "(overlay_idem.diff[0].merged | length) == 0"
          - "(overlay_idem.diff[0].modified | length) == 0"
          - "(overlay_idem.diff[0].deleted | length) == 0"
          - "(overlay_idem.diff[0].query | length) == 0"
      failed_when: overlay_idem.diff is not defined
      when: ansible_num_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list

  ##############################################
  ##                 CLEANUP                  ##
  ##############################################

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
