##############################################
##      INTRA IPV6 LINK QUERY TESTS         ##
##############################################

- name: LINKS INTRA IPV6 QUERY - Test Entry Point
  ansible.builtin.debug:
    msg:
      - "--------------------------------------------------------------"
      - "+   Executing dcnm_links intra ipv6 query tests              +"
      - "--------------------------------------------------------------"

- name: Remove local log file
  ansible.builtin.command: rm -f dcnm_links.log
  delegate_to: localhost

- block:
    ##############################################
    ##           INITIAL DELETE (CLEAN)        ##
    ##############################################

    - name: Initial setup - Delete Links
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
      register: initial_delete_result

    - name: ASSERT - Initial delete return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ initial_delete_result.response | default([]) }}"

    ##############################################
    ##                BASE MERGE               ##
    ##############################################

    - name: Create Links (baseline for queries)
      cisco.dcnm.dcnm_links: &links_merge_base
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_ipv6_link_local
            profile:
              admin_state: true
              mtu: 9216
              peer1_ipv6_addr: "2080:0301::01"
              peer2_ipv6_addr: "2080:0301::02"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_pre_provision_intra_fabric_link
            profile:
              admin_state: true
              mtu: 9216
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              admin_state: true
              mtu: 9216
              peer1_ipv6_addr: "2080:0302::01"
              peer2_ipv6_addr: "2080:0302::02"
      register: merge_base_result

    - name: ASSERT - Base merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_base_result.diff[0].merged | length) == 3'
          - '(merge_base_result.diff[0].modified | length) == 0'
          - '(merge_base_result.diff[0].deleted | length) == 0'
          - '(merge_base_result.diff[0].query | length) == 0'
      failed_when: merge_base_result.diff is not defined

    - name: ASSERT - Base merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_base_result.response }}"

    - name: Base merge - Idempotence
      cisco.dcnm.dcnm_links: *links_merge_base
      register: merge_base_idem

    - name: ASSERT - Base merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_base_idem.diff[0].merged | length) == 0'
          - '(merge_base_idem.diff[0].modified | length) == 0'
          - '(merge_base_idem.diff[0].deleted | length) == 0'
          - '(merge_base_idem.diff[0].query | length) == 0'
      failed_when: merge_base_idem.diff is not defined

    - name: ASSERT - Base merge idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_base_idem.response }}"

    ##############################################
    ##                 QUERIES                 ##
    ##############################################

    - name: Query Links - Src Fabric only
      cisco.dcnm.dcnm_links: &query_src_fabric
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
      register: query_src_result

    - name: ASSERT - Query Src Fabric only
      ansible.builtin.assert:
        that:
          - '(query_src_result.response | length) >= 3'
          - 'query_src_result.changed == false'

    - name: Query Links - Src + Dst Fabric
      cisco.dcnm.dcnm_links: &query_src_dst
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
      register: query_src_dst_result

    - name: ASSERT - Query Src + Dst Fabric
      ansible.builtin.assert:
        that:
          - '(query_src_dst_result.response | length) >= 3'
          - 'query_src_dst_result.changed == false'

    - name: Query Links - Src/Dst Fabric + Src Interface
      cisco.dcnm.dcnm_links: &query_src_dst_src_intf
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
      register: query_src_dst_src_intf_result

    - name: ASSERT - Query Src/Dst Fabric + Src Interface
      ansible.builtin.assert:
        that:
          - '(query_src_dst_src_intf_result.response | length) >= 1'
          - 'query_src_dst_src_intf_result.changed == false'

    - name: Query Links - Src/Dst Fabric + Src/Dst Interface
      cisco.dcnm.dcnm_links: &query_src_dst_both_intf
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
      register: query_src_dst_both_intf_result

    - name: ASSERT - Query Src/Dst Fabric + Src/Dst Interface
      ansible.builtin.assert:
        that:
          - '(query_src_dst_both_intf_result.response | length) >= 1'
          - 'query_src_dst_both_intf_result.changed == false'

    - name: Query Links - Src/Dst Fabric + Interfaces + Src Device
      cisco.dcnm.dcnm_links: &query_src_dst_intf_src_dev
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
      register: query_src_dst_intf_src_dev_result

    - name: ASSERT - Query Interfaces + Src Device
      ansible.builtin.assert:
        that:
          - '(query_src_dst_intf_src_dev_result.response | length) >= 1'
          - 'query_src_dst_intf_src_dev_result.changed == false'

    - name: Query Links - Src/Dst Fabric + Interfaces + Src/Dst Device
      cisco.dcnm.dcnm_links: &query_full_devices
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
      register: query_full_devices_result

    - name: ASSERT - Query Interfaces + Src/Dst Device
      ansible.builtin.assert:
        that:
          - '(query_full_devices_result.response | length) >= 1'
          - 'query_full_devices_result.changed == false'

    - name: Query Links - Src/Dst Fabric + Interfaces + Devices + Templates
      cisco.dcnm.dcnm_links: &query_full_templates
        state: query
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_ipv6_link_local
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_pre_provision_intra_fabric_link
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_num_link
      register: query_full_templates_result

    - name: ASSERT - Query Full Templates
      ansible.builtin.assert:
        that:
          - '(query_full_templates_result.response | length) >= 3'
          - 'query_full_templates_result.changed == false'

    ##############################################
    ##            QUERY IDEMPOTENCE            ##
    ##############################################

    - name: Query Links - Idempotence (full templates)
      cisco.dcnm.dcnm_links: *query_full_templates
      register: query_full_templates_idem

    - name: ASSERT - Query idempotence full templates
      ansible.builtin.assert:
        that:
          - '(query_full_templates_idem.response | length) >= 3'
          - 'query_full_templates_idem.changed == false'

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
