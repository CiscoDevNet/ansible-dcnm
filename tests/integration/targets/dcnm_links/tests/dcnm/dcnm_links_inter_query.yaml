##############################################
##               SETUP                      ##
##############################################

- name: LINKS INTER QUERY - Test Entry Point
  ansible.builtin.debug:
    msg:
      - "--------------------------------------------------------------"
      - "+        Executing dcnm_links inter query tests             +"
      - "--------------------------------------------------------------"

- name: Remove local log file
  ansible.builtin.command: rm -f dcnm_links.log
  delegate_to: localhost

- block:
    ##############################################
    ##            INITIAL DELETE                ##
    ##############################################

    - name: Initial setup - Delete Links on numbered fabric
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_6 }}"
            dst_interface: "{{ intf_1_6 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch1 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_7 }}"
            dst_interface: "{{ intf_1_7 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch1 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_8 }}"
            dst_interface: "{{ intf_1_8 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch1 }}"
      register: delete_result

    - name: ASSERT - Initial delete return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ delete_result.response | default([]) }}"

    ##############################################
    ##              BASE MERGE                 ##
    ##############################################

    - name: Create Links - Base for query tests
      cisco.dcnm.dcnm_links: &links_merge_base
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_6 }}"
            dst_interface: "{{ intf_1_6 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch1 }}"
      register: merge_result

    - name: ASSERT - Base merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_result.diff[0].merged | length) >= 3'
          - '(merge_result.diff[0].modified | length) == 0'
          - '(merge_result.diff[0].deleted | length) == 0'
          - '(merge_result.diff[0].query | length) == 0'
      failed_when: merge_result.diff is not defined

    - name: ASSERT - Base merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_result.response }}"

    - name: Create Links - Idempotence
      cisco.dcnm.dcnm_links: *links_merge_base
      register: merge_idem_result

    - name: ASSERT - Base merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_idem_result.diff[0].merged | length) == 0'
          - '(merge_idem_result.diff[0].modified | length) == 0'
          - '(merge_idem_result.diff[0].deleted | length) == 0'
          - '(merge_idem_result.diff[0].query | length) == 0'
      failed_when: merge_idem_result.diff is not defined

    - name: ASSERT - Base merge idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_idem_result.response }}"

    ###############################################
    ###                 QUERY                    ##
    ###############################################

    - name: Query Links - source fabric only
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
      register: query_src_only

    - name: ASSERT - Query src only
      ansible.builtin.assert:
        that:
          - '(query_src_only.response | length) >= 3'
          - query_src_only.changed == false

    - name: Query Links - src + dst unnumbered fabric
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
      register: query_unnum

    - name: ASSERT - Query src + dst unnumbered
      ansible.builtin.assert:
        that:
          - '(query_unnum.response | length) >= 2'
          - query_unnum.changed == false

    - name: Query Links - src + dst ipv6 fabric
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
      register: query_ipv6

    - name: ASSERT - Query src + dst ipv6
      ansible.builtin.assert:
        that:
          - '(query_ipv6.response | length) >= 1'
          - query_ipv6.changed == false

    - name: Query Links - src + dst + src_interface (unnumbered)
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
        src_interface: "{{ intf_1_3 }}"
      register: query_unnum_intf

    - name: ASSERT - Query src + dst + src_interface (unnumbered)
      ansible.builtin.assert:
        that:
          - '(query_unnum_intf.response | length) >= 1'
          - query_unnum_intf.changed == false

    - name: Query Links - full filter (unnumbered)
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
        src_interface: "{{ intf_1_3 }}"
        dst_interface: "{{ intf_1_3 }}"
        src_device: "{{ ansible_num_switch1 }}"
        dst_device: "{{ ansible_unnum_switch1 }}"
      register: query_full_unnum

    - name: ASSERT - Query full filter (unnumbered)
      ansible.builtin.assert:
        that:
          - '(query_full_unnum.response | length) >= 1'
          - query_full_unnum.changed == false

    - name: Query Links - full filter (ipv6)
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
        src_interface: "{{ intf_1_6 }}"
        dst_interface: "{{ intf_1_6 }}"
        src_device: "{{ ansible_num_switch1 }}"
        dst_device: "{{ ansible_ipv6_switch1 }}"
      register: query_full_ipv6

    - name: ASSERT - Query full filter (ipv6)
      ansible.builtin.assert:
        that:
          - '(query_full_ipv6.response | length) >= 1'
          - query_full_ipv6.changed == false

    - name: Query Links - idempotence (repeat full filter ipv6)
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
        src_interface: "{{ intf_1_6 }}"
        dst_interface: "{{ intf_1_6 }}"
        src_device: "{{ ansible_num_switch1 }}"
        dst_device: "{{ ansible_ipv6_switch1 }}"
      register: query_full_ipv6_idem

    - name: ASSERT - Query idempotence (ipv6 full filter)
      ansible.builtin.assert:
        that:
          - '(query_full_ipv6_idem.response | length) >= 1'
          - query_full_ipv6_idem.changed == false

    - name: ASSERT - All query return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      vars:
        all_query_responses: "{{ query_src_only.response
          + query_unnum.response
          + query_ipv6.response
          + query_unnum_intf.response
          + query_full_unnum.response
          + query_full_ipv6.response
          + query_full_ipv6_idem.response }}"
      loop: "{{ all_query_responses | default([]) }}"

##############################################
##             CLEANUP                      ##
##############################################

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
