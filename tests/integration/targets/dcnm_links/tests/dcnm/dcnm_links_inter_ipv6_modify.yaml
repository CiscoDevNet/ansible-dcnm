##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_links.log

- block:

##############################################
##           BASELINE DELETE                ##
##############################################

    - name: Baseline - Delete any pre-existing IPv6 inter-fabric links
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
      register: baseline_delete_result

    - name: ASSERT - Baseline delete return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ baseline_delete_result.response }}'

##############################################
##          BASIC MERGE (CREATION)          ##
##############################################

    - name: Merge - Create single link with minimal params
      cisco.dcnm.dcnm_links: &links_merge_basic
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_fabric_setup
            profile:
              ipv4_subnet: 193.168.1.1/24
              neighbor_ip: 193.168.1.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
      register: merge_basic_result

    - name: ASSERT - Basic merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_result.diff[0].merged | length) == 1'
          - '(merge_basic_result.diff[0].modified | length) == 0'
          - '(merge_basic_result.diff[0].deleted | length) == 0'
          - '(merge_basic_result.diff[0].query | length) == 0'
        failed_when: merge_basic_result.diff is not defined

    - name: ASSERT - Basic merge return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_basic_result.response }}'

##############################################
##       BASIC MERGE - IDEMPOTENCE          ##
##############################################

    - name: Merge - Idempotence (basic link)
      cisco.dcnm.dcnm_links: *links_merge_basic
      register: merge_basic_idem

    - name: ASSERT - Basic merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_idem.diff[0].merged | length) == 0'
          - '(merge_basic_idem.diff[0].modified | length) == 0'
          - '(merge_basic_idem.diff[0].deleted | length) == 0'
          - '(merge_basic_idem.diff[0].query | length) == 0'
        failed_when: merge_basic_idem.diff is not defined

    - name: ASSERT - Basic merge idempotence return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_basic_idem.response }}'

##############################################
##       MODIFY EXISTING (OPTIONAL)         ##
##############################################

    - name: Modify - Enrich existing link with optional params
      cisco.dcnm.dcnm_links: &links_modify_basic
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_fabric_setup
            profile:
              ipv4_subnet: 193.168.10.1/24
              neighbor_ip: 193.168.10.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 1216
              auto_deploy: true
              peer1_description: "Description of source - MOD"
              peer2_description: "Description of dest - MOD"
              peer1_cmds:
                - cdp enable
              peer2_cmds:
                - cdp enable
      register: modify_basic_result

    - name: ASSERT - Basic modify diff counters
      ansible.builtin.assert:
        that:
          - '(modify_basic_result.diff[0].merged | length) == 0'
          - '(modify_basic_result.diff[0].modified | length) == 1'
          - '(modify_basic_result.diff[0].deleted | length) == 0'
          - '(modify_basic_result.diff[0].query | length) == 0'
        failed_when: modify_basic_result.diff is not defined

    - name: ASSERT - Basic modify return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ modify_basic_result.response }}'

##############################################
##        MODIFY BASIC - IDEMPOTENCE        ##
##############################################

    - name: Modify - Idempotence (basic optional link)
      cisco.dcnm.dcnm_links: *links_modify_basic
      register: modify_basic_idem

    - name: ASSERT - Basic modify idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(modify_basic_idem.diff[0].merged | length) == 0'
          - '(modify_basic_idem.diff[0].modified | length) == 0'
          - '(modify_basic_idem.diff[0].deleted | length) == 0'
          - '(modify_basic_idem.diff[0].query | length) == 0'
        failed_when: modify_basic_idem.diff is not defined

    - name: ASSERT - Basic modify idempotence return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ modify_basic_idem.response }}'

##############################################
##     MULTISITE MERGE (CREATION MINIMAL)   ##
##############################################

    - name: Merge - Create multisite underlay + overlay links (minimal)
      cisco.dcnm.dcnm_links: &links_merge_ms
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_multisite_underlay_setup
            profile:
              ipv4_subnet: 193.168.2.1/24
              neighbor_ip: 193.168.2.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_evpn_multisite_overlay_setup
            profile:
              ipv4_addr: 193.168.3.1
              neighbor_ip: 193.168.3.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
      register: merge_ms_result
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge diff counters (minimal)
      ansible.builtin.assert:
        that:
          - '(merge_ms_result.diff[0].merged | length) == 2'
          - '(merge_ms_result.diff[0].modified | length) == 0'
          - '(merge_ms_result.diff[0].deleted | length) == 0'
          - '(merge_ms_result.diff[0].query | length) == 0'
        failed_when: merge_ms_result.diff is not defined
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge return codes (minimal)
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_ms_result.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

##############################################
##  MULTISITE MERGE (MINIMAL) - IDEMPOTENCE ##
##############################################

    - name: Merge - Multisite idempotence (minimal)
      cisco.dcnm.dcnm_links: *links_merge_ms
      register: merge_ms_idem
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge idempotence diff counters (minimal)
      ansible.builtin.assert:
        that:
          - '(merge_ms_idem.diff[0].merged | length) == 0'
          - '(merge_ms_idem.diff[0].modified | length) == 0'
          - '(merge_ms_idem.diff[0].deleted | length) == 0'
          - '(merge_ms_idem.diff[0].query | length) == 0'
        failed_when: merge_ms_idem.diff is not defined
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite merge idempotence return codes (minimal)
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ merge_ms_idem.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

##############################################
##  MULTISITE MODIFY (OPTIONAL ENRICHMENT)  ##
##############################################

    - name: Modify - Enrich multisite links with optional params
      cisco.dcnm.dcnm_links: &links_modify_ms
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_multisite_underlay_setup
            profile:
              ipv4_subnet: 193.168.20.1/24
              neighbor_ip: 193.168.20.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              mtu: 2216
              deploy_dci_tracking: true
              max_paths: 2
              route_tag: 11111
              ebgp_password_enable: false
              inherit_from_msd: false
              ebgp_auth_key_type: 7
              peer1_description: "Description of source - MOD"
              peer2_description: "Description of dest - MOD"
          - dst_fabric: "{{ ansible_unnum_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_unnum_switch1 }}"
            template: ext_evpn_multisite_overlay_setup
            profile:
              ipv4_addr: 193.168.30.1
              neighbor_ip: 193.168.30.2
              src_asn: "{{ ansible_ipv6_asn }}"
              dst_asn: "{{ ansible_unnum_asn }}"
              trm_enabled: true
              bgp_multihop: 3
              ebgp_password_enable: false
              inherit_from_msd: true
              ebgp_auth_key_type: 7
      register: modify_ms_result
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite modify diff counters
      ansible.builtin.assert:
        that:
          - '(modify_ms_result.diff[0].merged | length) == 0'
          - '(modify_ms_result.diff[0].modified | length) >= 2'
          - '(modify_ms_result.diff[0].deleted | length) == 0'
          - '(modify_ms_result.diff[0].query | length) == 0'
        failed_when: modify_ms_result.diff is not defined
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite modify return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ modify_ms_result.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

##############################################
## MULTISITE MODIFY (OPTIONAL) - IDEMPOTENCE##
##############################################

    - name: Modify - Multisite optional idempotence
      cisco.dcnm.dcnm_links: *links_modify_ms
      register: modify_ms_idem
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite modify idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(modify_ms_idem.diff[0].merged | length) == 0'
          - '(modify_ms_idem.diff[0].modified | length) == 0'
          - '(modify_ms_idem.diff[0].deleted | length) == 0'
          - '(modify_ms_idem.diff[0].query | length) == 0'
        failed_when: modify_ms_idem.diff is not defined
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

    - name: ASSERT - Multisite modify idempotence return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ modify_ms_idem.response }}'
      when: (ansible_ipv6_fabric in ms_fabric_list or ansible_unnum_fabric in ms_fabric_list)

##############################################
##                CLEANUP                  ##
##############################################

  always:
    - name: Cleanup - Delete all created links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - 'item["RETURN_CODE"] == 200'
      loop: '{{ cleanup_result.response }}'
      when: it_context is not defined
