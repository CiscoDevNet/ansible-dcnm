##############################################
##               SETUP                      ##
##############################################

- name: LINKS INTRA NUMBERED MERGE - Test Entry Point
  ansible.builtin.debug:
    msg:
      - "--------------------------------------------------------------"
      - "+     Executing dcnm_links intra numbered merge tests       +"
      - "--------------------------------------------------------------"

- name: Remove local log file
  ansible.builtin.command: rm -f dcnm_links.log
  delegate_to: localhost

- block:

##############################################
##               DELETE                     ##
##############################################

    - name: Initial setup - Delete Links
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
      register: delete_result

    - name: ASSERT - Initial delete return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ delete_result.response | default([]) }}"

##############################################
##                MERGE                     ##
##############################################

    - name: Create Links without optional parameters
      cisco.dcnm.dcnm_links: &links_merge_basic
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: true
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              admin_state: true
      register: merge_basic_result

    - name: ASSERT - Basic merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_result.diff[0].merged | length) == 2'
          - '(merge_basic_result.diff[0].modified | length) == 0'
          - '(merge_basic_result.diff[0].deleted | length) == 0'
          - '(merge_basic_result.diff[0].query | length) == 0'
      failed_when: merge_basic_result.diff is not defined

    - name: ASSERT - Basic merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_basic_result.response }}"

    - name: Create Links - Idempotence (basic)
      cisco.dcnm.dcnm_links: *links_merge_basic
      register: merge_basic_idem

    - name: ASSERT - Basic merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_idem.diff[0].merged | length) == 0'
          - '(merge_basic_idem.diff[0].modified | length) == 0'
          - '(merge_basic_idem.diff[0].deleted | length) == 0'
          - '(merge_basic_idem.diff[0].query | length) == 0'
      failed_when: merge_basic_idem.diff is not defined

    - name: ASSERT - Basic merge idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_basic_idem.response }}"


    ##############################################
    ##        MERGE WITH OPTIONAL PARAMS        ##
    ##############################################

    - name: Create Links including optional parameters
      cisco.dcnm.dcnm_links: &links_merge_opt
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: true
              mtu: 9216
              peer1_description: "Description of source"
              peer2_description: "Description of dest"
              peer1_cmds:
                - "no shutdown"
              peer2_cmds:
                - "no shutdown"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              admin_state: true
              mtu: 9216
      register: merge_opt_result

    - name: ASSERT - Optional merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_opt_result.diff[0].merged | length) == 2'
          - '(merge_opt_result.diff[0].modified | length) == 0'
          - '(merge_opt_result.diff[0].deleted | length) == 0'
          - '(merge_opt_result.diff[0].query | length) == 0'
      failed_when: merge_opt_result.diff is not defined

    - name: ASSERT - Optional merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_opt_result.response }}"

    - name: Create Links - Idempotence (opt)
      cisco.dcnm.dcnm_links: *links_merge_opt
      register: merge_opt_idem

    - name: ASSERT - Optional merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_opt_idem.diff[0].merged | length) == 0'
          - '(merge_opt_idem.diff[0].modified | length) == 0'
          - '(merge_opt_idem.diff[0].deleted | length) == 0'
          - '(merge_opt_idem.diff[0].query | length) == 0'
      failed_when: merge_opt_idem.diff is not defined

    - name: ASSERT - Optional merge idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_opt_idem.response }}"

##############################################
##               DELETE                     ##
##############################################

    - name: Delete Links (pre deploy=false test)
      cisco.dcnm.dcnm_links: *links_delete
      register: pre_deploy_del_result

    - name: ASSERT - Pre deploy=false delete return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ pre_deploy_del_result.response | default([]) }}"

##############################################
##                MERGE                     ##
##############################################

    ##############################################
    ##      MERGE WITH OPTIONAL + MACSEC TEST    ##
    ##############################################

    - name: Delete Links (before optional merge)
      cisco.dcnm.dcnm_links: *links_delete
      register: opt_del_result

    - name: ASSERT - Delete before optional merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ opt_del_result.response | default([]) }}"

    - name: Create Links including all optional parameters
      cisco.dcnm.dcnm_links: &links_merge_opt_full
        state: merged
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: true
              mtu: 9216
              peer1_description: "Description of source"
              peer2_description: "Description of dest"
              peer1_bfd_echo_disable: false
              peer2_bfd_echo_disable: false
              enable_macsec: false
              peer1_cmds:
                - "no shutdown"
              peer2_cmds:
                - "no shutdown"
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              admin_state: true
              mtu: 9216
      register: merge_opt_full_result

    - name: ASSERT - Optional full merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_opt_full_result.diff[0].merged | length) == 2'
          - '(merge_opt_full_result.diff[0].modified | length) == 0'
          - '(merge_opt_full_result.diff[0].deleted | length) == 0'
          - '(merge_opt_full_result.diff[0].query | length) == 0'
      failed_when: merge_opt_full_result.diff is not defined

    - name: ASSERT - Optional full merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_opt_full_result.response }}"

    - name: Create Links - Idempotence (opt full)
      cisco.dcnm.dcnm_links: *links_merge_opt_full
      register: merge_opt_full_idem

    - name: ASSERT - Optional full merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_opt_full_idem.diff[0].merged | length) == 0'
          - '(merge_opt_full_idem.diff[0].modified | length) == 0'
          - '(merge_opt_full_idem.diff[0].deleted | length) == 0'
          - '(merge_opt_full_idem.diff[0].query | length) == 0'
      failed_when: merge_opt_full_idem.diff is not defined

    - name: ASSERT - Optional full merge idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_opt_full_idem.response }}"

##############################################
##               DELETE                     ##
##############################################

    - name: Delete Links (before deploy=false test)
      cisco.dcnm.dcnm_links: *links_delete
      register: deploy_false_del_result

    - name: ASSERT - Delete before deploy=false return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ deploy_false_del_result.response | default([]) }}"

##############################################
##                MERGE                     ##
##############################################

    - name: Create Links - deploy false basic
      cisco.dcnm.dcnm_links: &links_merge_deploy_false
        state: merged
        deploy: false
        src_fabric: "{{ ansible_num_fabric }}"
        config:
          - dst_fabric: "{{ ansible_num_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_num_switch1 }}"
            dst_device: "{{ ansible_num_switch2 }}"
            profile:
              peer1_ipv4_addr: 192.168.1.1
              peer2_ipv4_addr: 192.168.1.2
              admin_state: true
      register: merge_deploy_false_result

    - name: ASSERT - Deploy false merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_deploy_false_result.diff[0].merged | length) == 1'
          - '(merge_deploy_false_result.diff[0].modified | length) == 0'
          - '(merge_deploy_false_result.diff[0].deleted | length) == 0'
          - '(merge_deploy_false_result.diff[0].query | length) == 0'
          - '(merge_deploy_false_result.diff[0].deploy | length) == 0'
      failed_when: merge_deploy_false_result.diff is not defined

    - name: ASSERT - Deploy false merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_deploy_false_result.response }}"

    - name: Create Links - Idempotence (deploy false)
      cisco.dcnm.dcnm_links: *links_merge_deploy_false
      register: merge_deploy_false_idem

    - name: ASSERT - Deploy false idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_deploy_false_idem.diff[0].merged | length) == 0'
          - '(merge_deploy_false_idem.diff[0].modified | length) == 0'
          - '(merge_deploy_false_idem.diff[0].deleted | length) == 0'
          - '(merge_deploy_false_idem.diff[0].query | length) == 0'
          - '(merge_deploy_false_idem.diff[0].deploy | length) == 0'
      failed_when: merge_deploy_false_idem.diff is not defined

    - name: ASSERT - Deploy false idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_deploy_false_idem.response }}"

###############################################
###             CLEANUP                      ##
###############################################

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
