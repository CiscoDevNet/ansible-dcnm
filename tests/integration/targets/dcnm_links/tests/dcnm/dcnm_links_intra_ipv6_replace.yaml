##############################################
##               SETUP                      ##
##############################################

- name: Remove local log file
  local_action: command rm -f dcnm_links.log

- block:
  ##############################################
  ##           BASELINE DELETE                ##
  ##############################################

    - name: Initial setup - Delete Links (IPv6 intra fabric)
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_5 }}"
            dst_interface: "{{ intf_1_5 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
      register: delete_result

    - name: ASSERT - Baseline delete RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ delete_result.response | default([]) }}"
      failed_when: delete_result.diff is not defined and (delete_result.response | length) > 0

  ##############################################
  ##                MERGE (CREATE)            ##
  ##############################################

    - name: Create Links with optional parameters
      cisco.dcnm.dcnm_links: &links_merge_with_opt
        state: merged
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_ipv6_link_local
            profile:
              peer1_ipv4_addr: 192.169.1.1
              peer2_ipv4_addr: 192.169.1.2
              peer1_ipv6_addr: "2080:0201::01"
              peer2_ipv6_addr: "2080:0201::02"
              admin_state: true
              mtu: 9216
              peer1_description: "Description of source"
              peer2_description: "Description of dest"
              peer1_bfd_echo_disable: false
              peer2_bfd_echo_disable: false
              enable_macsec: false
              peer1_cmds:
                - "false shutdown"
              peer2_cmds:
                - "false shutdown"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_pre_provision_intra_fabric_link
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 192.169.2.1
              peer2_ipv4_addr: 192.169.2.2
              peer1_ipv6_addr: "2080:0202::01"
              peer2_ipv6_addr: "2080:0202::02"
              admin_state: true
              mtu: 1500
              peer1_description: "Description of source"
              peer2_description: "Description of dest"
              peer1_bfd_echo_disable: false
              peer2_bfd_echo_disable: false
              enable_macsec: false
              peer1_cmds:
                - "false shutdown"
              peer2_cmds:
                - "false shutdown"
      register: create_result

    - name: ASSERT - Merge diff counts
      ansible.builtin.assert:
        that:
          - "(create_result.diff[0].merged | length) == 3"
          - "(create_result.diff[0].modified | length) == 0"
          - "(create_result.diff[0].deleted | length) == 0"
          - "(create_result.diff[0].query | length) == 0"
      failed_when: create_result.diff is not defined

    - name: ASSERT - Merge RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ create_result.response }}"

  ##############################################
  ##          REPLACE (MODIFY EXISTING)       ##
  ##############################################

    - name: Replace Links (modify selected attributes)
      cisco.dcnm.dcnm_links: &links_replace
        state: replaced
        src_fabric: "{{ ansible_ipv6_fabric }}"
        config:
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_1 }}"
            dst_interface: "{{ intf_1_1 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_ipv6_link_local
            profile:
              peer1_ipv4_addr: 193.169.1.1
              peer2_ipv4_addr: 193.169.1.2
              peer1_ipv6_addr: "2089:0201::01"
              peer2_ipv6_addr: "2089:0201::02"
              admin_state: true
              mtu: 3216
              enable_macsec: false
              peer1_cmds:
                - "cdp enable"
              peer2_cmds:
                - "cdp enable"
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_2 }}"
            dst_interface: "{{ intf_1_2 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_pre_provision_intra_fabric_link
          - dst_fabric: "{{ ansible_ipv6_fabric }}"
            src_interface: "{{ intf_1_3 }}"
            dst_interface: "{{ intf_1_3 }}"
            src_device: "{{ ansible_ipv6_switch1 }}"
            dst_device: "{{ ansible_ipv6_switch2 }}"
            template: int_intra_fabric_num_link
            profile:
              peer1_ipv4_addr: 193.169.2.1
              peer2_ipv4_addr: 193.169.2.2
              peer1_ipv6_addr: "2089:0202::01"
              peer2_ipv6_addr: "2089:0202::02"
              admin_state: true
              mtu: 2000
              peer1_description: "Description of source"
              peer2_description: "Description of dest"
              peer1_bfd_echo_disable: false
              peer2_bfd_echo_disable: false
              enable_macsec: false
      register: replace_result

    - name: ASSERT - Replace diff counts
      ansible.builtin.assert:
        that:
          - "(replace_result.diff[0].merged | length) == 0"
          - "(replace_result.diff[0].modified | length) == 2"
          - "(replace_result.diff[0].deleted | length) == 0"
          - "(replace_result.diff[0].query | length) == 0"
      failed_when: replace_result.diff is not defined

    - name: ASSERT - Replace RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ replace_result.response }}"

  ##############################################
  ##          IDEMPOTENCE (REPLACE)           ##
  ##############################################

    - name: Replace Links - Idempotence
      cisco.dcnm.dcnm_links: *links_replace
      register: replace_idem

    - name: ASSERT - Replace idempotence diff
      ansible.builtin.assert:
        that:
          - "(replace_idem.diff[0].merged | length) == 0"
          - "(replace_idem.diff[0].modified | length) == 0"
          - "(replace_idem.diff[0].deleted | length) == 0"
          - "(replace_idem.diff[0].query | length) == 0"
      failed_when: replace_idem.diff is not defined

    - name: ASSERT - Replace idempotence RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ replace_idem.response }}"

  ##############################################
  ##                CLEANUP                   ##
  ##############################################

  always:
    - name: Cleanup - Delete Links
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup RETURN_CODE
      ansible.builtin.assert:
        that: "item['RETURN_CODE'] == 200"
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
