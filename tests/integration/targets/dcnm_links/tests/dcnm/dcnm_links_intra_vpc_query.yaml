##############################################
##      INTRA VPC LINK QUERY TESTS         ##
##############################################

- name: LINKS INTRA VPC QUERY - Test Entry Point
  ansible.builtin.debug:
    msg:
      - "--------------------------------------------------------------"
      - "+   Executing dcnm_links intra vpc query tests               +"
      - "--------------------------------------------------------------"

- name: Remove local log file
  ansible.builtin.command: rm -f dcnm_links.log
  delegate_to: localhost

- block:
    ##############################################
    ##          BASELINE DELETE (CLEAN)        ##
    ##############################################

    - name: Initial setup - Delete Links
      cisco.dcnm.dcnm_links: &links_delete
        state: deleted
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_vpc_switch1 }}"
            dst_device: "{{ ansible_vpc_switch2 }}"
      register: baseline_delete_result

    - name: ASSERT - Baseline delete return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ baseline_delete_result.response | default([]) }}"

    ##############################################
    ##              BASIC MERGE (CREATE)      ##
    ##############################################

    - name: Create vPC keep-alive Link (for queries)
      cisco.dcnm.dcnm_links: &links_merge_basic
        state: merged
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
            src_interface: "{{ intf_1_4 }}"
            dst_interface: "{{ intf_1_4 }}"
            src_device: "{{ ansible_vpc_switch1 }}"
            dst_device: "{{ ansible_vpc_switch2 }}"
            template: int_intra_vpc_peer_keep_alive_link
            profile:
              admin_state: true
              mtu: 9216
              peer1_ipv4_addr: 192.168.4.1
              peer2_ipv4_addr: 192.168.4.2
      register: merge_basic_result

    - name: ASSERT - Basic merge diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_result.diff[0].merged | length) == 1'
          - '(merge_basic_result.diff[0].modified | length) == 0'
          - '(merge_basic_result.diff[0].deleted | length) == 0'
          - '(merge_basic_result.diff[0].query | length) == 0'
      failed_when: merge_basic_result.diff is not defined

    - name: ASSERT - Basic merge return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_basic_result.response }}"

    - name: Basic merge - Idempotence
      cisco.dcnm.dcnm_links: *links_merge_basic
      register: merge_basic_idem

    - name: ASSERT - Basic merge idempotence diff counters
      ansible.builtin.assert:
        that:
          - '(merge_basic_idem.diff[0].merged | length) == 0'
          - '(merge_basic_idem.diff[0].modified | length) == 0'
          - '(merge_basic_idem.diff[0].deleted | length) == 0'
          - '(merge_basic_idem.diff[0].query | length) == 0'
      failed_when: merge_basic_idem.diff is not defined

    - name: ASSERT - Basic merge idempotence return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ merge_basic_idem.response }}"

    ##############################################
    ##                  QUERY                 ##
    ##############################################

    - name: Query Links - Src Fabric
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
      register: query_src_fabric

    - name: ASSERT - Query Src Fabric
      ansible.builtin.assert:
        that:
          - query_src_fabric.changed == false
          - '(query_src_fabric.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_src_fabric.response }}"

    - name: Query Links - Src & Dst Fabric
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
      register: query_src_dst_fabric

    - name: ASSERT - Query Src & Dst Fabric
      ansible.builtin.assert:
        that:
          - query_src_dst_fabric.changed == false
          - '(query_src_dst_fabric.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_src_dst_fabric.response }}"

    - name: Query Links - Src & Dst Fabric, Src Intf
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
        src_interface: "{{ intf_1_4 }}"
      register: query_src_intf

    - name: ASSERT - Query Src Intf
      ansible.builtin.assert:
        that:
          - query_src_intf.changed == false
          - '(query_src_intf.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_src_intf.response }}"

    - name: Query Links - Src & Dst Fabric, Src & Dst Intf
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
        src_interface: "{{ intf_1_4 }}"
        dst_interface: "{{ intf_1_4 }}"
      register: query_src_dst_intf

    - name: ASSERT - Query Src & Dst Intf
      ansible.builtin.assert:
        that:
          - query_src_dst_intf.changed == false
          - '(query_src_dst_intf.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_src_dst_intf.response }}"

    - name: Query Links - Src & Dst Intf, Src Device
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
        src_interface: "{{ intf_1_4 }}"
        dst_interface: "{{ intf_1_4 }}"
        src_device: "{{ ansible_vpc_switch1 }}"
      register: query_src_device

    - name: ASSERT - Query Src Device
      ansible.builtin.assert:
        that:
          - query_src_device.changed == false
          - '(query_src_device.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_src_device.response }}"

    - name: Query Links - Src & Dst Intf, Src & Dst Device
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
        src_interface: "{{ intf_1_4 }}"
        dst_interface: "{{ intf_1_4 }}"
        src_device: "{{ ansible_vpc_switch1 }}"
        dst_device: "{{ ansible_vpc_switch2 }}"
      register: query_src_dst_device

    - name: ASSERT - Query Src & Dst Device
      ansible.builtin.assert:
        that:
          - query_src_dst_device.changed == false
          - '(query_src_dst_device.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_src_dst_device.response }}"

    - name: Query Links - Src & Dst Intf, Src & Dst Device, Template
      cisco.dcnm.dcnm_links:
        state: query
        src_fabric: "{{ ansible_vpc_fabric }}"
        config:
          - dst_fabric: "{{ ansible_vpc_fabric }}"
        src_interface: "{{ intf_1_4 }}"
        dst_interface: "{{ intf_1_4 }}"
        src_device: "{{ ansible_vpc_switch1 }}"
        dst_device: "{{ ansible_vpc_switch2 }}"
        template: int_intra_vpc_peer_keep_alive_link
      register: query_template

    - name: ASSERT - Query Template
      ansible.builtin.assert:
        that:
          - query_template.changed == false
          - '(query_template.response | length) >= 1'
          - item.RETURN_CODE == 200
      loop: "{{ query_template.response }}"

  always:
    - name: Cleanup - Ensure Link Deleted
      cisco.dcnm.dcnm_links: *links_delete
      register: cleanup_result
      when: it_context is not defined

    - name: ASSERT - Cleanup return codes
      ansible.builtin.assert:
        that:
          - item.RETURN_CODE == 200
      loop: "{{ cleanup_result.response | default([]) }}"
      when: it_context is not defined
