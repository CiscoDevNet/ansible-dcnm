##############################################
##                 SETUP                    ##
##############################################

- name: MERGED - Verify if fabric is deployed.
  cisco.dcnm.dcnm_rest:
    method: GET
    path: /rest/control/fabrics/{{ ansible_it_fabric }}
  register: result

- assert:
    that:
    - 'result.response.DATA != None'

- name: MERGED - Verify if service fabric is deployed.
  cisco.dcnm.dcnm_rest:
    method: GET
    path: /rest/control/fabrics/{{ ansible_ext_fabric }}
  register: result

- assert:
    that:
    - 'result.response.DATA != None'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - sleep for 40 seconds for DCNM to completely update the state
  wait_for:
    timeout: 40

###############################################
###                MERGED                    ##
###############################################

- name: MERGED - Create Service Node with form factor virtual
  cisco.dcnm.dcnm_service_node: &conf
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: firewall
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "Ethernet1/1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Virtual"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "Firewall"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf - Idempotence
  cisco.dcnm.dcnm_service_node: *conf
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - sleep for 10 seconds for DCNM to completely update the state
  wait_for:
    timeout: 10

- name: MERGED - Create Service Node with form factor physical
  cisco.dcnm.dcnm_service_node: &conf1
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: firewall
      form_factor: physical
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "Ethernet1/1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Physical"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "Firewall"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf1 - Idempotence
  cisco.dcnm.dcnm_service_node: *conf1
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - sleep for 10 seconds for DCNM to completely update the state
  wait_for:
    timeout: 10

- name: MERGED - Create Service Node with type load balancer
  cisco.dcnm.dcnm_service_node: &conf2
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: load_balancer
      form_factor: physical
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "Ethernet1/1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Physical"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "ADC"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf2 - Idempotence
  cisco.dcnm.dcnm_service_node: *conf2
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - sleep for 10 seconds for DCNM to completely update the state
  wait_for:
    timeout: 10

- name: MERGED - Create Service Node with type virtual network function
  cisco.dcnm.dcnm_service_node: &conf3
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: virtual_network_function
      form_factor: physical
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "Ethernet1/1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Physical"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "VNF"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf3 - Idempotence
  cisco.dcnm.dcnm_service_node: *conf3
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - sleep for 10 seconds for DCNM to completely update the state
  wait_for:
    timeout: 10

- name: MERGED - Create Service Node with check mode set to true
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    check_mode: true
    config:
    - name: SN-11
      type: firewall
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result

- assert:
    that:
    - 'result.changed == false'
    - '(result["response"] | length) == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - sleep for 10 seconds for DCNM to completely update the state
  wait_for:
    timeout: 10

- name: MERGED - Create Service Node with 2 switches and vPC Interface with type firewall
  cisco.dcnm.dcnm_service_node: &conf4
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: firewall
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPC1
      switches:
      - "{{ ansible_switch4 }}"
      - "{{ ansible_switch5 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "vPC1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Virtual"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "Firewall"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf - Idempotence
  cisco.dcnm.dcnm_service_node: *conf4
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - Create Service Node with 2 switches and vPC Interface with type load balancer
  cisco.dcnm.dcnm_service_node: &conf5
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: load_balancer
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPC1
      switches:
      - "{{ ansible_switch4 }}"
      - "{{ ansible_switch5 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "vPC1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Virtual"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "ADC"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf5 - Idempotence
  cisco.dcnm.dcnm_service_node: *conf5
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - Create Service Node with 2 switches and vPC Interface with type virtual network function
  cisco.dcnm.dcnm_service_node: &conf6
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: virtual_network_function
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPC1
      switches:
      - "{{ ansible_switch4 }}"
      - "{{ ansible_switch5 }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.response[0].RETURN_CODE == 200'
    - 'result.response[0].DATA.attachedFabricName == "{{ ansible_it_fabric }}"'
    - 'result.response[0].DATA.attachedSwitchInterfaceName == "vPC1"'
    - 'result.response[0].DATA.fabricName == "{{ ansible_ext_fabric }}"'
    - 'result.response[0].DATA.formFactor == "Virtual"'
    - 'result.response[0].DATA.interfaceName == "svc1"'
    - 'result.response[0].DATA.linkTemplateName == "service_link_trunk"'
    - 'result.response[0].DATA.type == "VNF"'
    - 'result.response[0].DATA.name == "SN-11"'

- name: MERGED - conf - Idempotence
  cisco.dcnm.dcnm_service_node: *conf6
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.response|length == 0'

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted

- name: MERGED - Create Service Node with 2 switches and invalid vpc interface
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: virtual_network_function
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPC12
      switches:
      - "{{ ansible_switch4 }}"
      - "{{ ansible_switch5 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'

- name: MERGED - Create Service Node with 2 switches and invalid vpc name
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: virtual_network_function
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPortchannel12
      switches:
      - "{{ ansible_switch4 }}"
      - "{{ ansible_switch5 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'
    - '"if two switches are provided, vpc is only interface option" in result.msg'

- name: MERGED - Create Service Node with 1 switch and valid vpc name
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: virtual_network_function
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPC1
      switches:
      - "{{ ansible_switch4 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'
    - '"For 1 switch, vpc is not the interface option" in result.msg'

- name: MERGED - Create Service Node with more than 2 switch and valid vpc name
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: virtual_network_function
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: vPC1
      switches:
      - "{{ ansible_switch1 }}"
      - "{{ ansible_switch2 }}"
      - "{{ ansible_switch4 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'
    - '"Upto 2 switches only allowed" in result.msg'

- name: MERGED - Create Service Node without required parameter
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type:
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'
    - '"Required parameter not found" in result.msg'

- name: MERGED - Create Service Node with wrong type
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: karth
      form_factor: virtual
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'
    - '"Invalid choice provided" in result.msg'

- name: MERGED - Create Service Node with wrong formfactor
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: merged
    config:
    - name: SN-11
      type: firewall
      form_factor: not
      svc_int_name: svc1
      attach_interface: Ethernet1/1
      switches:
      - "{{ ansible_switch1 }}"
  register: result
  ignore_errors: yes

- assert:
    that:
    - 'result.changed == false'
    - '"Invalid choice provided" in result.msg'

###############################################
###                 CLEAN-UP                 ##
###############################################

- name: MERGED - Clean up any existing service node
  cisco.dcnm.dcnm_service_node:
    fabric: "{{ ansible_it_fabric }}"
    service_fabric: "{{ ansible_ext_fabric }}"
    state: deleted
